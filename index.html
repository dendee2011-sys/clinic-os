<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic OS - ระบบบริหารคลินิก</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. SETUP ---
        const { useState, useEffect } = React;
        const { 
            Activity, Users, ClipboardList, Menu, X, UserPlus, ClipboardCheck, 
            Stethoscope, ShoppingBag, History, RefreshCw, Loader2, ArrowRight, 
            Edit, Trash2, User, Printer, Calculator, Clock3, PlusCircle, Tag,
            PieChart, CheckCircle, UserCheck, Search, Bell, Database, Phone
        } = lucideReact;

        // --- 2. FIREBASE CONFIG ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ใส่ Config ของคุณที่นี่ (ใช้ค่าเดิมจากที่คุณให้มา)
        const firebaseConfig = {
            apiKey: "AIzaSyBnu9ZPf8ttxZl0gnbco7hk5WK7-ol3ckM",
            authDomain: "clinic-os-app.firebaseapp.com",
            projectId: "clinic-os-app",
            storageBucket: "clinic-os-app.firebasestorage.app",
            messagingSenderId: "292981574948",
            appId: "1:292981574948:web:800208558304ddc6d737b1",
            measurementId: "G-Z8S0QFZ8JG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 3. STATIC DATA ---
        const INITIAL_DIAGNOSIS_DB = [
            { code: "A09", name: "Gastroenteritis - ลำไส้อักเสบติดเชื้อ/ท้องร่วง" },
            { code: "J00", name: "Common cold - โรคหวัด" },
            { code: "E11", name: "Type 2 diabetes - เบาหวานชนิดที่ 2" },
            { code: "I10", name: "Hypertension - ความดันโลหิตสูง" },
            { code: "R50", name: "Fever - ไข้" },
            { code: "R51", name: "Headache - ปวดศีรษะ" },
            { code: "M54.5", name: "Low back pain - ปวดหลังส่วนล่าง" },
        ];

        const INITIAL_MEDICINE_DB = [
            { code: "PARA500", name: "Paracetamol 500mg", unit: "เม็ด", stdDose: 1, stdFreq: 4, timing: "เวลาปวด/มีไข้" },
            { code: "AMOX500", name: "Amoxicillin 500mg", unit: "แคปซูล", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร" },
            { code: "CPM", name: "Chlorpheniramine 4mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร" },
            { code: "OMEP20", name: "Omeprazole 20mg", unit: "แคปซูล", stdDose: 1, stdFreq: 2, timing: "ก่อนอาหาร" },
            { code: "METFOR500", name: "Metformin 500mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "หลังอาหารทันที" },
            { code: "AMLO5", name: "Amlodipine 5mg", unit: "เม็ด", stdDose: 1, stdFreq: 1, timing: "หลังอาหารเช้า" },
            { code: "PARA_SYR", name: "Paracetamol Syrup", unit: "ขวด", stdDose: 1, stdFreq: 4, timing: "เวลาปวด/มีไข้", calc: { type: 'syrup', mgPerKg: 10, mgPerUnit: 24, doseUnit: 'ml' } },
            { code: "AMOX_SYR", name: "Amoxicillin Dry Syrup", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "ก่อนอาหาร", calc: { type: 'syrup', mgPerKg: 20, mgPerUnit: 25, doseUnit: 'ml' } },
        ];

        const DEMO_PATIENTS = [
            { 
                name: "นายสมชาย ใจดี", age: 45, gender: "ชาย", status: "waiting", queue: "A001", time: "08:30", idCard: "1100700123456", phone: "081-234-5678",
                screeningData: { symptom: "มีไข้สูง ปวดศีรษะ", bp: "130/85", temp: "38.5", pulse: "90", weight: "70", height: "175" }
            },
            { 
                name: "นางสาวมาลี รักสงบ", age: 32, gender: "หญิง", status: "screening", queue: "A002", time: "08:45", idCard: "3100500987654", phone: "089-876-5432",
                screeningData: {} 
            }
        ];

        // --- 4. APP COMPONENT ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [patients, setPatients] = useState([]); 
            const [masterDB, setMasterDB] = useState([]); 
            const [medicineList, setMedicineList] = useState(INITIAL_MEDICINE_DB);
            const [diagnosisList, setDiagnosisList] = useState(INITIAL_DIAGNOSIS_DB);
            const [newPatient, setNewPatient] = useState({ idCard: '', name: '', dob: '', age: '', gender: 'ชาย', phone: '', address: '', underlyingDisease: '', allergies: '' });
            const [isOldPatient, setIsOldPatient] = useState(false);
            const [selectedScreening, setSelectedScreening] = useState(null);
            const [screeningForm, setScreeningForm] = useState({ symptom: '', bp: '', temp: '', pulse: '', weight: '', height: '' });
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [examData, setExamData] = useState({ diagnosis: '', prescription: '', note: '' });
            const [doctorVitals, setDoctorVitals] = useState({ symptom: '', bp: '', temp: '', weight: '', pulse: '' });
            const [selectedPharmacy, setSelectedPharmacy] = useState(null);
            const [pharmacyRx, setPharmacyRx] = useState('');
            const [editingPatient, setEditingPatient] = useState(null);
            const [diagSearch, setDiagSearch] = useState('');
            const [showDiagList, setShowDiagList] = useState(false);
            const [showDiagModal, setShowDiagModal] = useState(false);
            const [customDiag, setCustomDiag] = useState({ code: '', name: '' });
            const [rxSearch, setRxSearch] = useState('');
            const [showRxList, setShowRxList] = useState(false);
            const [showMedModal, setShowMedModal] = useState(false);
            const [currentMed, setCurrentMed] = useState(null);
            const [medCalc, setMedCalc] = useState({ dose: 1, freq: 3, days: 3, total: 9, note: '', isCalculated: false, doseUnit: '' });
            const [showLabelModal, setShowLabelModal] = useState(false);
            const [labelsToPrint, setLabelsToPrint] = useState([]);

            useEffect(() => {
                signInAnonymously(auth).catch(err => console.error("Login Error:", err));
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (!u) setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const queueRef = collection(db, 'clinic_data', user.uid, 'daily_queue');
                const unsubQueue = onSnapshot(queueRef, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => a.queue.localeCompare(b.queue));
                    setPatients(data);
                    setLoading(false);
                });
                const profileRef = collection(db, 'clinic_data', user.uid, 'patient_profiles');
                const unsubProfiles = onSnapshot(profileRef, (snapshot) => {
                    const data = snapshot.docs.map(doc => doc.data());
                    setMasterDB(data);
                });
                return () => { unsubQueue(); unsubProfiles(); };
            }, [user]);

            const handleLoadDemoData = async () => {
                if (!user) return;
                setLoading(true);
                try {
                    for (const p of DEMO_PATIENTS) {
                        const exists = patients.find(ex => ex.idCard === p.idCard && ex.status === p.status);
                        if(!exists) await addDoc(collection(db, 'clinic_data', user.uid, 'daily_queue'), p);
                    }
                    alert('โหลดข้อมูลตัวอย่างเรียบร้อย');
                } catch (e) { alert('Error: ' + e.message); } finally { setLoading(false); }
            };

            const calculateAge = (dob) => { if(!dob) return ''; const t=new Date(),b=new Date(dob); let a=t.getFullYear()-b.getFullYear(); if(t.getMonth()<b.getMonth()||(t.getMonth()===b.getMonth()&&t.getDate()<b.getDate())) a--; return a; };
            const handleDobChange = (e) => setNewPatient({ ...newPatient, dob: e.target.value, age: calculateAge(e.target.value) });

            useEffect(() => {
                if (newPatient.idCard.length === 13) {
                    const found = masterDB.find(p => p.idCard === newPatient.idCard);
                    if (found) { setNewPatient({ ...found }); setIsOldPatient(true); }
                    else { setIsOldPatient(false); }
                }
            }, [newPatient.idCard, masterDB]);

            const handleSaveProfile = async () => {
                if(!user) return;
                try {
                    const docRef = doc(db, 'clinic_data', user.uid, 'patient_profiles', newPatient.idCard);
                    await setDoc(docRef, newPatient, { merge: true });
                } catch (e) { console.error(e); }
            };

            const handleSendToQueue = async (e) => {
                e.preventDefault();
                if(!user || !newPatient.name) return;
                const nextQueue = `A${String(patients.length + 1).padStart(3, '0')}`;
                const now = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                try {
                    await handleSaveProfile();
                    await addDoc(collection(db, 'clinic_data', user.uid, 'daily_queue'), {
                        ...newPatient, status: 'screening', queue: nextQueue, time: now, screeningData: {}
                    });
                    setNewPatient({idCard:'', name:'', dob:'', age:'', gender:'ชาย', phone: '', address:'', underlyingDisease: '', allergies: ''});
                    setIsOldPatient(false);
                    alert(`ส่งคิว ${nextQueue} เรียบร้อย`);
                    setActiveTab('screening');
                } catch (e) { alert('Error: ' + e.message); }
            };

            const handleUpdateStatus = async (p, status, extraData = {}) => {
                if(!user) return;
                try {
                    const docRef = doc(db, 'clinic_data', user.uid, 'daily_queue', p.id);
                    await updateDoc(docRef, { status, ...extraData });
                    if(status === 'waiting') setSelectedScreening(null);
                    if(status === 'pharmacy') { setSelectedPatient(null); setActiveTab('doctor'); alert('ส่งห้องยาเรียบร้อย'); }
                    if(status === 'completed') { setSelectedPharmacy(null); alert('จ่ายยาเรียบร้อย'); }
                } catch(e) { alert('Error: ' + e.message); }
            };

            const handleDelete = async (e, id) => {
                e.stopPropagation();
                if(!user || !confirm('ยืนยันลบ?')) return;
                await deleteDoc(doc(db, 'clinic_data', user.uid, 'daily_queue', id));
            };

            // Helpers
            const SidebarItem = ({ icon, label, active, onClick, count }) => (
                <button onClick={onClick} className={`w-full flex items-center justify-between p-3 rounded-lg ${active ? 'bg-blue-50 text-blue-700 font-bold' : 'text-slate-600 hover:bg-slate-100'}`}>
                    <div className="flex items-center gap-3">{icon}<span>{label}</span></div>
                    {count > 0 && <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{count}</span>}
                </button>
            );

            if (loading) return <div className="flex h-screen items-center justify-center gap-2"><Loader2 className="animate-spin text-blue-600"/> กำลังโหลด...</div>;

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar */}
                    <aside className={`fixed lg:static inset-y-0 left-0 z-30 w-64 bg-white shadow-xl transform transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                        <div className="p-6 border-b flex justify-between"><h1 className="text-xl font-bold flex gap-2 items-center"><Activity className="text-blue-600"/> Clinic OS</h1><button onClick={() => setSidebarOpen(false)} className="lg:hidden"><X/></button></div>
                        <nav className="p-4 space-y-2">
                            <SidebarItem icon={<ClipboardList size={20}/>} label="แดชบอร์ด" active={activeTab==='dashboard'} onClick={()=>{setActiveTab('dashboard');setSidebarOpen(false)}} />
                            <div className="pt-2 px-3 text-xs text-slate-400 font-bold">ทะเบียน</div>
                            <SidebarItem icon={<UserPlus size={20}/>} label="ลงทะเบียน" active={activeTab==='register'} onClick={()=>{setActiveTab('register');setSidebarOpen(false)}} />
                            <SidebarItem icon={<ClipboardCheck size={20}/>} label="คัดกรอง" count={patients.filter(p=>p.status==='screening').length} active={activeTab==='screening'} onClick={()=>{setActiveTab('screening');setSidebarOpen(false)}} />
                            <div className="pt-2 px-3 text-xs text-slate-400 font-bold">รักษา</div>
                            <SidebarItem icon={<Stethoscope size={20}/>} label="ห้องตรวจ" count={patients.filter(p=>p.status==='waiting').length} active={activeTab==='doctor'} onClick={()=>{setActiveTab('doctor');setSidebarOpen(false)}} />
                            <SidebarItem icon={<ShoppingBag size={20}/>} label="ห้องยา" count={patients.filter(p=>p.status==='pharmacy').length} active={activeTab==='pharmacy'} onClick={()=>{setActiveTab('pharmacy');setSidebarOpen(false)}} />
                        </nav>
                    </aside>

                    {/* Content */}
                    <main className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-4 shrink-0">
                            <button onClick={()=>setSidebarOpen(true)} className="lg:hidden"><Menu/></button>
                            <div className="text-right text-sm"><div className="font-bold">คลินิกเวชกรรมรักษ์ดี</div><div>{new Date().toLocaleDateString('th-TH')}</div></div>
                        </header>
                        
                        <div className="flex-1 overflow-auto p-4 md:p-6">
                            {activeTab === 'dashboard' && (
                                <div className="space-y-4">
                                    <div className="flex justify-end"><button onClick={handleLoadDemoData} className="px-4 py-2 bg-slate-200 rounded text-sm hover:bg-slate-300 flex gap-2"><RefreshCw size={16}/> โหลดข้อมูลตัวอย่าง</button></div>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className="p-4 bg-orange-50 border border-orange-200 rounded-lg"><div>รอคัดกรอง</div><div className="text-3xl font-bold">{patients.filter(p=>p.status==='screening').length}</div></div>
                                        <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg"><div>รอตรวจ</div><div className="text-3xl font-bold">{patients.filter(p=>p.status==='waiting').length}</div></div>
                                        <div className="p-4 bg-purple-50 border border-purple-200 rounded-lg"><div>รอรับยา</div><div className="text-3xl font-bold">{patients.filter(p=>p.status==='pharmacy').length}</div></div>
                                        <div className="p-4 bg-green-50 border border-green-200 rounded-lg"><div>เสร็จสิ้น</div><div className="text-3xl font-bold">{patients.filter(p=>p.status==='completed').length}</div></div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'register' && (
                                <div className="max-w-2xl mx-auto bg-white p-6 rounded-lg border shadow-sm space-y-4">
                                    <h2 className="text-xl font-bold flex gap-2"><UserPlus/> ลงทะเบียน</h2>
                                    {isOldPatient && <div className="bg-green-100 text-green-800 p-2 rounded text-sm">พบประวัติเก่า</div>}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <input className="border p-2 rounded" placeholder="เลขบัตรประชาชน" value={newPatient.idCard} onChange={e=>setNewPatient({...newPatient, idCard:e.target.value})}/>
                                        <input className="border p-2 rounded" placeholder="ชื่อ-นามสกุล" value={newPatient.name} onChange={e=>setNewPatient({...newPatient, name:e.target.value})}/>
                                    </div>
                                    <div className="grid grid-cols-3 gap-4">
                                        <input type="date" className="border p-2 rounded" value={newPatient.dob} onChange={handleDobChange}/>
                                        <input className="border p-2 rounded bg-slate-50" placeholder="อายุ" readOnly value={newPatient.age}/>
                                        <select className="border p-2 rounded" value={newPatient.gender} onChange={e=>setNewPatient({...newPatient, gender:e.target.value})}><option>ชาย</option><option>หญิง</option></select>
                                    </div>
                                    <input className="border p-2 rounded w-full" placeholder="เบอร์โทรศัพท์" value={newPatient.phone} onChange={e=>setNewPatient({...newPatient, phone:e.target.value})}/>
                                    <div className="grid grid-cols-2 gap-4">
                                        <textarea className="border p-2 rounded" placeholder="โรคประจำตัว" value={newPatient.underlyingDisease} onChange={e=>setNewPatient({...newPatient, underlyingDisease:e.target.value})}></textarea>
                                        <textarea className="border p-2 rounded border-red-200 bg-red-50" placeholder="แพ้ยา" value={newPatient.allergies} onChange={e=>setNewPatient({...newPatient, allergies:e.target.value})}></textarea>
                                    </div>
                                    <button onClick={handleSendToQueue} className="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700">บันทึกและส่งบัตรคิว</button>
                                </div>
                            )}

                            {activeTab === 'screening' && (
                                <div className="flex flex-col md:flex-row gap-4 h-full">
                                    <div className="w-full md:w-1/3 border rounded bg-white overflow-hidden flex flex-col">
                                        <div className="p-3 bg-orange-100 font-bold">คิวรอคัดกรอง</div>
                                        <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                            {patients.filter(p=>p.status==='screening').map(p=>(
                                                <div key={p.id} onClick={()=>setSelectedScreening(p)} className="p-3 border rounded hover:bg-orange-50 cursor-pointer flex justify-between items-center group">
                                                    <div><span className="bg-slate-200 px-2 rounded text-xs mr-2">{p.queue}</span>{p.name}</div>
                                                    <button onClick={(e)=>handleDelete(e, p.id)} className="text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Trash2 size={16}/></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex-1 border rounded bg-white p-4">
                                        {selectedScreening ? (
                                            <div className="space-y-4">
                                                <h3 className="font-bold text-lg border-b pb-2">คัดกรอง: {selectedScreening.name}</h3>
                                                <textarea className="w-full border p-2 rounded" placeholder="อาการเบื้องต้น (CC)" value={screeningForm.symptom} onChange={e=>setScreeningForm({...screeningForm, symptom:e.target.value})}></textarea>
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                    <input className="border p-2 rounded" placeholder="BP" value={screeningForm.bp} onChange={e=>setScreeningForm({...screeningForm, bp:e.target.value})}/>
                                                    <input className="border p-2 rounded" placeholder="Temp" value={screeningForm.temp} onChange={e=>setScreeningForm({...screeningForm, temp:e.target.value})}/>
                                                    <input className="border p-2 rounded" placeholder="Pulse" value={screeningForm.pulse} onChange={e=>setScreeningForm({...screeningForm, pulse:e.target.value})}/>
                                                    <input className="border p-2 rounded" placeholder="Weight" value={screeningForm.weight} onChange={e=>setScreeningForm({...screeningForm, weight:e.target.value})}/>
                                                </div>
                                                <button onClick={()=>handleUpdateStatus(selectedScreening, 'waiting', {screeningData: screeningForm})} className="w-full bg-orange-500 text-white p-3 rounded font-bold">ส่งเข้าห้องตรวจ</button>
                                            </div>
                                        ) : <div className="text-center text-slate-400 mt-10">เลือกผู้ป่วยจากรายการซ้ายมือ</div>}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'doctor' && (
                                <div className="flex flex-col md:flex-row gap-4 h-full">
                                    <div className="w-full md:w-1/3 border rounded bg-white overflow-hidden flex flex-col">
                                        <div className="p-3 bg-blue-100 font-bold">คิวรอตรวจ</div>
                                        <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                            {patients.filter(p=>p.status==='waiting').map(p=>(
                                                <div key={p.id} onClick={()=>{setSelectedPatient(p); setDoctorVitals({...p.screeningData}); setExamData({diagnosis:'', prescription:'', note:''})}} className="p-3 border rounded hover:bg-blue-50 cursor-pointer">
                                                    <div><span className="bg-slate-200 px-2 rounded text-xs mr-2">{p.queue}</span>{p.name}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex-1 border rounded bg-white p-4 overflow-y-auto">
                                        {selectedPatient ? (
                                            <div className="space-y-4">
                                                <div className="flex justify-between items-center border-b pb-2">
                                                    <div><h3 className="font-bold text-lg">{selectedPatient.name}</h3><span className="text-sm text-slate-500">อายุ {selectedPatient.age} ปี</span></div>
                                                    <div className="text-right text-xs"><div>แพ้: {selectedPatient.allergies||'-'}</div><div>โรค: {selectedPatient.underlyingDisease||'-'}</div></div>
                                                </div>
                                                <div className="bg-slate-50 p-2 rounded text-sm grid grid-cols-2 md:grid-cols-4 gap-2">
                                                    <div><b>BP:</b> {doctorVitals.bp}</div><div><b>T:</b> {doctorVitals.temp}</div><div><b>P:</b> {doctorVitals.pulse}</div><div><b>BW:</b> {doctorVitals.weight}</div>
                                                </div>
                                                <div><label className="font-bold text-sm">อาการ (CC)</label><div className="p-2 bg-slate-50 rounded">{doctorVitals.symptom}</div></div>
                                                <div><label className="font-bold text-sm">วินิจฉัย (Dx)</label><textarea className="w-full border p-2 rounded" rows="2" value={examData.diagnosis} onChange={e=>setExamData({...examData, diagnosis:e.target.value})}></textarea></div>
                                                <div><label className="font-bold text-sm">สั่งยา (Rx)</label><textarea className="w-full border p-2 rounded" rows="4" value={examData.prescription} onChange={e=>setExamData({...examData, prescription:e.target.value})}></textarea></div>
                                                <button onClick={()=>handleUpdateStatus(selectedPatient, 'pharmacy', {diagnosis: examData.diagnosis, treatment: examData.prescription})} className="w-full bg-blue-600 text-white p-3 rounded font-bold">บันทึกและส่งห้องยา</button>
                                            </div>
                                        ) : <div className="text-center text-slate-400 mt-10">เลือกผู้ป่วยจากรายการซ้ายมือ</div>}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'pharmacy' && (
                                <div className="flex flex-col md:flex-row gap-4 h-full">
                                    <div className="w-full md:w-1/3 border rounded bg-white overflow-hidden flex flex-col">
                                        <div className="p-3 bg-purple-100 font-bold">คิวรอจ่ายยา</div>
                                        <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                            {patients.filter(p=>p.status==='pharmacy').map(p=>(
                                                <div key={p.id} onClick={()=>{setSelectedPharmacy(p); setPharmacyRx(p.treatment)}} className="p-3 border rounded hover:bg-purple-50 cursor-pointer">
                                                    <div><span className="bg-slate-200 px-2 rounded text-xs mr-2">{p.queue}</span>{p.name}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex-1 border rounded bg-white p-4">
                                        {selectedPharmacy ? (
                                            <div className="space-y-4">
                                                <h3 className="font-bold text-lg border-b pb-2">จ่ายยา: {selectedPharmacy.name}</h3>
                                                <div className="bg-slate-50 p-3 rounded"><b>Dx:</b> {selectedPharmacy.diagnosis}</div>
                                                <div>
                                                    <label className="font-bold text-sm">รายการยา</label>
                                                    <textarea className="w-full border p-2 rounded h-40" value={pharmacyRx} onChange={e=>setPharmacyRx(e.target.value)}></textarea>
                                                </div>
                                                <button onClick={()=>handleUpdateStatus(selectedPharmacy, 'completed', {treatment: pharmacyRx})} className="w-full bg-purple-600 text-white p-3 rounded font-bold">ยืนยันการจ่ายยา</button>
                                            </div>
                                        ) : <div className="text-center text-slate-400 mt-10">เลือกผู้ป่วยจากรายการซ้ายมือ</div>}
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
