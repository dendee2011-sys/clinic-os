<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic OS - ศูนย์อพยพอาคารวีสมหมาย</title>
    
    <!-- 1. เครื่องมือพื้นฐาน (โหลดผ่านเน็ต) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 2. Firebase (ฐานข้อมูล) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .card { @apply bg-white rounded-xl shadow-sm border border-slate-200 p-4; }
    </style>
</head>
<body>
    <div id="root">
        <div style="height:100vh;display:flex;justify-content:center;align-items:center;color:#64748b;">
            กำลังโหลดระบบ...
        </div>
    </div>

    <script type="text/babel">
        // --- 1. ตั้งค่า Firebase (ของคุณ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBnu9ZPf8ttxZl0gnbco7hk5WK7-ol3ckM",
            authDomain: "clinic-os-app.firebaseapp.com",
            projectId: "clinic-os-app",
            storageBucket: "clinic-os-app.firebasestorage.app",
            messagingSenderId: "292981574948",
            appId: "1:292981574948:web:800208558304ddc6d737b1",
            measurementId: "G-Z8S0QFZ8JG"
        };

        // เริ่มต้นระบบ
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'clinic-os-prod-v5'; // เปลี่ยนเวอร์ชันเพื่อความชัวร์

        const { useState, useEffect } = React;

        // --- 2. ไอคอน (สร้างเอง ไม่พึ่ง Library) ---
        const Icon = ({ d, size=20, color="currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                {d}
            </svg>
        );
        
        // รวมรูปไอคอน
        const Icons = {
            Home: <Icon d={<><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></>} />,
            UserPlus: <Icon d={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></>} />,
            Clipboard: <Icon d={<><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></>} />,
            Stethoscope: <Icon d={<><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></>} />,
            Pill: <Icon d={<><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></>} />,
            Activity: <Icon d={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>} />,
            Ambulance: <Icon d={<><rect x="1" y="3" width="22" height="13"/><path d="M16 8h4"/><path d="M18 6v4"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></>} />,
            Menu: <Icon d={<><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></>} />
        };

        // --- 3. ข้อมูลตั้งต้น ---
        const MED_DB = [
            { name: "Paracetamol 500mg", unit: "เม็ด", desc: "1 เม็ด เวลาปวด" },
            { name: "Amoxicillin 500mg", unit: "แคปซูล", desc: "1 เม็ด 3 เวลา หลังอาหาร" },
            { name: "CPM 4mg", unit: "เม็ด", desc: "1 เม็ด 3 เวลา หลังอาหาร" },
            { name: "Para Syrup (เด็ก)", unit: "ขวด", desc: "1 ช้อนชา เวลาปวด/มีไข้", isSyrup: true },
            { name: "ORS ผงเกลือแร่", unit: "ซอง", desc: "จิบทีละน้อย" }
        ];

        // --- 4. ตัวโปรแกรม ---
        function App() {
            const [view, setView] = useState('dashboard');
            const [patients, setPatients] = useState([]);
            const [loading, setLoading] = useState(true);
            const [sidebarOpen, setSidebarOpen] = useState(false);

            // Form States
            const [newPatient, setNewPatient] = useState({ idCard: '', name: '', age: '', gender: 'ชาย', phone: '' });
            const [screening, setScreening] = useState({ bp: '', temp: '', weight: '', symptom: '' });
            const [doctorNote, setDoctorNote] = useState({ diag: '', rx: '' });
            const [selectedId, setSelectedId] = useState(null);

            // เริ่มต้นระบบ
            useEffect(() => {
                auth.signInAnonymously().catch(e => console.error("Auth Error", e));
                
                const unsub = db.collection('artifacts').doc(appId).collection('queue')
                    .onSnapshot(snap => {
                        const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        data.sort((a,b) => a.queue.localeCompare(b.queue));
                        setPatients(data);
                        setLoading(false);
                    }, err => {
                        console.error(err);
                        // ถ้าต่อเน็ตไม่ได้ ให้ใช้ข้อมูลจำลอง
                        setPatients([
                            { id: '1', queue: 'A001', name: 'นายสมชาย (Offline)', status: 'waiting', screening: { symptom: 'ไข้หวัด' } }
                        ]);
                        setLoading(false);
                    });
                return () => unsub();
            }, []);

            // ฟังก์ชันต่างๆ
            const getPatient = () => patients.find(p => p.id === selectedId);
            const count = (s) => patients.filter(p => p.status === s).length;

            const addPatient = async () => {
                if(!newPatient.name) return alert("กรุณากรอกชื่อ");
                const nextQ = `A${String(patients.length + 1).padStart(3, '0')}`;
                await db.collection('artifacts').doc(appId).collection('queue').add({
                    ...newPatient,
                    queue: nextQ,
                    status: 'screening',
                    time: new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}),
                    screening: {}
                });
                setNewPatient({ idCard: '', name: '', age: '', gender: 'ชาย', phone: '' });
                alert("ลงทะเบียนแล้ว คิวที่ " + nextQ);
                setView('screening');
            };

            const updateStatus = async (pid, status, extra = {}) => {
                await db.collection('artifacts').doc(appId).collection('queue').doc(pid).update({
                    status, ...extra
                });
                setSelectedId(null);
            };

            const deletePatient = async (pid) => {
                if(confirm("ลบรายการนี้?")) {
                    await db.collection('artifacts').doc(appId).collection('queue').doc(pid).delete();
                    if(selectedId === pid) setSelectedId(null);
                }
            };

            if(loading) return <div className="flex h-screen items-center justify-center text-blue-600">กำลังเชื่อมต่อ...</div>;

            // ส่วนแสดงผล (UI)
            return (
                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar */}
                    <div className={`fixed inset-y-0 z-50 w-64 bg-white shadow-lg transform transition ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`}>
                        <div className="p-6 border-b font-bold text-xl text-blue-600">Clinic OS</div>
                        <div className="p-4 space-y-1">
                            {[
                                {id:'dashboard', icon:Icons.Home, label:'ภาพรวม'},
                                {id:'register', icon:Icons.UserPlus, label:'ลงทะเบียน'},
                                {id:'screening', icon:Icons.Clipboard, label:`คัดกรอง (${count('screening')})`},
                                {id:'doctor', icon:Icons.Stethoscope, label:`ห้องตรวจ (${count('waiting')})`},
                                {id:'pharmacy', icon:Icons.Pill, label:`ห้องยา (${count('pharmacy')})`},
                                {id:'referral', icon:Icons.Ambulance, label:`ส่งต่อ (${count('referral')})`},
                                {id:'history', icon:Icons.History, label:'ประวัติ'}
                            ].map(m => (
                                <button key={m.id} onClick={()=>{setView(m.id); setSidebarOpen(false);}} 
                                    className={`w-full flex items-center gap-3 p-3 rounded ${view===m.id ? 'bg-blue-600 text-white' : 'text-slate-600 hover:bg-slate-100'}`}>
                                    {m.icon} {m.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Main */}
                    <div className="flex-1 flex flex-col h-screen lg:ml-64">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-4">
                            <button onClick={()=>setSidebarOpen(true)} className="lg:hidden p-2">{Icons.Menu}</button>
                            <div className="font-bold text-slate-700">ศูนย์อพยพอาคารวีสมหมาย</div>
                        </header>

                        <div className="flex-1 overflow-auto p-4 bg-slate-50">
                            
                            {/* Dashboard */}
                            {view === 'dashboard' && <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="card border-l-4 border-orange-500"><div>รอคัดกรอง</div><div className="text-3xl font-bold">{count('screening')}</div></div>
                                <div className="card border-l-4 border-blue-500"><div>รอตรวจ</div><div className="text-3xl font-bold">{count('waiting')}</div></div>
                                <div className="card border-l-4 border-purple-500"><div>รอรับยา</div><div className="text-3xl font-bold">{count('pharmacy')}</div></div>
                                <div className="card border-l-4 border-green-500"><div>เสร็จสิ้น</div><div className="text-3xl font-bold">{count('completed')}</div></div>
                            </div>}

                            {/* Register */}
                            {view === 'register' && <div className="max-w-lg mx-auto card space-y-4">
                                <h2 className="text-lg font-bold text-blue-600">ลงทะเบียนผู้ป่วยใหม่</h2>
                                <input className="w-full p-2 border rounded" placeholder="เลขบัตรประชาชน" value={newPatient.idCard} onChange={e=>setNewPatient({...newPatient, idCard:e.target.value})} />
                                <input className="w-full p-2 border rounded" placeholder="ชื่อ-สกุล" value={newPatient.name} onChange={e=>setNewPatient({...newPatient, name:e.target.value})} />
                                <div className="grid grid-cols-2 gap-2">
                                    <input className="w-full p-2 border rounded" placeholder="อายุ" value={newPatient.age} onChange={e=>setNewPatient({...newPatient, age:e.target.value})} />
                                    <select className="w-full p-2 border rounded" value={newPatient.gender} onChange={e=>setNewPatient({...newPatient, gender:e.target.value})}><option>ชาย</option><option>หญิง</option></select>
                                </div>
                                <input className="w-full p-2 border rounded" placeholder="เบอร์โทร" value={newPatient.phone} onChange={e=>setNewPatient({...newPatient, phone:e.target.value})} />
                                <button onClick={addPatient} className="w-full bg-blue-600 text-white p-3 rounded font-bold">บันทึก</button>
                            </div>}

                            {/* Screening */}
                            {view === 'screening' && <div className="flex flex-col md:flex-row gap-4 h-full">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-y-auto">
                                    <div className="p-3 bg-orange-100 font-bold text-orange-800">คิวรอคัดกรอง</div>
                                    {patients.filter(p=>p.status==='screening').map(p=>(
                                        <div key={p.id} onClick={()=>{setSelectedId(p.id); setScreening(p.screening||{})}} className="p-3 border-b hover:bg-orange-50 cursor-pointer flex justify-between">
                                            <span>{p.queue} {p.name}</span>
                                            <button onClick={(e)=>{e.stopPropagation();deletePatient(p.id)}} className="text-red-500">ลบ</button>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex-1 card">
                                    {selectedId ? <div className="space-y-4">
                                        <h3 className="font-bold text-lg">{getPatient()?.name}</h3>
                                        <div className="grid grid-cols-2 gap-2">
                                            <input className="border p-2 rounded" placeholder="ความดัน (BP)" value={screening.bp} onChange={e=>setScreening({...screening, bp:e.target.value})} />
                                            <input className="border p-2 rounded" placeholder="อุณหภูมิ (T)" value={screening.temp} onChange={e=>setScreening({...screening, temp:e.target.value})} />
                                            <input className="border p-2 rounded" placeholder="ชีพจร (P)" value={screening.pulse} onChange={e=>setScreening({...screening, pulse:e.target.value})} />
                                            <input className="border p-2 rounded" placeholder="น้ำหนัก (kg)" value={screening.weight} onChange={e=>setScreening({...screening, weight:e.target.value})} />
                                        </div>
                                        <textarea className="w-full border p-2 rounded" placeholder="อาการเบื้องต้น..." value={screening.symptom} onChange={e=>setScreening({...screening, symptom:e.target.value})}></textarea>
                                        <button onClick={()=>updateStatus(selectedId, 'waiting', {screening})} className="w-full bg-orange-500 text-white p-3 rounded font-bold">ส่งห้องตรวจ</button>
                                    </div> : <div className="text-center mt-10 text-gray-400">เลือกผู้ป่วย</div>}
                                </div>
                            </div>}

                            {/* Doctor */}
                            {view === 'doctor' && <div className="flex flex-col md:flex-row gap-4 h-full">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-y-auto">
                                    <div className="p-3 bg-blue-100 font-bold text-blue-800">คิวรอตรวจ</div>
                                    {patients.filter(p=>p.status==='waiting').map(p=>(
                                        <div key={p.id} onClick={()=>{setSelectedId(p.id); setDoctorData({diagnosis:p.diagnosis||'', prescription:p.treatment||''})}} className="p-3 border-b hover:bg-blue-50 cursor-pointer">
                                            {p.queue} {p.name}
                                        </div>
                                    ))}
                                </div>
                                <div className="flex-1 card overflow-auto">
                                    {selectedId ? <div className="space-y-4">
                                        <div className="flex justify-between border-b pb-2"><h3 className="font-bold text-lg">{getPatient()?.name}</h3><span className="text-blue-600 font-bold">{getPatient()?.queue}</span></div>
                                        <div className="bg-slate-50 p-2 rounded text-sm grid grid-cols-4 gap-2">
                                            <span>BP: {getPatient()?.screening?.bp}</span><span>T: {getPatient()?.screening?.temp}</span>
                                            <span>P: {getPatient()?.screening?.pulse}</span><span>Wt: {getPatient()?.screening?.weight}</span>
                                        </div>
                                        <div><label className="font-bold">อาการ:</label> {getPatient()?.screening?.symptom}</div>
                                        <div><label className="font-bold">วินิจฉัย</label><textarea className="w-full border p-2 rounded" value={doctorData.diagnosis} onChange={e=>setDoctorData({...doctorData, diagnosis:e.target.value})}></textarea></div>
                                        <div>
                                            <div className="flex justify-between"><label className="font-bold">สั่งยา</label><span className="text-xs text-blue-600 cursor-pointer" onClick={()=>setDoctorData(p=>({...p, prescription: p.prescription + '- Paracetamol 500mg 1 เม็ด prn\n'}))}>+ พารา</span></div>
                                            <textarea className="w-full border p-2 rounded font-mono" rows="4" value={doctorData.prescription} onChange={e=>setDoctorData({...doctorData, prescription:e.target.value})}></textarea>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={()=>updateStatus(selectedId, 'pharmacy', {diagnosis:doctorData.diagnosis, treatment:doctorData.prescription})} className="flex-1 bg-green-600 text-white p-3 rounded font-bold">บันทึก & ส่งห้องยา</button>
                                            <button onClick={()=>updateStatus(selectedId, 'referral', {diagnosis:doctorData.diagnosis, treatment:doctorData.prescription})} className="px-4 bg-red-600 text-white rounded font-bold">ส่งตัว</button>
                                        </div>
                                    </div> : <div className="text-center mt-10 text-gray-400">เลือกผู้ป่วย</div>}
                                </div>
                            </div>}

                            {/* Pharmacy */}
                            {view === 'pharmacy' && <div className="flex flex-col md:flex-row gap-4 h-full">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-y-auto">
                                    <div className="p-3 bg-purple-100 font-bold text-purple-800">รอจ่ายยา</div>
                                    {patients.filter(p=>p.status==='pharmacy').map(p=>(
                                        <div key={p.id} onClick={()=>setSelectedId(p.id)} className="p-3 border-b hover:bg-purple-50 cursor-pointer">
                                            {p.queue} {p.name}
                                        </div>
                                    ))}
                                </div>
                                <div className="flex-1 card">
                                    {selectedId ? <div className="space-y-4">
                                        <h3 className="font-bold text-lg">{getPatient()?.name}</h3>
                                        <div className="bg-slate-50 p-2 rounded"><strong>Dx:</strong> {getPatient()?.diagnosis}</div>
                                        <div className="border p-2 rounded font-mono whitespace-pre-wrap">{getPatient()?.treatment}</div>
                                        <button onClick={()=>updateStatus(selectedId, 'completed')} className="w-full bg-purple-600 text-white p-3 rounded font-bold">จ่ายยาเรียบร้อย</button>
                                    </div> : <div className="text-center mt-10 text-gray-400">เลือกรายการ</div>}
                                </div>
                            </div>}

                            {/* Referral */}
                            {view === 'referral' && <div className="flex flex-col md:flex-row gap-4 h-full">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-y-auto">
                                    <div className="p-3 bg-red-100 font-bold text-red-800">รอส่งตัว</div>
                                    {patients.filter(p=>p.status==='referral').map(p=>(
                                        <div key={p.id} onClick={()=>setSelectedId(p.id)} className="p-3 border-b hover:bg-red-50 cursor-pointer">{p.name}</div>
                                    ))}
                                </div>
                                <div className="flex-1 card print:shadow-none">
                                    {selectedId ? <div className="space-y-4">
                                        <div className="text-center border-b pb-4"><h1 className="text-2xl font-bold">ใบส่งตัวผู้ป่วย</h1><p>ศูนย์อพยพอาคารวีสมหมาย</p></div>
                                        <p><strong>ชื่อ:</strong> {getPatient()?.name} <strong>อายุ:</strong> {getPatient()?.age}</p>
                                        <p><strong>การวินิจฉัย:</strong> {getPatient()?.diagnosis}</p>
                                        <p><strong>การรักษา:</strong> {getPatient()?.treatment}</p>
                                        <div className="mt-10 pt-10 border-t text-center no-print">
                                            <button onClick={()=>window.print()} className="bg-blue-600 text-white px-6 py-2 rounded mr-2">พิมพ์</button>
                                            <button onClick={()=>updateStatus(selectedId, 'completed')} className="bg-green-600 text-white px-6 py-2 rounded">จบงาน</button>
                                        </div>
                                    </div> : <div className="text-center mt-10 text-gray-400 no-print">เลือกผู้ป่วย</div>}
                                </div>
                            </div>}

                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
