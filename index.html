<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic OS - ศูนย์อพยพอาคารวีสมหมาย ศรีสะเกษ</title>
    
    <!-- 1. Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- 2. React Core (ใช้ unpkg และ crossorigin เพื่อแก้ Script Error) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Firebase (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .print-container { position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 20px; font-size: 14pt; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <!-- พื้นที่แสดงผล -->
    <div id="root">
        <div style="height: 100vh; display: flex; justify-content: center; align-items: center; color: #64748b; flex-direction: column;">
            <div style="font-size: 24px; font-weight: bold; color: #2563eb; margin-bottom: 10px;">Clinic OS</div>
            <div>กำลังโหลดระบบ...</div>
        </div>
    </div>

    <!-- Script หลัก -->
    <script type="text/babel">
        // --- 1. FIREBASE CONFIG (ของคุณ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBnu9ZPf8ttxZl0gnbco7hk5WK7-ol3ckM",
            authDomain: "clinic-os-app.firebaseapp.com",
            projectId: "clinic-os-app",
            storageBucket: "clinic-os-app.firebasestorage.app",
            messagingSenderId: "292981574948",
            appId: "1:292981574948:web:800208558304ddc6d737b1",
            measurementId: "G-Z8S0QFZ8JG"
        };

        // Initialize safely
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'clinic-os-production-v1'; // ใช้ ID นี้เพื่อให้ข้อมูลต่อเนื่อง

        const { useState, useEffect, useRef } = React;

        // --- 2. ICONS ---
        const Icon = ({ path }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{path}</svg>;
        const Icons = {
            Activity: <Icon path={<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>} />,
            Users: <Icon path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            Clipboard: <Icon path={<><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></>} />,
            User: <Icon path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            Check: <Icon path={<polyline points="20 6 9 17 4 12"/>} />,
            Menu: <Icon path={<><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>} />,
            X: <Icon path={<><path d="M18 6 6 18"/><path d="m6 6 18 18"/></>} />,
            Plus: <Icon path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></>} />,
            Steth: <Icon path={<><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></>} />,
            Bag: <Icon path={<><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></>} />,
            History: <Icon path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></>} />,
            Trash: <Icon path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Edit: <Icon path={<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>} />,
            Ambulance: <Icon path={<><path d="M10 10h4"/><path d="M12 8v4"/><rect width="18" height="12" x="3" y="6" rx="2"/><path d="M6 18h2"/><path d="M16 18h2"/></>} />,
            Printer: <Icon path={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></>} />,
            Clock: <Icon path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16.5 12"/></>} />,
            Save: <Icon path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            Calculator: <Icon path={<><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>} />,
            Tag: <Icon path={<><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l5 5a2 2 0 0 0 2.828 0l7.172-7.172a2 2 0 0 0 0-2.828l-5-5z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></>} />,
            Pill: <Icon path={<><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></>} />
        };

        // --- 3. DATA ---
        const MED_DB = [
            { code: "PARA500", name: "Paracetamol 500mg", unit: "เม็ด", stdDose: 1, stdFreq: 4, timing: "ทุก 4-6 ชม. เวลาปวด/มีไข้" },
            { code: "AMOX500", name: "Amoxicillin 500mg", unit: "แคปซูล", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร" },
            { code: "CPM", name: "Chlorpheniramine 4mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร" },
            { code: "OMEP20", name: "Omeprazole 20mg", unit: "แคปซูล", stdDose: 1, stdFreq: 2, timing: "ก่อนอาหาร" },
            { code: "METFOR500", name: "Metformin 500mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "หลังอาหารทันที" },
            { code: "AMLO5", name: "Amlodipine 5mg", unit: "เม็ด", stdDose: 1, stdFreq: 1, timing: "หลังอาหารเช้า" },
            { code: "PARA_SYR", name: "Paracetamol Syrup", unit: "ขวด", stdDose: 1, stdFreq: 4, timing: "เวลาปวด/มีไข้", calc: { type: 'syrup', mgPerKg: 10, mgPerUnit: 24, doseUnit: 'ml' } },
            { code: "AMOX_SYR", name: "Amoxicillin Dry Syrup", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "ก่อนอาหาร", calc: { type: 'syrup', mgPerKg: 20, mgPerUnit: 25, doseUnit: 'ml' } },
            { code: "CPM_SYR", name: "CPM Syrup", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร", calc: { type: 'syrup', mgPerKg: 0.35, mgPerUnit: 0.4, doseUnit: 'ml' } },
            { code: "BROM_SYR", name: "Bromhexine Syrup", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร", calc: { type: 'syrup', mgPerKg: 0.2, mgPerUnit: 0.8, doseUnit: 'ml' } },
            { code: "SIMET80", name: "Simethicone 80mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "เคี้ยวเวลาท้องอืด" },
            { code: "ORS", name: "ORS Powder", unit: "ซอง", stdDose: 1, stdFreq: 1, timing: "จิบทีละน้อย", doseUnit: 'ซอง' },
            { code: "ALUM", name: "Alum Milk", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "ก่อนอาหาร", doseUnit: 'ช้อนโต๊ะ' }
        ];

        const DIAG_DB = [
            { code: "J00", name: "Common cold" }, { code: "A09", name: "Gastroenteritis" }, 
            { code: "R50", name: "Fever" }, { code: "I10", name: "Hypertension" }, 
            { code: "E11", name: "Diabetes Type 2" }, { code: "K29", name: "Gastritis" }
        ];

        // --- 4. APP COMPONENT ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [patients, setPatients] = useState([]);
            const [masterDB, setMasterDB] = useState([]);
            const [isOffline, setIsOffline] = useState(false);

            // Forms
            const [newPatient, setNewPatient] = useState({ idCard: '', name: '', age: '', gender: 'ชาย', phone: '', address: '', underlyingDisease: '', allergies: '' });
            const [isOldPatient, setIsOldPatient] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null);
            
            // Clinic Forms
            const [screeningForm, setScreeningForm] = useState({ symptom: '', bp: '', temp: '', pulse: '', weight: '' });
            const [doctorVitals, setDoctorVitals] = useState({ symptom: '', bp: '', temp: '', weight: '', pulse: '' });
            const [examData, setExamData] = useState({ diagnosis: '', prescription: '' });
            const [pharmacyRx, setPharmacyRx] = useState('');
            const [referralForm, setReferralForm] = useState({ hospital: 'รพ.ศรีสะเกษ', reason: '', urgency: 'ปกติ' });

            // Modals
            const [showMedModal, setShowMedModal] = useState(false);
            const [currentMed, setCurrentMed] = useState(null);
            const [medCalc, setMedCalc] = useState({ dose: 1, freq: 3, days: 3, total: 9, note: '', doseUnit: '' });
            const [rxSearch, setRxSearch] = useState('');
            const [showRxList, setShowRxList] = useState(false);
            const [diagSearch, setDiagSearch] = useState('');
            const [showDiagList, setShowDiagList] = useState(false);
            const [showLabelModal, setShowLabelModal] = useState(false);
            const [labelsToPrint, setLabelsToPrint] = useState([]);
            const [editingPatient, setEditingPatient] = useState(null);

            // Auth & Sync
            useEffect(() => {
                const init = async () => {
                    try {
                        await auth.signInAnonymously();
                        setUser(auth.currentUser);
                    } catch (e) {
                        console.error("Auth:", e);
                        setIsOffline(true);
                        setLoading(false);
                    }
                };
                init();
            }, []);

            useEffect(() => {
                if(!user) return;
                const unsubQ = db.collection('artifacts').doc(appId).collection('daily_queue').onSnapshot(s => {
                    const d = s.docs.map(i=>({id:i.id, ...i.data()})).sort((a,b)=>a.queue.localeCompare(b.queue));
                    setPatients(d); setLoading(false);
                }, () => { setIsOffline(true); setLoading(false); });
                const unsubP = db.collection('artifacts').doc(appId).collection('patient_profiles').onSnapshot(s => {
                    setMasterDB(s.docs.map(i=>i.data()));
                });
                return () => { unsubQ(); unsubProfile(); };
            }, [user]);

            // Utils
            const dbOp = () => db.collection('artifacts').doc(appId);
            const calculateAge = (d) => { if(!d)return''; const t=new Date(),b=new Date(d); let a=t.getFullYear()-b.getFullYear(); if(t.getMonth()<b.getMonth()||(t.getMonth()===b.getMonth()&&t.getDate()<b.getDate()))a--; return a; };

            // Logic
            useEffect(() => {
                if(newPatient.idCard.length===13) {
                    const f = masterDB.find(p=>p.idCard===newPatient.idCard);
                    if(f) { setNewPatient({...f}); setIsOldPatient(true); } else setIsOldPatient(false);
                }
            }, [newPatient.idCard, masterDB]);

            const handleRegister = async () => {
                if(!newPatient.name) return alert('ระบุชื่อ');
                if(!isOffline) await dbOp().collection('patient_profiles').doc(newPatient.idCard).set(newPatient, {merge:true});
                const q = `A${String(patients.length+1).padStart(3,'0')}`;
                const p = { ...newPatient, status:'screening', queue:q, time: new Date().toLocaleTimeString('th-TH', {hour:'2-digit',minute:'2-digit'}), screeningData:{} };
                if(!isOffline) await dbOp().collection('daily_queue').add(p);
                else setPatients([...patients, {id: Date.now(), ...p}]);
                setNewPatient({ idCard: '', name: '', age: '', gender: 'ชาย', phone: '', address: '', underlyingDisease: '', allergies: '' });
                alert(`ลงทะเบียน ${q} สำเร็จ`); setActiveTab('screening');
            };

            const updateStatus = async (pid, st, extra={}) => {
                if(!isOffline) await dbOp().collection('daily_queue').doc(pid).update({status:st, ...extra});
                else setPatients(prev=>prev.map(p=>p.id===pid?{...p, status:st, ...extra}:p));
                setSelectedItem(null);
            };

            // Medicine Calc
            const handleMedClick = (m) => {
                setCurrentMed(m);
                let d = m.stdDose||1, f=m.stdFreq||3, dy=3, calc=false;
                const w = parseFloat(doctorVitals.weight||selectedItem?.screeningData?.weight);
                if(m.calc && w && m.calc.type==='syrup') { d=Math.round((w*m.calc.mgPerKg/m.calc.mgPerUnit)*10)/10; calc=true; }
                let tot = ['ขวด','หลอด','ซอง'].includes(m.unit) ? 1 : Math.ceil(d*f*dy);
                setMedCalc({dose:d, freq:f, days:dy, total:tot, note:m.timing||'', isCalculated:calc, doseUnit:m.calc?.doseUnit||m.unit});
                setShowMedModal(true); setRxSearch(''); setShowRxList(false);
            };
            const confirmMed = () => {
                const u = medCalc.doseUnit==='ml'?'ซีซี':medCalc.doseUnit;
                const txt = `- ${currentMed.name}\n  จ่าย: ${medCalc.total} ${currentMed.unit} | ทานครั้งละ ${medCalc.dose} ${u} วันละ ${medCalc.freq} ครั้ง ${medCalc.note}`;
                setExamData(p=>({...p, prescription: p.prescription?p.prescription+'\n'+txt:txt}));
                setShowMedModal(false);
            };

            const handlePrint = (p) => {
                const rx = pharmacyRx || p.treatment;
                if(!rx) return alert('ไม่มียา');
                const i = rx.split('\n- ').map((t,idx)=>{ const raw=idx===0&&t.startsWith('- ')?t.substring(2):t; const sp=raw.split('\n  '); return {name:sp[0], det:sp[1]||''}; }).filter(x=>x.name);
                setLabelsToPrint({p, i}); setShowLabelModal(true);
            };

            // UI Components
            const SideBtn = ({id, label, icon}) => (
                <button onClick={()=>{setActiveTab(id); setSidebarOpen(false);}} className={`w-full text-left p-3 rounded flex gap-2 mb-1 ${activeTab===id?'bg-blue-600 text-white':'hover:bg-gray-100 text-gray-600'}`}>
                    {icon} {label} {id!=='register'&&id!=='dashboard'&&id!=='history' && <span className="ml-auto bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full">{patients.filter(p=>p.status===id || (id==='doctor'&&p.status==='waiting')).length}</span>}
                </button>
            );

            if(loading) return <div className="h-screen flex items-center justify-center text-blue-600">กำลังเชื่อมต่อ...</div>;

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar */}
                    <div className={`fixed inset-y-0 left-0 w-64 bg-white shadow-xl z-50 transform transition ${sidebarOpen?'translate-x-0':'-translate-x-full'} lg:translate-x-0`}>
                        <div className="p-6 border-b text-blue-600 font-bold text-xl flex items-center gap-2">{Icons.Activity} Clinic OS</div>
                        <div className="p-4">
                            <SideBtn id="dashboard" label="ภาพรวม" icon={Icons.Clipboard}/>
                            <SideBtn id="register" label="ลงทะเบียน" icon={Icons.Plus}/>
                            <SideBtn id="screening" label="คัดกรอง" icon={Icons.User}/>
                            <SideBtn id="doctor" label="ห้องตรวจ" icon={Icons.Steth}/>
                            <SideBtn id="pharmacy" label="ห้องจ่ายยา" icon={Icons.Pill}/>
                            <SideBtn id="referral" label="ส่งต่อ" icon={Icons.Ambulance}/>
                            <SideBtn id="history" label="ประวัติ" icon={Icons.History}/>
                        </div>
                    </div>

                    {/* Main */}
                    <div className="flex-1 flex flex-col lg:ml-64">
                        <div className="h-16 bg-white border-b flex items-center justify-between px-4 shadow-sm shrink-0">
                            <button onClick={()=>setSidebarOpen(!sidebarOpen)} className="lg:hidden">{Icons.Menu}</button>
                            <div className="font-bold text-gray-700">ศูนย์อพยพอาคารวีสมหมาย</div>
                        </div>

                        <div className="flex-1 overflow-auto p-4 bg-slate-50">
                            {/* DASHBOARD */}
                            {activeTab==='dashboard' && <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {['screening','waiting','pharmacy','completed'].map(s=><div key={s} className="bg-white p-6 rounded shadow border-l-4 border-blue-500"><div className="text-gray-500 capitalize">{s}</div><div className="text-2xl font-bold">{patients.filter(p=>p.status===s).length}</div></div>)}
                            </div>}

                            {/* REGISTER */}
                            {activeTab==='register' && <div className="bg-white p-6 rounded shadow max-w-lg mx-auto space-y-4">
                                <h2 className="font-bold text-lg text-blue-600">ลงทะเบียนผู้ป่วย</h2>
                                {isOldPatient && <div className="bg-green-100 p-2 rounded text-green-800 text-sm flex gap-2">{Icons.Check} พบประวัติเก่า</div>}
                                <input className="w-full border p-2 rounded" placeholder="เลขบัตร 13 หลัก" value={newPatient.idCard} onChange={e=>setNewPatient({...newPatient, idCard:e.target.value, age: calculateAge(newPatient.dob)})}/>
                                <input className="w-full border p-2 rounded" placeholder="ชื่อ-สกุล" value={newPatient.name} onChange={e=>setNewPatient({...newPatient, name:e.target.value})}/>
                                <div className="grid grid-cols-2 gap-2"><input type="date" className="border p-2 rounded" value={newPatient.dob} onChange={e=>setNewPatient({...newPatient, dob:e.target.value})}/><input className="border p-2 rounded" placeholder="อายุ" value={newPatient.age} onChange={e=>setNewPatient({...newPatient, age:e.target.value})}/></div>
                                <input className="w-full border p-2 rounded" placeholder="เบอร์โทร" value={newPatient.phone} onChange={e=>setNewPatient({...newPatient, phone:e.target.value})}/>
                                <input className="w-full border p-2 rounded" placeholder="โรคประจำตัว" value={newPatient.underlyingDisease} onChange={e=>setNewPatient({...newPatient, underlyingDisease:e.target.value})}/>
                                <input className="w-full border p-2 rounded border-red-300" placeholder="แพ้ยา" value={newPatient.allergies} onChange={e=>setNewPatient({...newPatient, allergies:e.target.value})}/>
                                <button onClick={handleRegister} className="w-full bg-blue-600 text-white p-3 rounded font-bold">บันทึก</button>
                            </div>}

                            {/* SCREENING */}
                            {activeTab==='screening' && <div className="flex gap-4 h-full flex-col md:flex-row">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-auto h-64 md:h-auto"><div className="p-3 bg-orange-100 font-bold text-orange-800">คิวรอคัดกรอง</div>{patients.filter(p=>p.status==='screening').map(p=><div key={p.id} onClick={()=>{setSelectedItem(p); setScreeningForm({...screeningForm, ...p.screeningData})}} className="p-3 border-b hover:bg-gray-50 cursor-pointer flex justify-between"><span>{p.queue} {p.name}</span> <button onClick={e=>{e.stopPropagation();if(confirm('ลบ?'))updateStatus(p.id,'deleted')}} className="text-red-500">{Icons.Trash}</button></div>)}</div>
                                <div className="flex-1 bg-white rounded shadow p-6">{selectedItem ? <div className="space-y-4"><h3 className="font-bold">{selectedItem.name}</h3><textarea className="w-full border p-2 rounded" placeholder="อาการ..." value={screeningForm.symptom} onChange={e=>setScreeningForm({...screeningForm, symptom:e.target.value})}/><div className="grid grid-cols-4 gap-2"><input className="border p-2 rounded" placeholder="BP" value={screeningForm.bp} onChange={e=>setScreeningForm({...screeningForm, bp:e.target.value})}/><input className="border p-2 rounded" placeholder="Temp" value={screeningForm.temp} onChange={e=>setScreeningForm({...screeningForm, temp:e.target.value})}/><input className="border p-2 rounded" placeholder="Pulse" value={screeningForm.pulse} onChange={e=>setScreeningForm({...screeningForm, pulse:e.target.value})}/><input className="border p-2 rounded" placeholder="Wt" value={screeningForm.weight} onChange={e=>setScreeningForm({...screeningForm, weight:e.target.value})}/></div><button onClick={()=>updateStatus(selectedItem.id, 'waiting', {screeningData:screeningForm})} className="w-full bg-orange-500 text-white p-3 rounded font-bold">ส่งตรวจ</button></div> : <div className="text-center mt-10 text-gray-400">เลือกผู้ป่วย</div>}</div>
                            </div>}

                            {/* DOCTOR */}
                            {activeTab==='doctor' && <div className="flex gap-4 h-full flex-col md:flex-row">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-auto h-64 md:h-auto"><div className="p-3 bg-blue-100 font-bold text-blue-800">คิวรอตรวจ</div>{patients.filter(p=>p.status==='waiting').map(p=><div key={p.id} onClick={()=>{setSelectedItem(p); setDoctorVitals({...p.screeningData}); setExamData({diagnosis:p.diagnosis||'', prescription:p.treatment||''})}} className="p-3 border-b hover:bg-gray-50 cursor-pointer"><b>{p.queue}</b> {p.name}</div>)}</div>
                                <div className="flex-1 bg-white rounded shadow p-6 overflow-auto">{selectedItem ? <div className="space-y-4"><h3 className="font-bold text-xl border-b pb-2">{selectedItem.name}</h3>{selectedItem.allergies && <div className="bg-red-100 text-red-800 p-2 rounded font-bold">แพ้: {selectedItem.allergies}</div>}<div className="bg-gray-50 p-2 rounded grid grid-cols-4 gap-2 text-sm"><span>BP: {doctorVitals.bp}</span><span>T: {doctorVitals.temp}</span><span>P: {doctorVitals.pulse}</span><span>Wt: {doctorVitals.weight}</span></div><div><label className="font-bold">อาการ</label><textarea className="w-full border p-2 rounded" value={doctorVitals.symptom} onChange={e=>setDoctorVitals({...doctorVitals, symptom:e.target.value})}/></div><div><div className="flex justify-between"><label className="font-bold">วินิจฉัย</label><button onClick={()=>setShowDiagList(!showDiagList)} className="text-blue-600 text-xs">ค้นหา</button></div>{showDiagList && <div className="border p-2 max-h-32 overflow-auto bg-white mb-2"><input className="w-full border p-1 mb-1" placeholder="ค้นหา..." value={diagSearch} onChange={e=>setDiagSearch(e.target.value)}/>{DIAG_DB.filter(d=>d.name.toLowerCase().includes(diagSearch.toLowerCase())).map(d=><div key={d.code} onClick={()=>{setExamData(prev=>({...prev, diagnosis: prev.diagnosis+'\n'+d.code+' '+d.name})); setShowDiagList(false)}} className="p-1 hover:bg-gray-100 cursor-pointer">{d.name}</div>)}</div>}<textarea className="w-full border p-2 rounded" value={examData.diagnosis} onChange={e=>setExamData({...examData, diagnosis:e.target.value})}/></div><div><div className="flex justify-between"><label className="font-bold">สั่งยา</label><button onClick={()=>setShowRxList(!showRxList)} className="text-blue-600 text-xs">ค้นหา</button></div>{showRxList && <div className="border p-2 max-h-32 overflow-auto bg-white mb-2"><input className="w-full border p-1 mb-1" placeholder="ค้นหา..." value={rxSearch} onChange={e=>setRxSearch(e.target.value)}/>{MED_DB.filter(m=>m.name.toLowerCase().includes(rxSearch.toLowerCase())).map(m=><div key={m.name} onClick={()=>handleMedClick(m)} className="p-1 hover:bg-gray-100 cursor-pointer">{m.name}</div>)}</div>}<textarea className="w-full border p-2 rounded h-32" value={examData.prescription} onChange={e=>setExamData({...examData, prescription:e.target.value})}/></div><div className="flex gap-2"><button onClick={()=>updateStatus(selectedItem.id, 'pharmacy', {diagnosis: examData.diagnosis, treatment: examData.prescription, screeningData: doctorVitals})} className="flex-1 bg-green-600 text-white p-3 rounded font-bold">บันทึก & ส่งห้องยา</button><button onClick={()=>updateStatus(selectedItem.id, 'referral', {diagnosis: examData.diagnosis, treatment: examData.prescription, screeningData: doctorVitals})} className="px-6 bg-red-600 text-white rounded font-bold">ส่งตัว</button></div></div> : <div className="text-center mt-10 text-gray-400">เลือกผู้ป่วย</div>}</div>
                            </div>}

                            {/* PHARMACY */}
                            {activeTab==='pharmacy' && <div className="flex gap-4 h-full flex-col md:flex-row"><div className="w-full md:w-1/3 bg-white rounded shadow overflow-auto h-64 md:h-auto"><div className="p-3 bg-purple-100 font-bold text-purple-800">รอจ่ายยา</div>{patients.filter(p=>p.status==='pharmacy').map(p=><div key={p.id} onClick={()=>{setSelectedItem(p); setPharmacyRx(p.treatment)}} className="p-3 border-b hover:bg-gray-50 cursor-pointer"><b>{p.queue}</b> {p.name}</div>)}</div><div className="flex-1 bg-white rounded shadow p-6">{selectedItem ? <div className="space-y-4"><h3 className="font-bold text-xl">{selectedItem.name}</h3><div className="bg-gray-50 p-2 rounded"><strong>Dx:</strong> {selectedItem.diagnosis}</div><textarea className="w-full border p-2 rounded h-48" value={pharmacyRx} onChange={e=>setPharmacyRx(e.target.value)}></textarea><div className="flex gap-2"><button onClick={()=>handlePrintPreview(selectedItem)} className="flex-1 border p-3 rounded">พิมพ์ฉลาก</button><button onClick={()=>updateStatus(selectedItem.id, 'completed', {treatment: pharmacyRx})} className="flex-1 bg-purple-600 text-white p-3 rounded font-bold">จ่ายยาเรียบร้อย</button></div></div> : <div className="text-center mt-10 text-gray-400">เลือกรายการ</div>}</div></div>}

                             {/* REFERRAL & HISTORY */}
                             {(activeTab==='referral' || activeTab==='history') && <div className="bg-white rounded shadow overflow-hidden"><table className="w-full text-left"><thead className="bg-gray-100 border-b"><tr><th className="p-3">เวลา</th><th className="p-3">ชื่อ</th><th className="p-3">สถานะ</th><th className="p-3">จัดการ</th></tr></thead><tbody>{patients.filter(p=>activeTab==='referral'?p.status==='referral':p.status==='completed').map(p=><tr key={p.id} className="border-b"><td className="p-3">{p.time}</td><td className="p-3 font-bold">{p.name}</td><td className="p-3"><span className="bg-gray-100 px-2 rounded text-xs">{p.status}</span></td><td className="p-3"><button onClick={()=>{setSelectedItem(p); setPharmacyRx(p.treatment); if(activeTab==='referral') handlePrintPreview(p)}} className="text-blue-500 mr-2">{activeTab==='referral'?'พิมพ์':'ดู'}</button><button onClick={()=>handleDelete(p.id)} className="text-red-500">ลบ</button></td></tr>)}</tbody></table></div>}
                        </div>
                    </div>

                    {/* MED CALC MODAL */}
                    {showMedModal && currentMed && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"><div className="bg-white rounded-xl w-full max-w-sm overflow-hidden shadow-2xl"><div className="bg-blue-600 p-4 text-white flex justify-between"><h3>คำนวณ: {currentMed.name}</h3><button onClick={()=>setShowMedModal(false)}>✕</button></div><div className="p-4 space-y-4"><div className="grid grid-cols-3 gap-2 text-center"><div><label className="text-xs">ครั้งละ</label><input type="number" className="w-full border rounded p-1 text-center" value={medCalc.dose} onChange={e=>setMedCalc({...medCalc, dose:e.target.value})}/></div><div><label className="text-xs">วันละ</label><input type="number" className="w-full border rounded p-1 text-center" value={medCalc.freq} onChange={e=>setMedCalc({...medCalc, freq:e.target.value})}/></div><div><label className="text-xs">วัน</label><input type="number" className="w-full border rounded p-1 text-center" value={medCalc.days} onChange={e=>setMedCalc({...medCalc, days:e.target.value})}/></div></div><div className="text-center font-bold text-blue-600 border bg-blue-50 p-2 rounded">รวม: {medCalc.total} {currentMed.unit}</div><div><label className="text-xs font-bold">เวลาทาน</label><div className="flex gap-2 mt-1">{['หลังอาหาร','ก่อนอาหาร','ก่อนนอน'].map(t=><button key={t} onClick={()=>setMedCalc(p=>({...p, note:t}))} className="text-xs bg-gray-100 px-2 py-1 rounded">{t}</button>)}</div></div><textarea className="w-full border rounded p-2 text-sm" rows="2" value={medCalc.note} onChange={e=>setMedCalc({...medCalc, note:e.target.value})}></textarea><button onClick={confirmMed} className="w-full bg-blue-600 text-white p-2 rounded font-bold">เพิ่ม</button></div></div></div>}

                    {/* LABEL PREVIEW */}
                    {showLabelModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4"><div className="bg-white p-6 rounded-xl w-full max-w-2xl h-[80vh] flex flex-col"><div className="flex justify-between mb-4"><h3 className="font-bold">พิมพ์ฉลากยา</h3><button onClick={()=>setShowLabelModal(false)}>✕</button></div><div className="flex-1 overflow-auto grid grid-cols-2 gap-4">{labelsToPrint.items?.map((m,i)=><div key={i} className="border p-4 rounded text-center shadow-sm"><div className="text-sm font-bold text-slate-700">คลินิกเวชกรรมรักษ์ดี</div><div className="text-xs mb-2 text-slate-500">{labelsToPrint.patient.name}</div><div className="font-bold text-lg mb-1">{m.name}</div><div className="text-sm">{m.det}</div></div>)}</div><div className="mt-4 flex justify-end"><button onClick={()=>window.print()} className="bg-blue-600 text-white px-4 py-2 rounded flex gap-2 items-center">สั่งพิมพ์</button></div></div></div>}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>


