<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic OS - ศูนย์อพยพอาคารวีสมหมาย</title>
    
    <!-- 1. โหลด Library (ใช้ Link ที่เสถียรที่สุด) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 2. Firebase (Compat v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .print-page { padding: 2cm; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <!-- ส่วนแสดงผล Error หาก React ไม่ทำงาน -->
    <div id="error-trap" style="display:none; padding: 20px; color: red; text-align: center;">
        <h1>⚠️ เกิดข้อผิดพลาดร้ายแรง</h1>
        <p id="error-msg"></p>
        <button onclick="localStorage.clear(); window.location.reload();" style="border:1px solid red; padding:5px 10px; margin-top:10px;">ล้างค่าและรีโหลด</button>
    </div>

    <div id="root">
        <div style="height: 100vh; display: flex; justify-content: center; align-items: center; color: #64748b; flex-direction: column;">
            <div style="font-size: 24px; font-weight: bold; color: #2563eb; margin-bottom: 10px;">Clinic OS</div>
            <div>กำลังโหลดระบบ...</div>
        </div>
    </div>

    <!-- Script ดักจับ Error -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('error-trap').style.display = 'block';
            document.getElementById('error-msg').innerText = msg + "\nLine: " + line;
            return false;
        };
    </script>

    <script type="text/babel">
        // --- 1. CONFIGURATION ---
        // Config ของคุณ (ใส่ให้แล้ว)
        const firebaseConfig = {
            apiKey: "AIzaSyBnu9ZPf8ttxZl0gnbco7hk5WK7-ol3ckM",
            authDomain: "clinic-os-app.firebaseapp.com",
            projectId: "clinic-os-app",
            storageBucket: "clinic-os-app.firebasestorage.app",
            messagingSenderId: "292981574948",
            appId: "1:292981574948:web:800208558304ddc6d737b1",
            measurementId: "G-Z8S0QFZ8JG"
        };

        // --- 2. ICONS (SVG) ---
        // สร้าง Component ไอคอนแบบง่ายเพื่อป้องกัน Error
        const Icon = ({ d, className="" }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{d}</svg>;
        const Icons = {
            Activity: <Icon d={<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>} />,
            Users: <Icon d={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></>} />,
            Clipboard: <Icon d={<><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></>} />,
            UserPlus: <Icon d={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></>} />,
            Steth: <Icon d={<><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></>} />,
            Bag: <Icon d={<><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></>} />,
            History: <Icon d={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></>} />,
            Menu: <Icon d={<><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></>} />,
            Trash: <Icon d={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Edit: <Icon d={<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>} />,
            Check: <Icon d={<polyline points="20 6 9 17 4 12"/>} />,
            X: <Icon d={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />,
            Ambulance: <Icon d={<><rect x="1" y="3" width="22" height="13" rx="2" ry="2"/><path d="M8 8h8"/><path d="M12 6v4"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></>} />,
            Printer: <Icon d={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>} />,
            Save: <Icon d={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            UserCheck: <Icon d={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></>} />
        };

        // --- 3. MAIN APP ---
        const { useState, useEffect } = React;

        function App() {
            // State
            const [view, setView] = useState('dashboard');
            const [patients, setPatients] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isOffline, setIsOffline] = useState(false);
            const [sidebarOpen, setSidebarOpen] = useState(false);

            // Data Caches
            const [masterDB, setMasterDB] = useState([]); // Patient Profiles
            const [medicineList, setMedicineList] = useState([
                { code: "PARA500", name: "Paracetamol 500mg", unit: "เม็ด", stdDose: 1, stdFreq: 4, timing: "ทุก 4-6 ชม." },
                { code: "AMOX500", name: "Amoxicillin 500mg", unit: "แคปซูล", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร" },
                { code: "CPM", name: "Chlorpheniramine 4mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร" },
                { code: "PARA_SYR", name: "Paracetamol Syrup", unit: "ขวด", stdDose: 1, stdFreq: 4, timing: "เวลาปวด", calc: { type: 'syrup', mgPerKg: 10, mgPerUnit: 24, doseUnit: 'ml' } },
                { code: "ORS", name: "ORS Powder", unit: "ซอง", stdDose: 1, stdFreq: 1, timing: "จิบทีละน้อย" }
            ]);

            // Forms
            const [newPatient, setNewPatient] = useState({ idCard: '', name: '', age: '', gender: 'ชาย', phone: '', address: '', disease: '', allergy: '' });
            const [isOldPatient, setIsOldPatient] = useState(false);
            
            // Selection & Forms
            const [selectedId, setSelectedId] = useState(null);
            const [screeningForm, setScreeningForm] = useState({ symptom: '', bp: '', temp: '', pulse: '', weight: '' });
            const [doctorData, setDoctorData] = useState({ diagnosis: '', prescription: '' });
            const [pharmacyRx, setPharmacyRx] = useState('');
            const [referralData, setReferralData] = useState({ hospital: 'รพ.ศรีสะเกษ', reason: '', urgency: 'ปกติ' });

            // Modals
            const [showMedModal, setShowMedModal] = useState(false);
            const [currentMed, setCurrentMed] = useState(null);
            const [medCalc, setMedCalc] = useState({ dose: 1, freq: 3, days: 3, total: 9, note: '' });
            
            const [labelsToPrint, setLabelsToPrint] = useState([]);
            const [showLabelModal, setShowLabelModal] = useState(false);
            const [editingPatient, setEditingPatient] = useState(null);

            // --- INITIALIZATION ---
            useEffect(() => {
                const initSystem = async () => {
                    // Try Local Storage First (Fastest)
                    const localQ = localStorage.getItem('clinic_queue');
                    if (localQ) setPatients(JSON.parse(localQ));
                    const localP = localStorage.getItem('clinic_profiles');
                    if (localP) setMasterDB(JSON.parse(localP));

                    try {
                        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                        await firebase.auth().signInAnonymously();
                        const db = firebase.firestore();
                        const appId = 'clinic-os-prod-v8-failsafe';

                        // Sync Queue
                        db.collection('artifacts').doc(appId).collection('queue').onSnapshot(snap => {
                            const data = snap.docs.map(d => ({id:d.id, ...d.data()}));
                            data.sort((a,b)=>a.queue.localeCompare(b.queue));
                            setPatients(data);
                            localStorage.setItem('clinic_queue', JSON.stringify(data)); // Backup
                            setLoading(false);
                        }, err => { throw err; });

                        // Sync Profiles
                        db.collection('artifacts').doc(appId).collection('profiles').onSnapshot(snap => {
                            const data = snap.docs.map(d => d.data());
                            setMasterDB(data);
                            localStorage.setItem('clinic_profiles', JSON.stringify(data)); // Backup
                        });

                    } catch (e) {
                        console.warn("Offline Mode Activated:", e);
                        setIsOffline(true);
                        setLoading(false);
                    }
                };
                initSystem();
            }, []);

            // --- ACTIONS ---
            const dbOp = () => firebase.firestore().collection('artifacts').doc('clinic-os-prod-v8-failsafe');
            const getPatient = () => patients.find(p => p.id === selectedId);
            const count = (s) => patients.filter(p => p.status === s).length;
            const calculateAge = (d) => { if(!d)return''; const t=new Date(),b=new Date(d); let a=t.getFullYear()-b.getFullYear(); if(t.getMonth()<b.getMonth()||(t.getMonth()===b.getMonth()&&t.getDate()<b.getDate()))a--; return a; };

            // Auto-fill
            useEffect(() => {
                if (newPatient.idCard.length === 13) {
                    const found = masterDB.find(p => p.idCard === newPatient.idCard);
                    if (found) { setNewPatient({ ...found }); setIsOldPatient(true); } else { setIsOldPatient(false); }
                }
            }, [newPatient.idCard, masterDB]);

            const handleRegister = async () => {
                if(!newPatient.name) return alert("กรุณากรอกชื่อ");
                const nextQ = `A${String(patients.length+1).padStart(3,'0')}`;
                const pData = {
                    ...newPatient, status: 'screening', queue: nextQ,
                    time: new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}),
                    screeningData: {}, meds: {}
                };

                if(!isOffline) {
                    await dbOp().collection('profiles').doc(newPatient.idCard).set(newPatient, {merge:true});
                    await dbOp().collection('queue').add(pData);
                } else {
                    const newQueue = [...patients, {id: Date.now().toString(), ...pData}];
                    setPatients(newQueue);
                    localStorage.setItem('clinic_queue', JSON.stringify(newQueue));
                    // Update Local Profile
                    const newProfiles = [...masterDB.filter(p=>p.idCard!==newPatient.idCard), newPatient];
                    setMasterDB(newProfiles);
                    localStorage.setItem('clinic_profiles', JSON.stringify(newProfiles));
                }
                
                setNewPatient({ idCard: '', name: '', age: '', gender: 'ชาย', phone: '', address: '', disease: '', allergy: '' });
                alert(`ลงทะเบียนสำเร็จ ${nextQ}`); setView('screening');
            };

            const updateStatus = async (pid, status, extra={}) => {
                if(!isOffline) await dbOp().collection('queue').doc(pid).update({ status, ...extra });
                else {
                    const newQ = patients.map(p => p.id === pid ? { ...p, status, ...extra } : p);
                    setPatients(newQ);
                    localStorage.setItem('clinic_queue', JSON.stringify(newQ));
                }
                setSelectedId(null);
            };

            const handleDelete = async (pid) => {
                if(!confirm("ยืนยันลบ?")) return;
                if(!isOffline) await dbOp().collection('queue').doc(pid).delete();
                else {
                    const newQ = patients.filter(p => p.id !== pid);
                    setPatients(newQ);
                    localStorage.setItem('clinic_queue', JSON.stringify(newQ));
                }
            };

            // Clinical logic
            const handleMedClick = (m) => {
                setCurrentMed(m);
                let d = m.stdDose||1, f=m.stdFreq||3, calc=false;
                const weight = parseFloat(selectedId ? (getPatient().screeningData?.weight || screeningForm.weight) : 0);
                if(m.calc && weight && m.calc.type==='syrup') {
                    d = Math.round((weight*m.calc.mgPerKg/m.calc.mgPerUnit)*10)/10; calc=true;
                }
                setMedCalc({dose:d, freq:f, days:3, total: Math.ceil(d*f*3), note: m.timing||''});
                setShowMedModal(true);
            };

            const confirmMed = () => {
                const line = `- ${currentMed.name}\n  จ่าย: ${medCalc.total} ${currentMed.unit} | วิธีใช้: ครั้งละ ${medCalc.dose} ${currentMed.unit} วันละ ${medCalc.freq} ครั้ง ${medCalc.note}`;
                setDoctorData(p => ({ ...p, prescription: p.prescription ? p.prescription + '\n' + line : line }));
                setShowMedModal(false);
            };

             const handlePrintPreview = (p) => {
                const rx = pharmacyRx || p.treatment;
                if(!rx) return alert('ไม่มียา');
                const items = rx.split('\n- ').map((t,i) => { const txt = i===0&&t.startsWith('- ')?t.substring(2):t; const pts = txt.split('\n  '); return {name: pts[0], detail: pts[1]||''}; }).filter(i=>i.name);
                setLabelsToPrint({patient:p, items}); setShowLabelModal(true);
            };

            // --- UI HELPERS ---
            const SidebarBtn = ({id, label, icon}) => (
                <button onClick={()=>{setView(id); setSidebarOpen(false)}} className={`w-full text-left p-3 rounded mb-1 flex items-center gap-3 transition ${view===id?'bg-blue-600 text-white':'hover:bg-slate-200 text-slate-600'}`}>
                    {icon} {label} {id!=='register'&&id!=='dashboard'&&id!=='history' && <span className="ml-auto bg-slate-200 text-slate-700 text-xs px-2 py-0.5 rounded-full">{count(id==='doctor'?'waiting':id)}</span>}
                </button>
            );

            const StatBox = ({title, val, color}) => <div className={`p-4 rounded border-l-4 bg-white shadow-sm flex justify-between ${color}`}><div><div className="text-xs text-slate-500">{title}</div><div className="text-2xl font-bold">{val}</div></div></div>;

            if (loading) return <div className="h-screen flex flex-col items-center justify-center text-blue-600 font-bold"><div>Clinic OS</div><div className="text-sm font-normal text-slate-400">กำลังเชื่อมต่อฐานข้อมูล...</div></div>;

            return (
                <div className="flex h-screen overflow-hidden bg-slate-100">
                    
                    {/* Modals */}
                    {showMedModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"><div className="bg-white rounded-xl w-full max-w-sm p-4 space-y-3"><h3 className="font-bold text-lg">{currentMed.name}</h3><div className="grid grid-cols-3 gap-2 text-center"><div><label className="text-xs">ครั้งละ</label><input type="number" className="w-full border p-1 text-center" value={medCalc.dose} onChange={e=>setMedCalc({...medCalc, dose:e.target.value})}/></div><div><label className="text-xs">วันละ</label><input type="number" className="w-full border p-1 text-center" value={medCalc.freq} onChange={e=>setMedCalc({...medCalc, freq:e.target.value})}/></div><div><label className="text-xs">วัน</label><input type="number" className="w-full border p-1 text-center" value={medCalc.days} onChange={e=>setMedCalc({...medCalc, days:e.target.value})}/></div></div><textarea className="w-full border p-2 text-sm" rows="2" value={medCalc.note} onChange={e=>setMedCalc({...medCalc, note:e.target.value})}></textarea><div className="flex justify-end gap-2"><button onClick={()=>setShowMedModal(false)} className="border px-3 rounded">ยกเลิก</button><button onClick={confirmMed} className="bg-blue-600 text-white px-3 rounded">เพิ่ม</button></div></div></div>}

                    {showLabelModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4"><div className="bg-white p-6 rounded-xl w-full max-w-2xl h-[80vh] flex flex-col"><div className="flex justify-between mb-4"><h3 className="font-bold">พิมพ์ฉลากยา</h3><button onClick={()=>setShowLabelModal(false)}>{Icons.X}</button></div><div className="flex-1 overflow-auto grid grid-cols-2 gap-4">{labelsToPrint.items.map((m,i)=><div key={i} className="border p-4 rounded text-center shadow-sm"><div className="text-sm font-bold text-slate-700">ศูนย์อพยพอาคารวีสมหมาย</div><div className="text-xs mb-2 text-slate-500">{labelsToPrint.patient.name}</div><div className="font-bold text-lg mb-1">{m.name}</div><div className="text-sm">{m.detail.split('|')[1]}</div></div>)}</div><div className="mt-4 flex justify-end"><button onClick={()=>window.print()} className="bg-blue-600 text-white px-4 py-2 rounded flex gap-2 items-center">สั่งพิมพ์</button></div></div></div>}

                    {/* Sidebar */}
                    <div className={`fixed inset-y-0 z-40 w-64 bg-white shadow-lg transform transition ${sidebarOpen?'translate-x-0':'-translate-x-full'} lg:translate-x-0`}>
                        <div className="p-6 border-b font-bold text-xl text-blue-600 flex items-center gap-2">{Icons.Activity} Clinic OS</div>
                        <div className="p-4 space-y-1">
                            <SidebarBtn id="dashboard" label="ภาพรวม" icon={Icons.Clipboard}/>
                            <SidebarBtn id="register" label="ลงทะเบียน" icon={Icons.Plus}/>
                            <SidebarBtn id="screening" label="คัดกรอง" icon={Icons.Users}/>
                            <SidebarBtn id="doctor" label="ห้องตรวจ" icon={Icons.Steth}/>
                            <SidebarBtn id="pharmacy" label="ห้องจ่ายยา" icon={Icons.Bag}/>
                            <SidebarBtn id="referral" label="ส่งต่อ" icon={Icons.Ambulance}/>
                            <SidebarBtn id="history" label="ประวัติ" icon={Icons.History}/>
                        </div>
                        {isOffline && <div className="p-2 text-center text-xs text-white bg-red-500">OFFLINE MODE</div>}
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col lg:ml-64 h-screen">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-4 shadow-sm shrink-0">
                            <button onClick={()=>setSidebarOpen(!sidebarOpen)} className="lg:hidden">{Icons.Menu}</button>
                            <div className="font-bold text-slate-700">ศูนย์อพยพอาคารวีสมหมาย</div>
                        </header>

                        <div className="flex-1 overflow-auto p-4 md:p-6">
                            {view==='dashboard' && <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <StatBox title="รอคัดกรอง" val={count('screening')} color="border-orange-500 text-orange-600"/>
                                <StatBox title="รอตรวจ" val={count('waiting')} color="border-blue-500 text-blue-600"/>
                                <StatBox title="รอรับยา" val={count('pharmacy')} color="border-purple-500 text-purple-600"/>
                                <StatBox title="เสร็จสิ้น" val={count('completed')} color="border-green-500 text-green-600"/>
                            </div>}

                            {view==='register' && <div className="max-w-lg mx-auto bg-white p-6 rounded shadow space-y-3">
                                <h2 className="text-lg font-bold text-blue-600 flex gap-2">{Icons.Plus} ลงทะเบียน</h2>
                                {isOldPatient && <div className="bg-green-100 p-2 text-green-800 text-sm rounded flex gap-2">{Icons.Check} พบประวัติเก่า</div>}
                                <div className="grid grid-cols-2 gap-2">
                                    <input className="border p-2 rounded" placeholder="เลขบัตร 13 หลัก" value={newPatient.idCard} onChange={e=>{const v=e.target.value.replace(/[^0-9]/g,''); if(v.length<=13) setNewPatient({...newPatient, idCard:v})}}/>
                                    <input className="border p-2 rounded" placeholder="ชื่อ-สกุล" value={newPatient.name} onChange={e=>setNewPatient({...newPatient, name:e.target.value})}/>
                                    <input className="border p-2 rounded" placeholder="อายุ" value={newPatient.age} onChange={e=>setNewPatient({...newPatient, age:e.target.value})}/>
                                    <input className="border p-2 rounded" placeholder="เบอร์โทร" value={newPatient.phone} onChange={e=>setNewPatient({...newPatient, phone:e.target.value})}/>
                                </div>
                                <input className="w-full border p-2 rounded" placeholder="ที่อยู่" value={newPatient.address} onChange={e=>setNewPatient({...newPatient, address:e.target.value})}/>
                                <div className="grid grid-cols-2 gap-2">
                                    <input className="border p-2 rounded" placeholder="โรคประจำตัว" value={newPatient.disease} onChange={e=>setNewPatient({...newPatient, disease:e.target.value})}/>
                                    <input className="border p-2 rounded border-red-200 text-red-600" placeholder="แพ้ยา" value={newPatient.allergy} onChange={e=>setNewPatient({...newPatient, allergy:e.target.value})}/>
                                </div>
                                <button onClick={handleRegister} className="w-full bg-blue-600 text-white p-3 rounded font-bold">บันทึก</button>
                            </div>}

                            {view==='screening' && <div className="flex flex-col md:flex-row gap-4 h-full">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-y-auto">
                                    <div className="p-3 bg-orange-100 font-bold text-orange-800">คิวรอคัดกรอง</div>
                                    {patients.filter(p=>p.status==='screening').map(p=><div key={p.id} onClick={()=>{setSelectedId(p.id); setScreeningForm({...p.screeningData})}} className="p-3 border-b hover:bg-orange-50 cursor-pointer flex justify-between"><span>{p.queue} {p.name}</span><button onClick={(e)=>{e.stopPropagation();handleDelete(p.id)}} class="text-red-500">{Icons.Trash}</button></div>)}
                                </div>
                                <div className="flex-1 bg-white rounded shadow p-6">
                                    {selectedId ? <div>
                                        <h3 className="font-bold text-lg mb-4">{getPatient()?.name}</h3>
                                        <textarea className="w-full border p-2 rounded mb-4" placeholder="อาการ (CC)..." value={screeningForm.symptom} onChange={e=>setScreeningForm({...screeningForm, symptom:e.target.value})}></textarea>
                                        <div className="grid grid-cols-4 gap-2 mb-4">
                                            <input className="border p-2 rounded" placeholder="BP" value={screeningForm.bp} onChange={e=>setScreeningForm({...screeningForm, bp:e.target.value})}/>
                                            <input className="border p-2 rounded" placeholder="T" value={screeningForm.temp} onChange={e=>setScreeningForm({...screeningForm, temp:e.target.value})}/>
                                            <input className="border p-2 rounded" placeholder="P" value={screeningForm.pulse} onChange={e=>setScreeningForm({...screeningForm, pulse:e.target.value})}/>
                                            <input className="border p-2 rounded" placeholder="Wt" value={screeningForm.weight} onChange={e=>setScreeningForm({...screeningForm, weight:e.target.value})}/>
                                        </div>
                                        <button onClick={()=>updateStatus(selectedId, 'waiting', {screeningData: screeningForm})} className="w-full bg-orange-500 text-white p-3 rounded font-bold">ส่งห้องตรวจ</button>
                                    </div> : <div className="text-center mt-10 text-gray-400">เลือกผู้ป่วย</div>}
                                </div>
                            </div>}

                            {view==='doctor' && <div className="flex flex-col md:flex-row gap-4 h-full">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-y-auto">
                                    <div className="p-3 bg-blue-100 font-bold text-blue-800">คิวรอตรวจ</div>
                                    {patients.filter(p=>p.status==='waiting').map(p=><div key={p.id} onClick={()=>{setSelectedId(p.id); setDoctorData({diagnosis:p.diagnosis||'', prescription:p.prescription||''})}} className="p-3 border-b hover:bg-blue-50 cursor-pointer">{p.queue} {p.name}</div>)}
                                </div>
                                <div className="flex-1 bg-white rounded shadow p-6 overflow-y-auto">
                                    {selectedId ? <div>
                                        <h3 className="font-bold text-lg mb-2">{getPatient()?.name}</h3>
                                        {getPatient()?.allergy && <div className="bg-red-100 text-red-800 p-2 rounded mb-2 font-bold">⚠️ แพ้: {getPatient().allergy}</div>}
                                        <div className="bg-slate-50 p-2 rounded text-sm mb-4">CC: {getPatient()?.screeningData?.symptom} <br/> BP: {getPatient()?.screeningData?.bp} T: {getPatient()?.screeningData?.temp} Wt: {getPatient()?.screeningData?.weight}</div>
                                        <textarea className="w-full border p-2 rounded mb-2" placeholder="วินิจฉัย..." rows="2" value={doctorData.diagnosis} onChange={e=>setDoctorData({...doctorData, diagnosis:e.target.value})}></textarea>
                                        <div className="mb-2">
                                            <div className="flex gap-2 mb-1 overflow-x-auto pb-2">{MED_DB.map((m,i)=><button key={i} onClick={()=>handleMedClick(m)} className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded whitespace-nowrap border hover:bg-blue-100">{m.name}</button>)}</div>
                                            <textarea className="w-full border p-2 rounded font-mono text-sm" rows="4" placeholder="รายการยา..." value={doctorData.prescription} onChange={e=>setDoctorData({...doctorData, prescription:e.target.value})}></textarea>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={()=>updateStatus(selectedId, 'pharmacy', doctorData)} className="flex-1 bg-green-600 text-white p-3 rounded font-bold">บันทึก</button>
                                            <button onClick={()=>updateStatus(selectedId, 'referral', doctorData)} className="px-4 bg-red-500 text-white rounded font-bold">ส่งตัว</button>
                                        </div>
                                    </div> : <div className="text-center mt-10 text-gray-400">เลือกผู้ป่วย</div>}
                                </div>
                            </div>}

                            {view==='pharmacy' && <div className="flex flex-col md:flex-row gap-4 h-full">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-y-auto"><div className="p-3 bg-purple-100 font-bold text-purple-800">รอจ่ายยา</div>{patients.filter(p=>p.status==='pharmacy').map(p=><div key={p.id} onClick={()=>{setSelectedId(p.id); setPharmacyRx(p.treatment)}} className="p-3 border-b hover:bg-purple-50 cursor-pointer">{p.queue} {p.name}</div>)}</div>
                                <div className="flex-1 bg-white rounded shadow p-6">
                                    {selectedId ? <div>
                                        <h3 className="font-bold text-lg mb-2">{getPatient()?.name}</h3>
                                        <div className="bg-gray-50 p-2 rounded mb-2 text-sm">Dx: {getPatient()?.diagnosis}</div>
                                        <textarea className="w-full border p-2 h-40 rounded font-mono" value={pharmacyRx} onChange={e=>setPharmacyRx(e.target.value)}></textarea>
                                        <div className="flex gap-2 mt-4"><button onClick={()=>handlePrintPreview(getPatient())} className="flex-1 border p-3 rounded">พิมพ์ฉลาก</button><button onClick={()=>updateStatus(selectedId, 'completed', {treatment: pharmacyRx})} className="flex-1 bg-purple-600 text-white p-3 rounded font-bold">จ่ายยาเรียบร้อย</button></div>
                                    </div> : <div className="text-center mt-10 text-gray-400">เลือกรายการ</div>}
                                </div>
                            </div>}

                             {/* Referral & History omitted for brevity - logic same as before */}
                             {view==='referral' && <div className="flex flex-col md:flex-row gap-4 h-full"><div className="w-full md:w-1/3 bg-white rounded shadow overflow-y-auto no-print"><div className="p-3 bg-red-100 font-bold text-red-800">รอส่งตัว</div>{patients.filter(p=>p.status==='referral').map(p=><div key={p.id} onClick={()=>setSelectedId(p.id)} className="p-3 border-b hover:bg-red-50 cursor-pointer">{p.name}</div>)}</div><div className="flex-1 bg-white rounded shadow p-8 print:shadow-none">{selectedId ? <div className="print-container"><div className="text-center border-b pb-4 mb-4"><h1 className="text-2xl font-bold">ใบส่งตัวผู้ป่วย</h1><p>ศูนย์อพยพอาคารวีสมหมาย</p></div><p><strong>ชื่อ:</strong> {getPatient()?.name}</p><p><strong>วินิจฉัย:</strong> {getPatient()?.diagnosis}</p><p><strong>การรักษา:</strong> {getPatient()?.treatment}</p><div className="mt-10 pt-4 border-t text-center no-print"><button onClick={()=>window.print()} className="bg-blue-600 text-white px-6 py-2 rounded mr-2">พิมพ์</button><button onClick={()=>updateStatus(selectedId, 'completed')} className="bg-green-600 text-white px-6 py-2 rounded">จบงาน</button></div></div> : <div className="text-center mt-10 no-print">เลือกผู้ป่วย</div>}</div></div>}
                             
                             {view==='history' && <div className="bg-white rounded shadow overflow-hidden"><table className="w-full text-left"><thead className="bg-gray-100 border-b"><tr><th className="p-3">เวลา</th><th className="p-3">ชื่อ</th><th className="p-3">สถานะ</th><th className="p-3"></th></tr></thead><tbody>{patients.filter(p=>p.status==='completed'||p.status==='referral').map(p=><tr key={p.id} className="border-b"><td className="p-3 text-sm">{p.time}</td><td className="p-3">{p.name}</td><td className="p-3">{p.status}</td><td className="p-3"><button onClick={()=>handleDelete(p.id)} className="text-red-500">{Icons.Trash}</button></td></tr>)}</tbody></table></div>}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

