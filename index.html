<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic OS - ระบบบริหารคลินิก</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 0. ERROR BOUNDARY (กันจอขาว) ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-10 text-center text-red-600">
                            <h1 className="text-2xl font-bold mb-2">⚠️ เกิดข้อผิดพลาด (System Error)</h1>
                            <p className="bg-red-50 p-4 rounded border border-red-200 inline-block text-left font-mono text-sm">
                                {this.state.error && this.state.error.toString()}
                            </p>
                            <p className="mt-4 text-slate-500">กรุณารีเฟรชหน้าจอ หรือตรวจสอบการตั้งค่า Firebase</p>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- 1. FIREBASE CONFIG ---
        // TODO: ใส่ค่า Config ของคุณที่นี่ (ถ้าไม่ใส่ จะใช้ Demo Mode ในหน่วยความจำ)
        const firebaseConfig = {
            apiKey: "AIzaSyBnu9ZPf8ttxZl0gnbco7hk5WK7-ol3ckM",
            authDomain: "clinic-os-app.firebaseapp.com",
            projectId: "clinic-os-app",
            storageBucket: "clinic-os-app.firebasestorage.app",
            messagingSenderId: "292981574948",
            appId: "1:292981574948:web:800208558304ddc6d737b1",
            measurementId: "G-Z8S0QFZ8JG"
        };

        // Initialize Firebase safely
        let app, auth, db;
        let isFirebaseActive = false;
        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") {
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.app();
                }
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseActive = true;
                console.log("Firebase Connected ✅");
            } else {
                console.warn("Firebase Config missing -> Using Local State Mode");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
        const appId = 'clinic-os-production-v1';

        // --- 2. ICON SYSTEM (SVG Direct) ---
        // ใช้ SVG โดยตรงเพื่อแก้ปัญหา Lucide React โหลดไม่ติด
        const Icons = {
            Activity: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            ClipboardList: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            UserPlus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>,
            ClipboardCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg>,
            Stethoscope: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></svg>,
            ShoppingBag: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
            History: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Loader2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            UserCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            PieChart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            Pill: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></svg>,
            Calculator: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Clock3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16.5 12"/></svg>,
            Printer: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            Tag: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l5 5a2 2 0 0 0 2.828 0l7.172-7.172a2 2 0 0 0 0-2.828l-5-5z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></svg>,
            Globe: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            PlusCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>,
            Phone: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
            Edit3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
        };

        const { useState, useEffect } = React;

        // --- DATABASE SEEDS ---
        const INITIAL_MEDICINE_DB = [
            { code: "PARA500", name: "Paracetamol 500mg", unit: "เม็ด", stdDose: 1, stdFreq: 4, timing: "เวลาปวด/มีไข้" },
            { code: "AMOX500", name: "Amoxicillin 500mg", unit: "แคปซูล", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร" },
            { code: "CPM", name: "Chlorpheniramine 4mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร" },
            { code: "OMEP20", name: "Omeprazole 20mg", unit: "แคปซูล", stdDose: 1, stdFreq: 2, timing: "ก่อนอาหาร" },
            { code: "METFOR500", name: "Metformin 500mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "หลังอาหารทันที" },
            { code: "AMLO5", name: "Amlodipine 5mg", unit: "เม็ด", stdDose: 1, stdFreq: 1, timing: "หลังอาหารเช้า" },
            { code: "PARA_SYR", name: "Paracetamol Syrup", unit: "ขวด", stdDose: 1, stdFreq: 4, timing: "เวลาปวด/มีไข้", calc: { type: 'syrup', mgPerKg: 10, mgPerUnit: 24, doseUnit: 'ml' } },
            { code: "AMOX_SYR", name: "Amoxicillin Dry Syrup", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "ก่อนอาหาร", calc: { type: 'syrup', mgPerKg: 20, mgPerUnit: 25, doseUnit: 'ml' } }
        ];

        const INITIAL_DIAGNOSIS_DB = [
            { code: "J00", name: "Common cold" }, { code: "A09", name: "Gastroenteritis" }, { code: "R50", name: "Fever" }, { code: "I10", name: "Hypertension" }
        ];

        const DEMO_PATIENTS = [
            { name: "ทดสอบ ระบบ", age: 30, gender: "ชาย", status: "waiting", queue: "A001", time: "08:00", idCard: "1111111111111", phone: "0812345678", screeningData: { symptom: "ทดสอบระบบ", bp: "120/80", temp: "36.5", pulse: "80", weight: "60" } }
        ];

        // --- COMPONENTS ---
        const SidebarItem = ({ icon, label, active, onClick, count }) => {
            const Icon = Icons[icon] || Icons.Activity;
            return (
                <button onClick={onClick} className={`w-full flex items-center justify-between p-3 rounded-lg transition-colors mb-1 ${active ? 'bg-blue-600 text-white shadow-md' : 'text-slate-600 hover:bg-slate-100'}`}>
                    <div className="flex items-center gap-3"><Icon size={20} /><span className="font-medium">{label}</span></div>
                    {count > 0 && <span className={`text-xs px-2 py-0.5 rounded-full ${active ? 'bg-white text-blue-600' : 'bg-red-500 text-white'}`}>{count}</span>}
                </button>
            );
        };

        const StatCard = ({ title, value, icon, color }) => {
            const Icon = Icons[icon] || Icons.Activity;
            return (
                <div className={`p-5 rounded-xl border ${color} bg-white shadow-sm flex items-center justify-between`}>
                    <div><p className="text-sm text-slate-500 mb-1">{title}</p><p className="text-2xl font-bold text-slate-800">{value}</p></div>
                    <div className="p-3 bg-slate-50 rounded-lg"><Icon size={24} className="opacity-80" /></div>
                </div>
            );
        };

        const InputGroup = ({ label, placeholder, value, onChange, type="text" }) => (
            <div className="mb-3">
                <label className="block text-xs font-bold text-slate-500 mb-1">{label}</label>
                <input type={type} className="w-full p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all" placeholder={placeholder} value={value} onChange={onChange} />
            </div>
        );

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            
            const [patients, setPatients] = useState([]);
            const [medicineList, setMedicineList] = useState(INITIAL_MEDICINE_DB);
            const [diagnosisList, setDiagnosisList] = useState(INITIAL_DIAGNOSIS_DB);
            const [masterDB, setMasterDB] = useState([]); // Mock Master DB

            // Data States
            const [newPatient, setNewPatient] = useState({ idCard: '', name: '', dob: '', age: '', gender: 'ชาย', phone: '', address: '', underlyingDisease: '', allergies: '' });
            const [isOldPatient, setIsOldPatient] = useState(false);
            const [screeningForm, setScreeningForm] = useState({ symptom: '', bp: '', temp: '', pulse: '', weight: '' });
            const [doctorVitals, setDoctorVitals] = useState({ symptom: '', bp: '', temp: '', pulse: '', weight: '' });
            const [examData, setExamData] = useState({ diagnosis: '', prescription: '' });
            const [pharmacyRx, setPharmacyRx] = useState('');

            // Selection States
            const [selectedScreening, setSelectedScreening] = useState(null);
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [selectedPharmacy, setSelectedPharmacy] = useState(null);
            const [editingPatient, setEditingPatient] = useState(null);

            // Modals
            const [showMedModal, setShowMedModal] = useState(false);
            const [currentMed, setCurrentMed] = useState(null);
            const [medCalc, setMedCalc] = useState({ dose: 1, freq: 3, days: 3, total: 9, note: '', isCalculated: false, doseUnit: '' });
            const [showDiagModal, setShowDiagModal] = useState(false);
            const [customDiag, setCustomDiag] = useState({ code: '', name: '' });
            const [showLabelModal, setShowLabelModal] = useState(false);
            const [labelsToPrint, setLabelsToPrint] = useState([]);

            // Search
            const [rxSearch, setRxSearch] = useState('');
            const [showRxList, setShowRxList] = useState(false);
            const [diagSearch, setDiagSearch] = useState('');
            const [showDiagList, setShowDiagList] = useState(false);

            // Firebase Sync
            useEffect(() => {
                if(!isFirebaseActive) { setLoading(false); return; }
                const unsub = auth.onAuthStateChanged(u => { setUser(u); if(!u) { auth.signInAnonymously(); } });
                return () => unsub();
            }, []);

            useEffect(() => {
                if(!user || !isFirebaseActive) return;
                
                // Realtime Listeners
                const qRef = db.collection('artifacts').doc(appId).collection('daily_queue');
                const unsubQueue = qRef.onSnapshot(snap => {
                    const data = snap.docs.map(d => ({id:d.id, ...d.data()}));
                    data.sort((a,b)=>a.queue.localeCompare(b.queue));
                    setPatients(data);
                    setLoading(false);
                }, err => console.error(err));

                const pRef = db.collection('artifacts').doc(appId).collection('patient_profiles');
                const unsubProfile = pRef.onSnapshot(snap => {
                    setMasterDB(snap.docs.map(d => d.data()));
                });

                return () => { unsubQueue(); unsubProfile(); };
            }, [user]);

            // Actions
            const calculateAge = (dob) => { if(!dob) return ''; const t=new Date(),b=new Date(dob); let a=t.getFullYear()-b.getFullYear(); if(t.getMonth()<b.getMonth()||(t.getMonth()===b.getMonth()&&t.getDate()<b.getDate())) a--; return a; };
            const handleDobChange = (e) => setNewPatient({ ...newPatient, dob: e.target.value, age: calculateAge(e.target.value) });

            useEffect(() => {
                if (newPatient.idCard.length === 13) {
                    const found = masterDB.find(p => p.idCard === newPatient.idCard);
                    if (found) { setNewPatient({ ...found }); setIsOldPatient(true); } else { setIsOldPatient(false); }
                }
            }, [newPatient.idCard, masterDB]);

            const handleLoadDemo = async () => {
                if(isFirebaseActive && user) {
                    setLoading(true);
                    for(let p of DEMO_PATIENTS) await db.collection('artifacts').doc(appId).collection('daily_queue').add(p);
                    setLoading(false);
                } else {
                    setPatients([...DEMO_PATIENTS]);
                }
            };

            const handleSaveProfile = async () => {
                if(isFirebaseActive && user && newPatient.idCard) {
                    await db.collection('artifacts').doc(appId).collection('patient_profiles').doc(newPatient.idCard).set(newPatient, {merge:true});
                }
            };

            const handleSendToQueue = async () => {
                if(!newPatient.name) return alert('กรุณากรอกชื่อ');
                await handleSaveProfile();
                const nextQueue = `A${String(patients.length+1).padStart(3,'0')}`;
                const newP = { ...newPatient, status: 'screening', queue: nextQueue, time: new Date().toLocaleTimeString('th-TH', {hour:'2-digit',minute:'2-digit'}), screeningData: {} };
                
                if(isFirebaseActive && user) {
                    await db.collection('artifacts').doc(appId).collection('daily_queue').add(newP);
                } else {
                    setPatients([...patients, {id: Date.now(), ...newP}]);
                }
                setNewPatient({idCard:'', name:'', dob:'', age:'', gender:'ชาย', phone:'', address:'', underlyingDisease: '', allergies: ''});
                setIsOldPatient(false);
                alert(`ส่งคิว ${nextQueue} เรียบร้อย`);
                setActiveTab('screening');
            };

            const handleEditPatientClick = (e,p) => { e.stopPropagation(); setEditingPatient({...p}); };
            const handleSavePatientInfo = async () => {
                if(!editingPatient) return;
                if(isFirebaseActive && user) {
                    await db.collection('artifacts').doc(appId).collection('daily_queue').doc(editingPatient.id).update(editingPatient);
                } else {
                    setPatients(patients.map(p=>p.id===editingPatient.id?editingPatient:p));
                }
                setEditingPatient(null);
            };
            const handleDeletePatient = async (e,p) => {
                e.stopPropagation();
                if(confirm('ยืนยันลบ?')) {
                    if(isFirebaseActive && user) await db.collection('artifacts').doc(appId).collection('daily_queue').doc(p.id).delete();
                    else setPatients(patients.filter(pt=>pt.id!==p.id));
                }
            };

            const handleSelectForScreening = (p) => { setSelectedScreening(p); setScreeningForm({ symptom: '', bp: '', temp: '', pulse: '', weight: '', ...p.screeningData }); };
            const handleSaveScreening = async () => {
                if(isFirebaseActive && user) {
                    await db.collection('artifacts').doc(appId).collection('daily_queue').doc(selectedScreening.id).update({status: 'waiting', screeningData: screeningForm});
                } else {
                    setPatients(patients.map(p=>p.id===selectedScreening.id?{...p, status:'waiting', screeningData:screeningForm}:p));
                }
                setSelectedScreening(null);
            };

            const handleSelectPatient = (p) => { 
                setSelectedPatient(p); 
                setExamData({diagnosis: p.diagnosis||'', prescription: p.treatment||''});
                setDoctorVitals({ symptom: p.screeningData?.symptom||'', bp: p.screeningData?.bp||'', temp: p.screeningData?.temp||'', pulse: p.screeningData?.pulse||'', weight: p.screeningData?.weight||'' });
            };
            const handleSaveTreatment = async () => {
                const data = { status: 'pharmacy', diagnosis: examData.diagnosis, treatment: examData.prescription, screeningData: {...selectedPatient.screeningData, ...doctorVitals} };
                if(isFirebaseActive && user) {
                    await db.collection('artifacts').doc(appId).collection('daily_queue').doc(selectedPatient.id).update(data);
                } else {
                    setPatients(patients.map(p=>p.id===selectedPatient.id?{...p, ...data}:p));
                }
                setSelectedPatient(null);
                alert("ส่งห้องยาเรียบร้อย");
            };

            const handleSelectPharmacy = (p) => { setSelectedPharmacy(p); setPharmacyRx(p.treatment||''); };
            const handleDispense = async (p) => {
                if(isFirebaseActive && user) {
                    await db.collection('artifacts').doc(appId).collection('daily_queue').doc(p.id).update({status: 'completed', treatment: pharmacyRx});
                } else {
                    setPatients(patients.map(pt=>pt.id===p.id?{...pt, status:'completed', treatment: pharmacyRx}:pt));
                }
                setSelectedPharmacy(null);
                alert("จ่ายยาเรียบร้อย");
            };

            // Medicine Logic
            const handleMedClick = (m) => { setCurrentMed(m); initMedCalc(m); setShowMedModal(true); setRxSearch(''); setShowRxList(false); };
            const handleManualMedClick = () => { const m={code:'CUSTOM', name:rxSearch, unit:'เม็ด', desc:'ตามแพทย์สั่ง', isCustom:true}; setCurrentMed(m); initMedCalc(m); setShowMedModal(true); setShowRxList(false); };
            const initMedCalc = (med) => {
                let d=med.stdDose||1, f=med.stdFreq||3, dy=3, tot=9, calc=false;
                const w = parseFloat(doctorVitals.weight || selectedPatient?.screeningData?.weight);
                if(med.calc && w && med.calc.type==='syrup') { d=Math.round((w*med.calc.mgPerKg/med.calc.mgPerUnit)*10)/10; calc=true; }
                if(['ขวด','หลอด','ตลับ','ซอง'].includes(med.unit)) tot=1; else tot=Math.ceil(d*f*dy);
                setMedCalc({dose:d, freq:f, days:dy, total:tot, note:med.timing||med.desc||'', isCalculated:calc, doseUnit:med.calc?.doseUnit||med.unit});
            };
            useEffect(() => { if(currentMed && !['ขวด','หลอด','ตลับ','ซอง'].includes(currentMed.unit)) setMedCalc(p=>({...p, total: Math.ceil(p.dose*p.freq*p.days)})); }, [medCalc.dose, medCalc.freq, medCalc.days, currentMed]);
            const handleAddUsageTag = (t) => setMedCalc(p=>({...p, note: `${p.note} ${t}`.trim()}));
            const confirmAddMedicine = () => {
                if(currentMed.isCustom && !medicineList.find(m=>m.name===currentMed.name)) setMedicineList([...medicineList, {...currentMed, code:`C-${Date.now()}`}]);
                let unit = medCalc.doseUnit==='ml'?'ซีซี':medCalc.doseUnit;
                let instr = `ทานครั้งละ ${medCalc.dose} ${unit} วันละ ${medCalc.freq} ครั้ง ${medCalc.note}`;
                const entry = `- ${currentMed.name}\n  จ่าย: ${medCalc.total} ${currentMed.unit} | ${instr}`;
                setExamData(p=>({...p, prescription: p.prescription?p.prescription+'\n'+entry:entry}));
                setShowMedModal(false);
            };

            const handleManualDiagClick = () => { setCustomDiag({code:'', name:diagSearch}); setShowDiagModal(true); setShowDiagList(false); };
            const handleSaveCustomDiag = () => {
                setDiagnosisList(prev=>[...prev, {code: customDiag.code||"USER", name:customDiag.name}]);
                const str = `${customDiag.code} - ${customDiag.name}`;
                setExamData(prev=>({...prev, diagnosis: prev.diagnosis?prev.diagnosis+'\n'+str:str}));
                setShowDiagModal(false); setDiagSearch('');
            };

            const handlePrintPreview = (p) => {
                const rx = pharmacyRx || p.treatment;
                if(!rx) return alert('ไม่มียา');
                const items = rx.split('\n- ').map((t,i) => {
                    const txt = i===0&&t.startsWith('- ')?t.substring(2):t;
                    const pts = txt.split('\n  ');
                    return {name: pts[0], detail: pts[1]||''};
                }).filter(i=>i.name);
                setLabelsToPrint({patient:p, items}); setShowLabelModal(true);
            };

            const stats = {
                screening: patients.filter(p=>p.status==='screening').length,
                waiting: patients.filter(p=>p.status==='waiting').length,
                pharmacy: patients.filter(p=>p.status==='pharmacy').length,
                completed: patients.filter(p=>p.status==='completed').length
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-blue-600 font-bold animate-pulse">กำลังโหลดระบบ Clinic OS...</div>;

            return (
                <div className="flex h-screen overflow-hidden">
                    <ErrorBoundary>
                    {/* Modals */}
                    {showMedModal && currentMed && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
                            <div className="bg-white rounded-xl w-full max-w-sm overflow-hidden shadow-2xl">
                                <div className={`p-4 text-white flex justify-between ${currentMed.isCustom?'bg-purple-600':(medCalc.isCalculated?'bg-green-600':'bg-blue-600')}`}><h3>{currentMed.isCustom?'เพิ่มยาเอง':'คำนวณ'}: {currentMed.name}</h3><button onClick={()=>setShowMedModal(false)}>✕</button></div>
                                <div className="p-4 space-y-4">
                                    <div className="grid grid-cols-3 gap-2 text-center">
                                        <div><label className="text-xs">ครั้งละ {medCalc.doseUnit==='ml'?'(ml)':''}</label><input type="number" step={medCalc.doseUnit==='ml'?"0.1":"0.5"} className="w-full border rounded p-1 text-center" value={medCalc.dose} onChange={e=>setMedCalc({...medCalc, dose:e.target.value})}/></div>
                                        <div><label className="text-xs">วันละ (ครั้ง)</label><input type="number" className="w-full border rounded p-1 text-center" value={medCalc.freq} onChange={e=>setMedCalc({...medCalc, freq:e.target.value})}/></div>
                                        <div><label className="text-xs">จำนวนวัน</label><input type="number" className="w-full border rounded p-1 text-center" value={medCalc.days} onChange={e=>setMedCalc({...medCalc, days:e.target.value})}/></div>
                                    </div>
                                    <div className="text-center font-bold text-blue-600 border bg-blue-50 p-2 rounded">รวม: {medCalc.total} {currentMed.unit}</div>
                                    <div><label className="text-xs font-bold">เวลาทาน</label><div className="flex flex-wrap gap-1 mt-1">{['หลังอาหาร','ก่อนอาหาร','ก่อนนอน','เวลาปวด'].map(t=><button key={t} onClick={()=>handleAddUsageTag(t)} className="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-blue-50">{t}</button>)}</div></div>
                                    <textarea className="w-full border rounded p-2 text-sm" rows="2" value={medCalc.note} onChange={e=>setMedCalc({...medCalc, note:e.target.value})}></textarea>
                                    <button onClick={confirmAddMedicine} className="w-full bg-blue-600 text-white p-2 rounded font-bold">เพิ่มลงใบสั่ง</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showDiagModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"><div className="bg-white rounded-xl w-full max-w-sm p-4 space-y-3"><h3>เพิ่มโรคใหม่</h3><input className="w-full border p-2 rounded" placeholder="รหัส" value={customDiag.code} onChange={e=>setCustomDiag({...customDiag, code:e.target.value})}/><input className="w-full border p-2 rounded" placeholder="ชื่อโรค" value={customDiag.name} onChange={e=>setCustomDiag({...customDiag, name:e.target.value})}/><div className="flex justify-end gap-2"><button onClick={()=>setShowDiagModal(false)} className="border px-3 py-1 rounded">ยกเลิก</button><button onClick={handleSaveCustomDiag} className="bg-blue-600 text-white px-3 py-1 rounded">บันทึก</button></div></div></div>}
                    {showLabelModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4"><div className="bg-white p-6 rounded-xl w-full max-w-2xl h-[80vh] flex flex-col"><div className="flex justify-between mb-4"><h3 className="font-bold">พิมพ์ฉลากยา</h3><button onClick={()=>setShowLabelModal(false)}><Icons.X/></button></div><div className="flex-1 overflow-auto grid grid-cols-2 gap-4">{labelsToPrint.items.map((m,i)=><div key={i} className="border p-4 rounded text-center shadow-sm"><div className="text-sm font-bold text-slate-700">คลินิกเวชกรรมรักษ์ดี</div><div className="text-xs mb-2 text-slate-500">{labelsToPrint.patient.name}</div><div className="font-bold text-lg mb-1">{m.name}</div><div className="text-sm">{m.detail.split('|')[1]}</div></div>)}</div><div className="mt-4 flex justify-end"><button onClick={()=>window.print()} className="bg-blue-600 text-white px-4 py-2 rounded flex gap-2 items-center"><Icons.Printer size={16}/> สั่งพิมพ์</button></div></div></div>}
                    {editingPatient && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"><div className="bg-white rounded-xl w-full max-w-md p-6 space-y-4"><h3 className="font-bold text-lg">แก้ไขข้อมูล</h3><InputGroup label="ชื่อ-สกุล" value={editingPatient.name} onChange={e=>setEditingPatient({...editingPatient, name:e.target.value})}/><InputGroup label="เบอร์โทร" value={editingPatient.phone} onChange={e=>setEditingPatient({...editingPatient, phone:e.target.value})}/><div className="flex justify-end gap-2"><button onClick={()=>setEditingPatient(null)} className="border px-4 py-2 rounded">ยกเลิก</button><button onClick={handleSavePatientInfo} className="bg-blue-600 text-white px-4 py-2 rounded">บันทึก</button></div></div></div>}

                    {/* Main UI */}
                    <aside className={`fixed lg:static inset-y-0 z-30 w-64 bg-white shadow-xl transform transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                        <div className="p-6 border-b flex items-center gap-2"><Icons.Activity className="text-blue-600"/><span className="font-bold text-xl text-slate-800">Clinic OS</span></div>
                        <div className="p-4 space-y-1">
                            <SidebarItem icon="ClipboardList" label="แดชบอร์ด" active={activeTab==='dashboard'} onClick={()=>{setActiveTab('dashboard');setSidebarOpen(false)}} />
                            <div className="pt-4 pb-2 px-3 text-xs font-bold text-slate-400">ทะเบียน</div>
                            <SidebarItem icon="UserPlus" label="ลงทะเบียน" active={activeTab==='register'} onClick={()=>{setActiveTab('register');setSidebarOpen(false)}} />
                            <SidebarItem icon="ClipboardCheck" label="จุดคัดกรอง" count={stats.screening} active={activeTab==='screening'} onClick={()=>{setActiveTab('screening');setSidebarOpen(false)}} />
                            <div className="pt-4 pb-2 px-3 text-xs font-bold text-slate-400">รักษา</div>
                            <SidebarItem icon="Stethoscope" label="ห้องตรวจแพทย์" count={stats.waiting} active={activeTab==='doctor'} onClick={()=>{setActiveTab('doctor');setSidebarOpen(false)}} />
                            <SidebarItem icon="ShoppingBag" label="ห้องจ่ายยา" count={stats.pharmacy} active={activeTab==='pharmacy'} onClick={()=>{setActiveTab('pharmacy');setSidebarOpen(false)}} />
                            <div className="pt-4 pb-2 px-3 text-xs font-bold text-slate-400">ข้อมูล</div>
                            <SidebarItem icon="History" label="ประวัติการรักษา" active={activeTab==='history'} onClick={()=>{setActiveTab('history');setSidebarOpen(false)}} />
                        </div>
                        <div className="p-4 border-t text-xs text-center text-slate-400">v2.1 Firebase Connected</div>
                    </aside>

                    <main className="flex-1 flex flex-col h-screen overflow-hidden bg-slate-50">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm"><button onClick={()=>setSidebarOpen(true)} className="lg:hidden"><Icons.Menu/></button><div className="text-right text-sm text-slate-500 font-bold">คลินิกเวชกรรมรักษ์ดี</div></header>
                        <div className="flex-1 overflow-auto p-6">
                            {activeTab === 'dashboard' && <div className="space-y-6"><div className="flex justify-end"><button onClick={handleLoadDemo} className="bg-white border p-2 rounded text-sm hover:bg-slate-50 flex gap-2 items-center"><Icons.RefreshCw size={14}/> Reset Demo Data</button></div><div className="grid grid-cols-2 md:grid-cols-4 gap-4"><StatCard title="รอคัดกรอง" value={stats.screening} icon="ClipboardCheck" color="border-orange-200" /><StatCard title="รอตรวจ" value={stats.waiting} icon="User" color="border-blue-200" /><StatCard title="รอรับยา" value={stats.pharmacy} icon="ShoppingBag" color="border-purple-200" /><StatCard title="เสร็จสิ้น" value={stats.completed} icon="CheckCircle" color="border-green-200" /></div></div>}
                            
                            {activeTab === 'register' && <div className="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-sm border space-y-4"><h2 className="font-bold text-xl text-blue-600 flex gap-2"><Icons.UserPlus/> ลงทะเบียน</h2>{isOldPatient && <div className="bg-green-50 p-2 text-green-700 text-sm rounded border border-green-200">พบข้อมูลเก่า</div>}<div className="grid grid-cols-2 gap-4"><InputGroup label="เลขบัตร (13 หลัก)" value={newPatient.idCard} onChange={e=>{const v=e.target.value.replace(/[^0-9]/g,''); if(v.length<=13)setNewPatient({...newPatient, idCard:v})}}/><InputGroup label="ชื่อ-สกุล" value={newPatient.name} onChange={e=>setNewPatient({...newPatient, name:e.target.value})}/><InputGroup label="เบอร์โทร" value={newPatient.phone} onChange={e=>setNewPatient({...newPatient, phone:e.target.value})}/><InputGroup label="ที่อยู่" value={newPatient.address} onChange={e=>setNewPatient({...newPatient, address:e.target.value})}/></div><div className="grid grid-cols-2 gap-4"><InputGroup label="โรคประจำตัว" value={newPatient.underlyingDisease} onChange={e=>setNewPatient({...newPatient, underlyingDisease:e.target.value})}/><div className="text-red-600"><InputGroup label="แพ้ยา/อาหาร" value={newPatient.allergies} onChange={e=>setNewPatient({...newPatient, allergies:e.target.value})}/></div></div><button onClick={handleSendToQueue} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold shadow hover:bg-blue-700">ส่งคัดกรอง</button></div>}

                            {activeTab === 'screening' && <div className="flex flex-col lg:flex-row gap-4 h-full"><div className="w-full lg:w-1/3 bg-white border rounded-xl overflow-hidden flex flex-col"><div className="p-3 bg-orange-100 font-bold text-orange-800">คิวรอคัดกรอง</div><div className="flex-1 overflow-auto">{patients.filter(p=>p.status==='screening').map(p=><div key={p.id} onClick={()=>handleSelectForScreening(p)} className="p-3 border-b hover:bg-orange-50 cursor-pointer flex justify-between relative group"><span>{p.queue} {p.name}</span><div className="hidden group-hover:flex gap-1 absolute right-2 top-2"><button onClick={e=>handleEditPatientClick(e,p)} className="bg-white p-1 rounded border"><Icons.Edit size={12}/></button><button onClick={e=>handleDeletePatient(e,p)} className="bg-white p-1 rounded border text-red-500"><Icons.Trash2 size={12}/></button></div></div>)}</div></div><div className="flex-1 bg-white border rounded-xl p-6">{selectedScreening ? <div className="space-y-4"><h3 className="font-bold text-xl">คัดกรอง: {selectedScreening.name}</h3>{(selectedScreening.allergies)&&<div className="text-red-600 font-bold bg-red-50 p-2 rounded">แพ้: {selectedScreening.allergies}</div>}<textarea className="w-full border p-2 rounded" placeholder="อาการ..." value={screeningForm.symptom} onChange={e=>setScreeningForm({...screeningForm, symptom:e.target.value})}/><div className="grid grid-cols-4 gap-2"><InputGroup label="BP" value={screeningForm.bp} onChange={e=>setScreeningForm({...screeningForm, bp:e.target.value})}/><InputGroup label="Temp" value={screeningForm.temp} onChange={e=>setScreeningForm({...screeningForm, temp:e.target.value})}/><InputGroup label="Pulse" value={screeningForm.pulse} onChange={e=>setScreeningForm({...screeningForm, pulse:e.target.value})}/><InputGroup label="Weight" value={screeningForm.weight} onChange={e=>setScreeningForm({...screeningForm, weight:e.target.value})}/></div><button onClick={handleSaveScreening} className="w-full bg-orange-600 text-white p-3 rounded font-bold">ส่งตรวจ</button></div> : <div className="text-center text-gray-400 mt-20">เลือกผู้ป่วย</div>}</div></div>}

                            {activeTab === 'doctor' && <div className="flex flex-col lg:flex-row gap-4 h-full"><div className="w-full lg:w-1/3 bg-white border rounded-xl overflow-hidden flex flex-col"><div className="p-3 bg-blue-100 font-bold text-blue-800">คิวรอตรวจ</div><div className="flex-1 overflow-auto">{patients.filter(p=>p.status==='waiting').map(p=><div key={p.id} onClick={()=>handleSelectPatient(p)} className="p-3 border-b hover:bg-blue-50 cursor-pointer flex justify-between relative group"><span>{p.queue} {p.name}</span><button onClick={e=>handleEditPatientClick(e,p)} className="hidden group-hover:block bg-white p-1 rounded border absolute right-2 top-2"><Icons.Edit size={12}/></button></div>)}</div></div><div className="flex-1 bg-white border rounded-xl p-6 overflow-auto">{selectedPatient ? <div className="space-y-4"><div className="flex justify-between border-b pb-2"><h3 className="font-bold text-lg">{selectedPatient.name}</h3><span className="text-blue-600 font-bold">{selectedPatient.queue}</span></div>{(selectedPatient.allergies)&&<div className="bg-red-100 text-red-800 p-2 rounded font-bold animate-pulse">แพ้: {selectedPatient.allergies}</div>}<div className="grid grid-cols-4 gap-2 bg-slate-50 p-2 rounded text-sm"><span>BP: {doctorVitals.bp}</span><span>T: {doctorVitals.temp}</span><span>P: {doctorVitals.pulse}</span><span>W: {doctorVitals.weight}</span></div><div><label className="font-bold">อาการ</label><textarea className="w-full border p-2 rounded" rows="2" value={doctorVitals.symptom} onChange={e=>setDoctorVitals({...doctorVitals, symptom:e.target.value})}/></div><div><div className="flex justify-between"><label className="font-bold">วินิจฉัย</label><button onClick={()=>setShowDiagList(!showDiagList)} className="text-xs text-blue-600">ค้นหา</button></div>{showDiagList && <div className="border p-2 max-h-32 overflow-auto mb-2"><input className="w-full border p-1 mb-1" placeholder="ค้นหา..." value={diagSearch} onChange={e=>setDiagSearch(e.target.value)}/>{diagnosisList.filter(d=>d.name.toLowerCase().includes(diagSearch.toLowerCase())).map(d=><div key={d.code} onClick={()=>{setExamData(p=>({...p, diagnosis:p.diagnosis+'\n'+d.code+' '+d.name}));setShowDiagList(false)}} className="cursor-pointer hover:bg-blue-50 text-sm p-1">{d.name}</div>)}<div onClick={handleManualDiagClick} className="text-center text-blue-600 cursor-pointer font-bold">+ เพิ่มเอง</div></div>}<textarea className="w-full border p-2 rounded" rows="2" value={examData.diagnosis} onChange={e=>setExamData({...examData, diagnosis:e.target.value})}/></div><div><div className="flex justify-between"><label className="font-bold">สั่งยา</label><button onClick={()=>setShowRxList(!showRxList)} className="text-xs text-blue-600">ค้นหา</button></div>{showRxList && <div className="border p-2 max-h-40 overflow-auto mb-2"><div className="flex gap-2 mb-1"><input className="w-full border p-1" placeholder="ค้นหา..." value={rxSearch} onChange={e=>setRxSearch(e.target.value)}/><button onClick={handleManualMedClick} className="bg-blue-100 px-2 rounded font-bold text-xs">+</button></div>{medicineList.filter(d=>d.name.toLowerCase().includes(rxSearch.toLowerCase())).map(m=><div key={m.code} onClick={()=>handleMedClick(m)} className="cursor-pointer hover:bg-blue-50 p-1 border-b text-sm flex justify-between"><span>{m.name}</span><Icons.Calculator size={12}/></div>)}</div>}<textarea className="w-full border p-2 rounded" rows="4" value={examData.prescription} onChange={e=>setExamData({...examData, prescription:e.target.value})}/></div><button onClick={handleSaveTreatment} className="w-full bg-green-600 text-white p-3 rounded font-bold">บันทึกและส่งห้องยา</button></div> : <div className="text-center text-gray-400 mt-20">เลือกผู้ป่วย</div>}</div></div>}

                            {activeTab === 'pharmacy' && <div className="flex flex-col lg:flex-row gap-4 h-full"><div className="w-full lg:w-1/3 bg-white border rounded-xl overflow-hidden flex flex-col"><div className="p-3 bg-purple-100 font-bold text-purple-800">รอจ่ายยา</div><div className="flex-1 overflow-auto">{patients.filter(p=>p.status==='pharmacy').map(p=><div key={p.id} onClick={()=>{setSelectedPharmacy(p); setPharmacyRx(p.treatment)}} className="p-3 border-b hover:bg-purple-50 cursor-pointer flex justify-between"><span>{p.queue} {p.name}</span></div>)}</div></div><div className="flex-1 bg-white border rounded-xl p-6 overflow-auto">{selectedPharmacy ? <div className="space-y-4"><h3 className="font-bold text-lg border-b pb-2 flex justify-between"><span>{selectedPharmacy.name}</span> <span className="text-purple-600">{selectedPharmacy.queue}</span></h3><div className="bg-slate-50 p-2 rounded border text-sm"><span className="font-bold">วินิจฉัย:</span> {selectedPharmacy.diagnosis}</div><div className="border rounded"><div className="bg-slate-100 p-2 flex justify-between"><span>รายการยา</span><button onClick={()=>handlePrintPreview(selectedPharmacy)} className="text-blue-600 text-xs flex gap-1 items-center font-bold"><Icons.Tag size={12}/> พิมพ์ฉลาก</button></div><textarea className="w-full p-2 h-40 border-0 resize-none" value={pharmacyRx} onChange={e=>setPharmacyRx(e.target.value)}/></div><button onClick={()=>handleDispense(selectedPharmacy)} className="w-full bg-purple-600 text-white p-3 rounded font-bold">ยืนยันการจ่ายยา</button></div> : <div className="text-center text-gray-400 mt-20">เลือกรายการ</div>}</div></div>}

                            {activeTab === 'history' && <div className="bg-white border rounded-xl overflow-hidden"><table className="w-full text-left"><thead className="bg-slate-100 border-b"><tr><th className="p-3">เวลา</th><th className="p-3">ชื่อ</th><th className="p-3">วินิจฉัย</th><th className="p-3">สถานะ</th></tr></thead><tbody>{patients.filter(p=>p.status==='completed').map(p=><tr key={p.id} className="border-b hover:bg-slate-50"><td className="p-3 text-sm">{p.time}</td><td className="p-3">{p.name}</td><td className="p-3 text-sm text-slate-600">{p.diagnosis}</td><td className="p-3"><span className="bg-green-100 text-green-800 px-2 rounded text-xs">เสร็จสิ้น</span></td></tr>)}</tbody></table></div>}
                        </div>
                    </main>
                    </ErrorBoundary>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
