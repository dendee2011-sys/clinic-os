<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic OS - Lite</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .error-box { background: #fee2e2; border: 2px solid #ef4444; color: #b91c1c; padding: 20px; margin: 20px; border-radius: 10px; }
    </style>

    <!-- ‡∏ï‡∏±‡∏ß‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö Error (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ó‡∏ô Console) -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('root').innerHTML = `
                <div class="error-box">
                    <h3 class="font-bold text-lg">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (Error)</h3>
                    <p>${message}</p>
                    <p class="text-sm mt-2 opacity-75">‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î: ${lineno}</p>
                    <p class="mt-4 text-sm">‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</p>
                </div>
            `;
        };
    </script>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">
    <div id="root">
        <div class="flex items-center justify-center h-screen text-slate-500">
            ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö... (‡∏ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤)
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBnu9ZPf8ttxZl0gnbco7hk5WK7-ol3ckM",
            authDomain: "clinic-os-app.firebaseapp.com",
            projectId: "clinic-os-app",
            storageBucket: "clinic-os-app.firebasestorage.app",
            messagingSenderId: "292981574948",
            appId: "1:292981574948:web:800208558304ddc6d737b1",
            measurementId: "G-Z8S0QFZ8JG"
        };

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á ---
        const DEMO_PATIENTS = [
            { name: "‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ", age: 45, gender: "‡∏ä‡∏≤‡∏¢", status: "waiting", queue: "A001", time: "08:30", idCard: "1100700123456", phone: "081-234-5678", screeningData: { symptom: "‡πÑ‡∏Ç‡πâ‡∏™‡∏π‡∏á", bp: "130/85", temp: "38.5", pulse: "90", weight: "70" } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏≤‡∏•‡∏µ", age: 32, gender: "‡∏´‡∏ç‡∏¥‡∏á", status: "screening", queue: "A002", time: "08:45", idCard: "3100500987654", phone: "089-876-5432", screeningData: {} }
        ];

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏¢‡πà‡∏≠‡∏¢ (‡πÉ‡∏ä‡πâ Emoji ‡πÅ‡∏ó‡∏ô Icon) ---
        const SidebarItem = ({ icon, label, active, onClick, count }) => (
            <button onClick={onClick} className={`w-full flex items-center justify-between p-3 rounded-lg ${active ? 'bg-blue-100 text-blue-800 font-bold' : 'hover:bg-slate-200'}`}>
                <div className="flex items-center gap-3"><span className="text-xl">{icon}</span><span>{label}</span></div>
                {count > 0 && <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{count}</span>}
            </button>
        );

        // --- APP MAIN ---
        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [patients, setPatients] = useState([]);
            
            // Forms
            const [newPatient, setNewPatient] = useState({ idCard: '', name: '', age: '', gender: '‡∏ä‡∏≤‡∏¢', phone: '' });
            const [selectedItem, setSelectedItem] = useState(null); // ‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å Tab
            const [formData, setFormData] = useState({}); // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß

            // Auth & Data
            useEffect(() => {
                auth.signInAnonymously().catch(err => alert("Login Error: " + err.message));
                return auth.onAuthStateChanged(u => {
                    setUser(u);
                    if(u) {
                        // Subscribe to Queue
                        db.collection('clinic_data').doc(u.uid).collection('daily_queue')
                          .onSnapshot(snapshot => {
                              const data = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                              data.sort((a,b) => a.queue.localeCompare(b.queue));
                              setPatients(data);
                          });
                    }
                });
            }, []);

            const loadDemo = async () => {
                if(!user) return;
                try {
                    const ref = db.collection('clinic_data').doc(user.uid).collection('daily_queue');
                    for(const p of DEMO_PATIENTS) await ref.add(p);
                    alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß");
                } catch(e) { alert(e.message); }
            };

            const addQueue = async () => {
                if(!user || !newPatient.name) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                const q = `A${String(patients.length+1).padStart(3,'0')}`;
                await db.collection('clinic_data').doc(user.uid).collection('daily_queue').add({
                    ...newPatient, status: 'screening', queue: q, time: new Date().toLocaleTimeString('th-TH')
                });
                alert(`‡∏™‡πà‡∏á‡∏Ñ‡∏¥‡∏ß ${q} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
                setNewPatient({ idCard: '', name: '', age: '', gender: '‡∏ä‡∏≤‡∏¢', phone: '' });
                setActiveTab('screening');
            };

            const updateStatus = async (id, status, extra={}) => {
                await db.collection('clinic_data').doc(user.uid).collection('daily_queue').doc(id).update({status, ...extra});
                setSelectedItem(null);
            };

            const deleteQ = async (id) => {
                if(confirm("‡∏•‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö?")) await db.collection('clinic_data').doc(user.uid).collection('daily_queue').doc(id).delete();
            };

            if (!user) return <div className="flex h-screen items-center justify-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Å‡∏±‡∏ö Google...</div>;

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar */}
                    <aside className={`fixed lg:static inset-y-0 left-0 z-30 w-64 bg-white shadow-xl transform transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                        <div className="p-4 border-b font-bold text-xl text-blue-600">üè• Clinic OS</div>
                        <nav className="p-2 space-y-1">
                            <SidebarItem icon="üìä" label="‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°" active={activeTab==='dashboard'} onClick={()=>setActiveTab('dashboard')} />
                            <SidebarItem icon="üìù" label="‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" active={activeTab==='register'} onClick={()=>setActiveTab('register')} />
                            <SidebarItem icon="‚öñÔ∏è" label="‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á" count={patients.filter(p=>p.status==='screening').length} active={activeTab==='screening'} onClick={()=>setActiveTab('screening')} />
                            <SidebarItem icon="ü©∫" label="‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à" count={patients.filter(p=>p.status==='waiting').length} active={activeTab==='doctor'} onClick={()=>setActiveTab('doctor')} />
                            <SidebarItem icon="üíä" label="‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤" count={patients.filter(p=>p.status==='pharmacy').length} active={activeTab==='pharmacy'} onClick={()=>setActiveTab('pharmacy')} />
                        </nav>
                    </aside>

                    {/* Content */}
                    <main className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="h-14 border-b bg-white flex items-center px-4 justify-between">
                            <button onClick={()=>setSidebarOpen(!sidebarOpen)} className="lg:hidden text-2xl">üçî</button>
                            <div className="font-bold">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏±‡∏Å‡∏©‡πå‡∏î‡∏µ</div>
                        </header>
                        <div className="flex-1 overflow-auto p-4 bg-slate-50">
                            
                            {/* Dashboard */}
                            {activeTab === 'dashboard' && (
                                <div className="space-y-4">
                                    <div className="flex justify-end"><button onClick={loadDemo} className="bg-slate-200 px-4 py-2 rounded hover:bg-slate-300">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Demo</button></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-orange-100 p-4 rounded text-center"><div>‡∏£‡∏≠‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á</div><div className="text-3xl font-bold">{patients.filter(p=>p.status==='screening').length}</div></div>
                                        <div className="bg-blue-100 p-4 rounded text-center"><div>‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</div><div className="text-3xl font-bold">{patients.filter(p=>p.status==='waiting').length}</div></div>
                                        <div className="bg-purple-100 p-4 rounded text-center"><div>‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏¢‡∏≤</div><div className="text-3xl font-bold">{patients.filter(p=>p.status==='pharmacy').length}</div></div>
                                        <div className="bg-green-100 p-4 rounded text-center"><div>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div><div className="text-3xl font-bold">{patients.filter(p=>p.status==='completed').length}</div></div>
                                    </div>
                                </div>
                            )}

                            {/* Register */}
                            {activeTab === 'register' && (
                                <div className="bg-white p-6 rounded shadow max-w-lg mx-auto space-y-4">
                                    <h2 className="text-xl font-bold">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</h2>
                                    <input className="border w-full p-2 rounded" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô" value={newPatient.idCard} onChange={e=>setNewPatient({...newPatient, idCard:e.target.value})}/>
                                    <input className="border w-full p-2 rounded" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" value={newPatient.name} onChange={e=>setNewPatient({...newPatient, name:e.target.value})}/>
                                    <div className="flex gap-2">
                                        <input className="border w-full p-2 rounded" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏" value={newPatient.age} onChange={e=>setNewPatient({...newPatient, age:e.target.value})}/>
                                        <select className="border w-full p-2 rounded" value={newPatient.gender} onChange={e=>setNewPatient({...newPatient, gender:e.target.value})}><option>‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡∏ç‡∏¥‡∏á</option></select>
                                    </div>
                                    <input className="border w-full p-2 rounded" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" value={newPatient.phone} onChange={e=>setNewPatient({...newPatient, phone:e.target.value})}/>
                                    <button onClick={addQueue} className="bg-blue-600 text-white w-full p-3 rounded font-bold">‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß</button>
                                </div>
                            )}

                            {/* Screening, Doctor, Pharmacy Logic (Unified View) */}
                            {['screening', 'doctor', 'pharmacy'].includes(activeTab) && (
                                <div className="flex flex-col md:flex-row gap-4 h-full">
                                    <div className="w-full md:w-1/3 bg-white rounded shadow flex flex-col h-full">
                                        <div className="p-3 bg-gray-100 font-bold border-b">
                                            {activeTab==='screening'?'‡∏£‡∏≠‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á':activeTab==='doctor'?'‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à':'‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤'}
                                        </div>
                                        <div className="flex-1 overflow-auto p-2 space-y-2">
                                            {patients.filter(p => p.status === (activeTab==='doctor'?'waiting':activeTab)).map(p => (
                                                <div key={p.id} onClick={() => { setSelectedItem(p); setFormData(activeTab==='screening'?{...p.screeningData}:activeTab==='doctor'?{dx:'', rx:''}:{rx: p.treatment||''}) }} 
                                                     className="p-3 border rounded cursor-pointer hover:bg-blue-50 flex justify-between">
                                                    <div><span className="bg-gray-200 text-xs px-2 rounded mr-2">{p.queue}</span>{p.name}</div>
                                                    <button onClick={(e)=>{e.stopPropagation();deleteQ(p.id)}} className="text-red-300 hover:text-red-500">x</button>
                                                </div>
                                            ))}
                                            {patients.filter(p => p.status === (activeTab==='doctor'?'waiting':activeTab)).length === 0 && <div className="text-center text-gray-400 mt-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß</div>}
                                        </div>
                                    </div>
                                    
                                    <div className="flex-1 bg-white rounded shadow p-4 overflow-auto">
                                        {selectedItem ? (
                                            <div className="space-y-4">
                                                <div className="border-b pb-2 font-bold text-lg">{selectedItem.name} <span className="text-sm font-normal text-gray-500">({selectedItem.age} ‡∏õ‡∏µ)</span></div>
                                                
                                                {activeTab === 'screening' && (
                                                    <>
                                                        <textarea className="border w-full p-2 rounded" placeholder="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô" value={formData.symptom||''} onChange={e=>setFormData({...formData, symptom:e.target.value})}></textarea>
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <input className="border p-2 rounded" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô (BP)" value={formData.bp||''} onChange={e=>setFormData({...formData, bp:e.target.value})}/>
                                                            <input className="border p-2 rounded" placeholder="‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (T)" value={formData.temp||''} onChange={e=>setFormData({...formData, temp:e.target.value})}/>
                                                            <input className="border p-2 rounded" placeholder="‡∏ä‡∏µ‡∏û‡∏à‡∏£ (P)" value={formData.pulse||''} onChange={e=>setFormData({...formData, pulse:e.target.value})}/>
                                                            <input className="border p-2 rounded" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)" value={formData.weight||''} onChange={e=>setFormData({...formData, weight:e.target.value})}/>
                                                        </div>
                                                        <button onClick={()=>updateStatus(selectedItem.id, 'waiting', {screeningData: formData})} className="bg-orange-500 text-white w-full p-3 rounded font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</button>
                                                    </>
                                                )}

                                                {activeTab === 'doctor' && (
                                                    <>
                                                        <div className="bg-blue-50 p-2 rounded text-sm mb-2">
                                                            CC: {selectedItem.screeningData?.symptom} <br/>
                                                            V/S: BP={selectedItem.screeningData?.bp} T={selectedItem.screeningData?.temp}
                                                        </div>
                                                        <label className="font-bold">‡∏ú‡∏•‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ (Dx)</label>
                                                        <textarea className="border w-full p-2 rounded" rows="2" value={formData.dx||''} onChange={e=>setFormData({...formData, dx:e.target.value})}></textarea>
                                                        <label className="font-bold">‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤ (Rx)</label>
                                                        <textarea className="border w-full p-2 rounded" rows="4" value={formData.rx||''} onChange={e=>setFormData({...formData, rx:e.target.value})}></textarea>
                                                        <button onClick={()=>updateStatus(selectedItem.id, 'pharmacy', {diagnosis: formData.dx, treatment: formData.rx})} className="bg-blue-600 text-white w-full p-3 rounded font-bold">‡∏™‡πà‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤</button>
                                                    </>
                                                )}

                                                {activeTab === 'pharmacy' && (
                                                    <>
                                                        <div className="bg-purple-50 p-2 rounded text-sm mb-2">Dx: {selectedItem.diagnosis}</div>
                                                        <label className="font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</label>
                                                        <textarea className="border w-full p-2 rounded h-32" value={formData.rx||''} onChange={e=>setFormData({...formData, rx:e.target.value})}></textarea>
                                                        <button onClick={()=>updateStatus(selectedItem.id, 'completed', {treatment: formData.rx})} className="bg-green-600 text-white w-full p-3 rounded font-bold">‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</button>
                                                    </>
                                                )}
                                            </div>
                                        ) : <div className="text-gray-400 text-center mt-20">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠</div>}
                                    </div>
                                </div>
                            )}

                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
