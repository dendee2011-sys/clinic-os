<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic OS - ระบบจำข้อมูลคนไข้</title>
    
    <!-- 1. Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- 2. React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Firebase V9 Compat (เสถียรที่สุด) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .print-page { margin: 0; padding: 2cm; }
        }
        .print-only { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #64748b;">
            <div style="font-size: 24px; font-weight: bold; color: #2563eb; margin-bottom: 10px;">Clinic OS</div>
            <div id="loading-text">กำลังกู้คืนระบบดึงข้อมูล...</div>
        </div>
    </div>

    <!-- Error Trap -->
    <script>
        window.onerror = function(msg, url, line) {
            document.getElementById('root').innerHTML = `<div style="text-align:center; padding:50px; color:red;"><h3>⚠️ เกิดข้อผิดพลาด</h3><p>${msg} (Line: ${line})</p><button onclick="window.location.reload()" style="margin-top:20px; padding:10px 20px; border:1px solid #ccc;">รีโหลด</button></div>`;
        };
    </script>

    <script type="text/babel">
        // --- 1. CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBnu9ZPf8ttxZl0gnbco7hk5WK7-ol3ckM",
            authDomain: "clinic-os-app.firebaseapp.com",
            projectId: "clinic-os-app",
            storageBucket: "clinic-os-app.firebasestorage.app",
            messagingSenderId: "292981574948",
            appId: "1:292981574948:web:800208558304ddc6d737b1",
            measurementId: "G-Z8S0QFZ8JG"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID = 'clinic_main_db'; // ใช้ ID หลักเพื่อเก็บข้อมูลถาวร

        // --- 2. COMPONENTS ---
        const { useState, useEffect } = React;

        const Icon = ({ d, className="" }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{d}</svg>;
        const Icons = {
            Activity: <Icon d={<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>} />,
            Users: <Icon d={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></>} />,
            Clipboard: <Icon d={<><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></>} />,
            UserPlus: <Icon d={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></>} />,
            Steth: <Icon d={<><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></>} />,
            Bag: <Icon d={<><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></>} />,
            History: <Icon d={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></>} />,
            Menu: <Icon d={<><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></>} />,
            Check: <Icon d={<polyline points="20 6 9 17 4 12"/>} />,
            Ambulance: <Icon d={<><rect x="1" y="3" width="22" height="13" rx="2" ry="2"/><path d="M8 8h8"/><path d="M12 6v4"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></>} />,
            Trash: <Icon d={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Edit: <Icon d={<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>} />,
            Printer: <Icon d={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>} />,
            UserCheck: <Icon d={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></>} />,
            Phone: <Icon d={<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>} />
        };

        const MED_DB = [
            { name: "Paracetamol 500mg", unit: "เม็ด", stdDose: 1, stdFreq: 4, timing: "เวลาปวด/มีไข้" },
            { name: "Amoxicillin 500mg", unit: "แคปซูล", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร" },
            { name: "CPM 4mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร" },
            { name: "Omeprazole 20mg", unit: "แคปซูล", stdDose: 1, stdFreq: 2, timing: "ก่อนอาหาร" },
            { name: "Para Syrup (เด็ก)", unit: "ขวด", stdDose: 1, stdFreq: 4, timing: "เวลาปวด/มีไข้", calc: { type: 'syrup', mgPerKg: 10, mgPerUnit: 24 } },
            { name: "Amox Syrup (เด็ก)", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "ก่อนอาหาร", calc: { type: 'syrup', mgPerKg: 20, mgPerUnit: 25 } },
            { name: "ORS", unit: "ซอง", stdDose: 1, stdFreq: 1, timing: "จิบทีละน้อย" }
        ];

        // --- 3. MAIN APP ---
        function App() {
            const [view, setView] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            
            // Data & Cache
            const [patients, setPatients] = useState([]);
            const [masterDB, setMasterDB] = useState({}); // ใช้ Object เพื่อการค้นหาที่เร็วขึ้น (Key = ID Card)

            // Forms
            const [newPatient, setNewPatient] = useState({ idCard: '', name: '', age: '', gender: 'ชาย', phone: '', address: '', disease: '', allergy: '' });
            const [isOldPatient, setIsOldPatient] = useState(false);
            
            // Clinical Forms
            const [selectedId, setSelectedId] = useState(null);
            const [screenData, setScreenData] = useState({ bp: '', temp: '', weight: '', symptom: '' });
            const [doctorData, setDoctorData] = useState({ diagnosis: '', prescription: '' });
            
            // Modals
            const [showMedModal, setShowMedModal] = useState(false);
            const [currentMed, setCurrentMed] = useState(null);
            const [medCalc, setMedCalc] = useState({ dose: 1, freq: 3, days: 3 });

            // --- INIT ---
            useEffect(() => {
                const init = async () => {
                    await auth.signInAnonymously();
                    
                    // 1. Queue Listener
                    db.collection('artifacts').doc(APP_ID).collection('queue')
                        .onSnapshot(snap => {
                            const list = snap.docs.map(d => ({id: d.id, ...d.data()}));
                            list.sort((a,b) => a.queue.localeCompare(b.queue));
                            setPatients(list);
                            setLoading(false);
                        });

                    // 2. Profile Listener (สำคัญ: ดึงข้อมูลคนไข้เก่า)
                    db.collection('artifacts').doc(APP_ID).collection('profiles')
                        .onSnapshot(snap => {
                            const profiles = {};
                            snap.docs.forEach(doc => {
                                profiles[doc.id] = doc.data(); // เก็บ ID Card เป็น Key
                            });
                            setMasterDB(profiles);
                        });
                };
                init();
            }, []);

            // --- AUTO-RETRIEVE LOGIC (ระบบจำคนไข้) ---
            useEffect(() => {
                if (newPatient.idCard && newPatient.idCard.length === 13) {
                    const oldData = masterDB[newPatient.idCard];
                    if (oldData) {
                        setNewPatient({ ...oldData }); // เติมข้อมูลลงฟอร์ม
                        setIsOldPatient(true);
                    } else {
                        setIsOldPatient(false);
                    }
                }
            }, [newPatient.idCard, masterDB]);

            // --- ACTIONS ---
            const getPatient = () => patients.find(p => p.id === selectedId);
            const count = (s) => patients.filter(p => p.status === s).length;
            
            const handleRegister = async () => {
                if(!newPatient.name) return alert("กรุณากรอกชื่อ");
                
                // 1. บันทึกเข้า Master DB (เพื่อให้จำได้ครั้งหน้า)
                if(newPatient.idCard) {
                    await db.collection('artifacts').doc(APP_ID).collection('profiles').doc(newPatient.idCard).set(newPatient, {merge: true});
                }

                // 2. ส่งเข้าคิว
                const nextQ = `A${String(patients.length + 1).padStart(3, '0')}`;
                await db.collection('artifacts').doc(APP_ID).collection('queue').add({
                    ...newPatient,
                    queue: nextQ,
                    status: 'screening',
                    time: new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}),
                    screening: {}, meds: {}
                });

                setNewPatient({ idCard: '', name: '', age: '', gender: 'ชาย', phone: '', address: '', disease: '', allergy: '' });
                alert(`ลงทะเบียนสำเร็จ ${nextQ}`);
                setView('screening');
            };

            const updateStatus = async (pid, status, extra = {}) => {
                await db.collection('artifacts').doc(APP_ID).collection('queue').doc(pid).update({ status, ...extra });
                setSelectedId(null);
            };

            const handleDelete = async (pid) => {
                if(confirm("ลบรายการนี้?")) await db.collection('artifacts').doc(APP_ID).collection('queue').doc(pid).delete();
            };

            // Medicine
            const handleMedClick = (m) => {
                setCurrentMed(m);
                let d = m.stdDose || 1;
                // Auto calc syrup
                const w = parseFloat(doctorData.weight || getPatient()?.screening?.weight || 0);
                if(m.calc && w && m.calc.type === 'syrup') {
                     d = Math.round((w * m.calc.mgPerKg / m.calc.mgPerUnit)*10)/10;
                }
                setMedCalc({ dose: d, freq: m.stdFreq || 3, days: 3 });
                setShowMedModal(true);
            };
            const confirmMed = () => {
                const total = Math.ceil(medCalc.dose * medCalc.freq * medCalc.days);
                const unit = ['ขวด','หลอด','ซอง'].includes(currentMed.unit) ? currentMed.unit : 'เม็ด';
                const line = `- ${currentMed.name}\n  จ่าย: ${total} ${unit} | ครั้งละ ${medCalc.dose} ${medCalc.doseUnit||unit} วันละ ${medCalc.freq} ครั้ง ${currentMed.timing||''}`;
                setDoctorData(p => ({ ...p, prescription: p.prescription ? p.prescription + '\n' + line : line }));
                setShowMedModal(false);
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-blue-600 font-bold">กำลังเชื่อมต่อ...</div>;

            // --- UI RENDER ---
            const SidebarBtn = ({ id, label, icon, badge }) => (
                <button onClick={() => { setView(id); setSidebarOpen(false); }} className={`w-full flex items-center justify-between p-3 rounded mb-1 transition ${view === id ? 'bg-blue-600 text-white' : 'text-slate-600 hover:bg-slate-200'}`}>
                    <div className="flex items-center gap-3">{icon} <span>{label}</span></div>
                    {badge > 0 && <span className="bg-red-500 text-white text-xs px-2 py-1 rounded-full">{badge}</span>}
                </button>
            );

            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden">
                    {/* Modal */}
                    {showMedModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
                        <div className="bg-white rounded-xl w-full max-w-sm p-4 space-y-3">
                            <h3 className="font-bold text-lg">{currentMed?.name}</h3>
                            <div className="grid grid-cols-3 gap-2 text-center">
                                <div><label className="text-xs">ครั้งละ</label><input type="number" className="w-full border p-1 text-center" value={medCalc.dose} onChange={e=>setMedCalc({...medCalc, dose:e.target.value})}/></div>
                                <div><label className="text-xs">วันละ</label><input type="number" className="w-full border p-1 text-center" value={medCalc.freq} onChange={e=>setMedCalc({...medCalc, freq:e.target.value})}/></div>
                                <div><label className="text-xs">วัน</label><input type="number" className="w-full border p-1 text-center" value={medCalc.days} onChange={e=>setMedCalc({...medCalc, days:e.target.value})}/></div>
                            </div>
                            <div className="flex justify-end gap-2"><button onClick={()=>setShowMedModal(false)} className="border px-3 rounded">ยกเลิก</button><button onClick={confirmMed} className="bg-blue-600 text-white px-3 rounded">เพิ่ม</button></div>
                        </div>
                    </div>}

                    {/* Sidebar */}
                    <div className={`fixed inset-y-0 z-40 w-64 bg-white shadow-lg transform transition ${sidebarOpen?'translate-x-0':'-translate-x-full'} lg:translate-x-0`}>
                        <div className="p-6 border-b text-xl font-bold text-blue-600 flex gap-2 items-center">{Icons.Activity} Clinic OS</div>
                        <div className="p-4 space-y-1">
                            <SidebarBtn id="dashboard" label="ภาพรวม" icon={Icons.Activity} />
                            <SidebarBtn id="register" label="ลงทะเบียน" icon={Icons.UserPlus} />
                            <SidebarBtn id="screening" label="คัดกรอง" icon={Icons.Clipboard} badge={count('screening')} />
                            <SidebarBtn id="doctor" label="ห้องตรวจ" icon={Icons.Steth} badge={count('waiting')} />
                            <SidebarBtn id="pharmacy" label="ห้องจ่ายยา" icon={Icons.Bag} badge={count('pharmacy')} />
                            <SidebarBtn id="referral" label="ส่งต่อ" icon={Icons.Ambulance} badge={count('referral')} />
                            <SidebarBtn id="history" label="ประวัติ" icon={Icons.History} />
                        </div>
                    </div>

                    {/* Main */}
                    <div className="flex-1 flex flex-col h-screen lg:ml-64">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-4 shadow-sm shrink-0 no-print">
                            <button onClick={()=>setSidebarOpen(!sidebarOpen)} className="lg:hidden">{Icons.Menu}</button>
                            <div className="font-bold text-slate-700">ศูนย์อพยพอาคารวีสมหมาย</div>
                        </header>
                        
                        <div className="flex-1 overflow-auto p-4 md:p-6">
                            
                            {/* Dashboard */}
                            {view === 'dashboard' && <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="bg-white p-4 rounded shadow border-l-4 border-orange-500"><div>รอคัดกรอง</div><div className="text-2xl font-bold">{count('screening')}</div></div>
                                <div className="bg-white p-4 rounded shadow border-l-4 border-blue-500"><div>รอตรวจ</div><div className="text-2xl font-bold">{count('waiting')}</div></div>
                                <div className="bg-white p-4 rounded shadow border-l-4 border-purple-500"><div>รอรับยา</div><div className="text-2xl font-bold">{count('pharmacy')}</div></div>
                                <div className="bg-white p-4 rounded shadow border-l-4 border-green-500"><div>เสร็จสิ้น</div><div className="text-2xl font-bold">{count('completed')}</div></div>
                            </div>}

                            {/* Register */}
                            {view === 'register' && <div className="max-w-lg mx-auto bg-white p-6 rounded shadow space-y-3">
                                <h2 className="text-lg font-bold text-blue-600 flex gap-2">{Icons.UserPlus} ลงทะเบียน</h2>
                                
                                {/* Auto-Retrieve Indicator */}
                                {isOldPatient && <div className="bg-green-100 text-green-800 p-3 rounded flex items-center gap-2 border border-green-200 animate-bounce">
                                    {Icons.UserCheck} <b>พบประวัติเก่า!</b> ดึงข้อมูลเรียบร้อย
                                </div>}

                                <input className="w-full border p-2 rounded" placeholder="เลขบัตร (13 หลัก) *" value={newPatient.idCard} onChange={e=>setNewPatient({...newPatient, idCard:e.target.value})} maxLength="13"/>
                                <input className="w-full border p-2 rounded" placeholder="ชื่อ-สกุล *" value={newPatient.name} onChange={e=>setNewPatient({...newPatient, name:e.target.value})} />
                                <div className="grid grid-cols-2 gap-2">
                                    <input className="w-full border p-2 rounded" placeholder="อายุ" value={newPatient.age} onChange={e=>setNewPatient({...newPatient, age:e.target.value})} />
                                    <select className="w-full border p-2 rounded" value={newPatient.gender} onChange={e=>setNewPatient({...newPatient, gender:e.target.value})}><option>ชาย</option><option>หญิง</option></select>
                                </div>
                                <input className="w-full border p-2 rounded" placeholder="เบอร์โทร" value={newPatient.phone} onChange={e=>setNewPatient({...newPatient, phone:e.target.value})} />
                                <textarea className="w-full border p-2 rounded" placeholder="ที่อยู่" value={newPatient.address} onChange={e=>setNewPatient({...newPatient, address:e.target.value})}></textarea>
                                <div className="grid grid-cols-2 gap-2">
                                    <input className="border p-2 rounded" placeholder="โรคประจำตัว" value={newPatient.disease} onChange={e=>setNewPatient({...newPatient, disease:e.target.value})} />
                                    <input className="border p-2 rounded text-red-600" placeholder="แพ้ยา" value={newPatient.allergy} onChange={e=>setNewPatient({...newPatient, allergy:e.target.value})} />
                                </div>
                                <button onClick={handleRegister} className="w-full bg-blue-600 text-white p-3 rounded font-bold">บันทึกและส่งคัดกรอง</button>
                            </div>}

                            {/* Screening */}
                            {view === 'screening' && <div className="flex flex-col md:flex-row gap-4 h-full">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-y-auto">
                                    <div className="p-3 bg-orange-100 font-bold text-orange-800">คิวรอคัดกรอง</div>
                                    {patients.filter(p=>p.status==='screening').map(p=><div key={p.id} onClick={()=>{setSelectedId(p.id); setScreenData({...p.screening})}} className="p-3 border-b hover:bg-orange-50 cursor-pointer flex justify-between"><span>{p.queue} {p.name}</span><button onClick={(e)=>{e.stopPropagation();handleDelete(p.id)}} className="text-red-500">{Icons.Trash}</button></div>)}
                                </div>
                                <div className="flex-1 bg-white rounded shadow p-6">
                                    {selectedId ? <div>
                                        <h3 className="font-bold text-lg mb-4">{getPatient()?.name}</h3>
                                        {getPatient()?.allergy && <div className="bg-red-100 text-red-800 p-2 rounded mb-2">แพ้: {getPatient().allergy}</div>}
                                        <div className="grid grid-cols-4 gap-2 mb-4">
                                            <input className="border p-2 rounded" placeholder="BP" value={screenData.bp} onChange={e=>setScreenData({...screenData, bp:e.target.value})} />
                                            <input className="border p-2 rounded" placeholder="T" value={screenData.temp} onChange={e=>setScreenData({...screenData, temp:e.target.value})} />
                                            <input className="border p-2 rounded" placeholder="P" value={screenData.pulse} onChange={e=>setScreenData({...screenData, pulse:e.target.value})} />
                                            <input className="border p-2 rounded" placeholder="Wt" value={screenData.weight} onChange={e=>setScreenData({...screenData, weight:e.target.value})} />
                                        </div>
                                        <textarea className="w-full border p-2 rounded mb-4" placeholder="อาการ (CC)..." value={screenData.symptom} onChange={e=>setScreenData({...screenData, symptom:e.target.value})}></textarea>
                                        <button onClick={()=>updateStatus(selectedId, 'waiting', {screening: screenData})} className="w-full bg-orange-500 text-white p-3 rounded font-bold">ส่งห้องตรวจ</button>
                                    </div> : <div className="text-center mt-10 text-gray-400">เลือกผู้ป่วย</div>}
                                </div>
                            </div>}

                            {/* Doctor */}
                            {view === 'doctor' && <div className="flex flex-col md:flex-row gap-4 h-full">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-y-auto">
                                    <div className="p-3 bg-blue-100 font-bold text-blue-800">คิวรอตรวจ</div>
                                    {patients.filter(p=>p.status==='waiting').map(p=><div key={p.id} onClick={()=>{setSelectedId(p.id); setDoctorData({diagnosis:p.diagnosis||'', prescription:p.prescription||''})}} className="p-3 border-b hover:bg-blue-50 cursor-pointer">{p.queue} {p.name}</div>)}
                                </div>
                                <div className="flex-1 bg-white rounded shadow p-6 overflow-y-auto">
                                    {selectedId ? <div>
                                        <h3 className="font-bold text-lg mb-2">{getPatient()?.name}</h3>
                                        <div className="bg-slate-50 p-2 rounded text-sm mb-4">CC: {getPatient()?.screening?.symptom} <br/> BP: {getPatient()?.screening?.bp} T: {getPatient()?.screening?.temp} Wt: {getPatient()?.screening?.weight}</div>
                                        <textarea className="w-full border p-2 rounded mb-2" placeholder="วินิจฉัย..." rows="2" value={doctorData.diagnosis} onChange={e=>setDoctorData({...doctorData, diagnosis:e.target.value})}></textarea>
                                        <div className="mb-2">
                                            <div className="flex gap-2 mb-1 overflow-x-auto pb-2">{MED_DB.map((m,i)=><button key={i} onClick={()=>handleMedClick(m)} className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded whitespace-nowrap border hover:bg-blue-100">{m.name}</button>)}</div>
                                            <textarea className="w-full border p-2 rounded font-mono text-sm" rows="4" placeholder="รายการยา..." value={doctorData.prescription} onChange={e=>setDoctorData({...doctorData, prescription:e.target.value})}></textarea>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={()=>updateStatus(selectedId, 'pharmacy', doctorData)} className="flex-1 bg-green-600 text-white p-3 rounded font-bold">บันทึก</button>
                                            <button onClick={()=>updateStatus(selectedId, 'referral', doctorData)} className="px-4 bg-red-500 text-white rounded font-bold">ส่งตัว</button>
                                        </div>
                                    </div> : <div className="text-center mt-10 text-gray-400">เลือกผู้ป่วย</div>}
                                </div>
                            </div>}

                            {/* Pharmacy */}
                            {view === 'pharmacy' && <div className="flex flex-col md:flex-row gap-4 h-full">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-y-auto">
                                    <div className="p-3 bg-purple-100 font-bold text-purple-800">รอจ่ายยา</div>
                                    {patients.filter(p=>p.status==='pharmacy').map(p=><div key={p.id} onClick={()=>setSelectedId(p.id)} className="p-3 border-b hover:bg-purple-50 cursor-pointer">{p.queue} {p.name}</div>)}
                                </div>
                                <div className="flex-1 bg-white rounded shadow p-6">
                                    {selectedId ? <div>
                                        <h3 className="font-bold text-lg mb-2">{getPatient()?.name}</h3>
                                        <div className="bg-gray-50 p-2 rounded mb-2 text-sm">Dx: {getPatient()?.diagnosis}</div>
                                        <pre className="border p-2 rounded font-mono whitespace-pre-wrap mb-4 bg-yellow-50">{getPatient()?.prescription}</pre>
                                        <div className="flex gap-2">
                                            <button onClick={()=>window.print()} className="flex-1 border p-3 rounded">พิมพ์ฉลาก</button>
                                            <button onClick={()=>updateStatus(selectedId, 'completed')} className="flex-1 bg-purple-600 text-white p-3 rounded font-bold">จ่ายยา</button>
                                        </div>
                                        <div className="print-only border p-4 mt-4">
                                            <h3 className="text-center font-bold">ฉลากยา</h3>
                                            <p>คนไข้: {getPatient()?.name}</p>
                                            <pre>{getPatient()?.prescription}</pre>
                                        </div>
                                    </div> : <div className="text-center mt-10 text-gray-400">เลือกรายการ</div>}
                                </div>
                            </div>}

                            {/* Referral */}
                            {view === 'referral' && <div className="flex flex-col md:flex-row gap-4 h-full">
                                <div className="w-full md:w-1/3 bg-white rounded shadow overflow-y-auto no-print">
                                    <div className="p-3 bg-red-100 font-bold text-red-800">รอส่งตัว</div>
                                    {patients.filter(p=>p.status==='referral').map(p=><div key={p.id} onClick={()=>setSelectedId(p.id)} className="p-3 border-b hover:bg-red-50 cursor-pointer">{p.name}</div>)}
                                </div>
                                <div className="flex-1 bg-white rounded shadow p-8 print:shadow-none">
                                    {selectedId ? <div className="print-container">
                                        <div className="text-center border-b pb-4 mb-4"><h1 className="text-2xl font-bold">ใบส่งตัวผู้ป่วย</h1><p>ศูนย์อพยพอาคารวีสมหมาย</p></div>
                                        <div className="grid grid-cols-2 gap-4 mb-4"><div><strong>ชื่อ:</strong> {getPatient()?.name}</div><div><strong>อายุ:</strong> {getPatient()?.age}</div></div>
                                        <div className="border p-4 rounded mb-4"><p><strong>วินิจฉัย:</strong> {getPatient()?.diagnosis}</p><p><strong>การรักษา:</strong> {getPatient()?.prescription}</p></div>
                                        <div className="mt-10 text-right print-only"><p>.......................................</p><p>(แพทย์ผู้ส่งตัว)</p></div>
                                        <div className="mt-6 flex gap-2 no-print"><button onClick={()=>window.print()} className="bg-blue-600 text-white px-4 py-2 rounded">พิมพ์</button><button onClick={()=>updateStatus(selectedId, 'completed')} className="bg-green-600 text-white px-4 py-2 rounded">จบงาน</button></div>
                                    </div> : <div className="text-center mt-10 no-print">เลือกผู้ป่วย</div>}
                                </div>
                            </div>}
                            
                            {/* History */}
                            {view === 'history' && <div className="bg-white rounded shadow overflow-hidden">
                                <table className="w-full text-left"><thead className="bg-gray-100 border-b"><tr><th className="p-3">เวลา</th><th className="p-3">ชื่อ</th><th className="p-3">สถานะ</th><th className="p-3"></th></tr></thead><tbody>
                                    {patients.filter(p=>p.status==='completed'||p.status==='referral').map(p=><tr key={p.id} className="border-b"><td className="p-3">{p.time}</td><td className="p-3">{p.name}</td><td className="p-3">{p.status}</td><td className="p-3 text-right"><button onClick={()=>handleDelete(p.id)} className="text-red-500">{Icons.Trash}</button></td></tr>)}
                                </tbody></table>
                            </div>}

                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
