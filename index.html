<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic OS - ศูนย์อพยพอาคารวีสมหมาย ศรีสะเกษ</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            
            /* Referral Letter Configuration */
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }

            /* Drug Labels Configuration (Fixed) */
            #printable-labels, #printable-labels * { visibility: visible; }
            #printable-labels { 
                visibility: visible !important;
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                background: white; 
                padding: 0;
                margin: 0;
                display: grid !important;
                grid-template-columns: 1fr 1fr; /* 2 columns for stickers */
                gap: 10px;
            }
            #printable-labels .border { border: 1px solid #000; } /* Ensure borders are visible */
            
            .no-print, .no-print * { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 0. ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return <div className="p-10 text-red-600 border m-4 rounded bg-red-50">
                        <h1 className="font-bold text-xl">⚠️ เกิดข้อผิดพลาด</h1>
                        <pre className="mt-2 text-sm">{this.state.error.toString()}</pre>
                        <button onClick={()=>window.location.reload()} className="mt-4 bg-red-600 text-white px-4 py-2 rounded">รีโหลดหน้าจอ</button>
                    </div>;
                }
                return this.props.children;
            }
        }

        // --- 1. FIREBASE CONFIG & INIT ---
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
             firebaseConfig = {
                apiKey: "AIzaSyBnu9ZPf8ttxZl0gnbco7hk5WK7-ol3ckM",
                authDomain: "clinic-os-app.firebaseapp.com",
                projectId: "clinic-os-app",
                storageBucket: "clinic-os-app.firebasestorage.app",
                messagingSenderId: "292981574948",
                appId: "1:292981574948:web:800208558304ddc6d737b1",
                measurementId: "G-Z8S0QFZ8JG"
            };
        }

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'clinic-os-production-v1';

        // --- 2. ICONS (SVG Direct) ---
        const Icons = {
            Activity: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            ClipboardList: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Stethoscope: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></svg>,
            ShoppingBag: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
            History: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            UserPlus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>,
            ClipboardCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            PlusCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>,
            Pill: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></svg>,
            Calculator: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Printer: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            Tag: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l5 5a2 2 0 0 0 2.828 0l7.172-7.172a2 2 0 0 0 0-2.828l-5-5z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></svg>,
            Clock3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16.5 12"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Edit3: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>,
            Globe: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            PieChart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            UserCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Loader2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Phone: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
            Ambulance: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle><path d="M10 8V14"></path><path d="M7 11H13"></path></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        };

        const { useState, useEffect, useRef } = React;

        // --- DATA & DB ---
        const INITIAL_MEDICINE_DB = [
            { code: "PARA500", name: "Paracetamol 500mg", unit: "เม็ด", stdDose: 1, stdFreq: 4, timing: "ทุก 4-6 ชม. เวลาปวดหรือมีไข้" },
            { code: "AMOX500", name: "Amoxicillin 500mg", unit: "แคปซูล", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร" },
            { code: "CPM", name: "Chlorpheniramine 4mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร" },
            { code: "OMEP20", name: "Omeprazole 20mg", unit: "แคปซูล", stdDose: 1, stdFreq: 2, timing: "ก่อนอาหาร" },
            { code: "METFOR500", name: "Metformin 500mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "หลังอาหารทันที" },
            { code: "AMLO5", name: "Amlodipine 5mg", unit: "เม็ด", stdDose: 1, stdFreq: 1, timing: "หลังอาหารเช้า" },
            { code: "ENAL5", name: "Enalapril 5mg", unit: "เม็ด", stdDose: 1, stdFreq: 1, timing: "หลังอาหาร" },
            { code: "LOSAR50", name: "Losartan 50mg", unit: "เม็ด", stdDose: 1, stdFreq: 1, timing: "หลังอาหาร" },
            { code: "SIMV20", name: "Simvastatin 20mg", unit: "เม็ด", stdDose: 1, stdFreq: 1, timing: "ก่อนนอน" },
            { code: "ATOR40", name: "Atorvastatin 40mg", unit: "เม็ด", stdDose: 1, stdFreq: 1, timing: "ก่อนนอน" },
            { code: "ALLO100", name: "Allopurinol 100mg", unit: "เม็ด", stdDose: 1, stdFreq: 1, timing: "หลังอาหาร" },
            { code: "COLCH0.6", name: "Colchicine 0.6mg", unit: "เม็ด", stdDose: 1, stdFreq: 2, timing: "หลังอาหาร" },
            { code: "DIAZ2", name: "Diazepam 2mg", unit: "เม็ด", stdDose: 1, stdFreq: 1, timing: "ก่อนนอน" },
            { code: "LORA0.5", name: "Lorazepam 0.5mg", unit: "เม็ด", stdDose: 1, stdFreq: 1, timing: "ก่อนนอน" },
            { code: "FLUO20", name: "Fluoxetine 20mg", unit: "แคปซูล", stdDose: 1, stdFreq: 1, timing: "หลังอาหารเช้า" },
            { code: "AMI10", name: "Amitriptyline 10mg", unit: "เม็ด", stdDose: 1, stdFreq: 1, timing: "ก่อนนอน" },
            { code: "PARA_SYR", name: "Paracetamol Syrup", unit: "ขวด", stdDose: 1, stdFreq: 4, timing: "เวลาปวด/มีไข้", calc: { type: 'syrup', mgPerKg: 10, mgPerUnit: 24, doseUnit: 'ml' } },
            { code: "AMOX_SYR", name: "Amoxicillin Dry Syrup", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "ก่อนอาหาร", calc: { type: 'syrup', mgPerKg: 20, mgPerUnit: 25, doseUnit: 'ml' } },
            { code: "CPM_SYR", name: "CPM Syrup", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร", calc: { type: 'syrup', mgPerKg: 0.35, mgPerUnit: 0.4, doseUnit: 'ml' } },
            { code: "BROM_SYR", name: "Bromhexine Syrup", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร", calc: { type: 'syrup', mgPerKg: 0.2, mgPerUnit: 0.8, doseUnit: 'ml' } },
            { code: "DEXTRO_SYR", name: "Dextromethorphan Syrup", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร", calc: { type: 'syrup', mgPerKg: 10, mgPerUnit: 3, doseUnit: 'ml' } },
            { code: "SALBU_SYR", name: "Salbutamol Syrup", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "หลังอาหาร", calc: { type: 'syrup', mgPerKg: 0.1, mgPerUnit: 0.4, doseUnit: 'ml' } },
            { code: "DOM_SYR", name: "Domperidone Syrup", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "ก่อนอาหาร 15 นาที", calc: { type: 'syrup', mgPerKg: 0.3, mgPerUnit: 1, doseUnit: 'ml' } },
            { code: "SIMET80", name: "Simethicone 80mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "เคี้ยวเวลาท้องอืด" },
            { code: "DOM10", name: "Domperidone 10mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "ก่อนอาหาร 15 นาที" },
            { code: "HYOS10", name: "Hyoscine (Buscopan) 10mg", unit: "เม็ด", stdDose: 1, stdFreq: 3, timing: "เวลาปวดเกร็ง" },
            { code: "CARBON", name: "Activated Charcoal", unit: "แคปซูล", stdDose: 2, stdFreq: 3, timing: "ทานห่างยาอื่น 2 ชม." },
            { code: "LOPER2", name: "Loperamide 2mg", unit: "แคปซูล", stdDose: 1, stdFreq: 1, timing: "เมื่อมีอาการถ่ายเหลว" },
            { code: "ORS", name: "ORS Powder (ผงเกลือแร่)", unit: "ซอง", stdDose: 1, stdFreq: 1, timing: "จิบทีละน้อย", doseUnit: 'ซอง' },
            { code: "ALUM_MILK", name: "Alum Milk", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "ก่อนอาหาร", doseUnit: 'ช้อนโต๊ะ' },
            { code: "MOM", name: "Milk of Magnesia", unit: "ขวด", stdDose: 1, stdFreq: 1, timing: "ก่อนนอน", doseUnit: 'ช้อนโต๊ะ' },
            { code: "CURMIN", name: "Turmeric (ขมิ้นชัน)", unit: "แคปซูล", stdDose: 2, stdFreq: 4, timing: "หลังอาหาร" },
            { code: "DICKGL", name: "Diclofenac Gel", unit: "หลอด", stdDose: 1, stdFreq: 3, timing: "ทาบางๆ บริเวณปวด" },
            { code: "BETA_CREAM", name: "Betamethasone Cream", unit: "หลอด", stdDose: 1, stdFreq: 2, timing: "ทาบางๆ บริเวณผื่น" },
            { code: "TA_CREAM", name: "Triamcinolone Cream", unit: "ตลับ", stdDose: 1, stdFreq: 2, timing: "ทาบางๆ บริเวณผื่น" },
            { code: "CLOTRI_CREAM", name: "Clotrimazole Cream", unit: "หลอด", stdDose: 1, stdFreq: 2, timing: "ทาบริเวณเชื้อรา" },
            { code: "CALAMINE", name: "Calamine Lotion", unit: "ขวด", stdDose: 1, stdFreq: 3, timing: "ทาบรรเทาอาการคัน" },
            { code: "SILVER", name: "Silver Sulfadiazine Cream", unit: "กระปุก", stdDose: 1, stdFreq: 2, timing: "ทาแผลไฟไหม้" },
            { code: "PVIDINE", name: "Povidone Iodine", unit: "ขวด", stdDose: 1, stdFreq: 1, timing: "ใส่แผลสด" }
        ];

        const INITIAL_DIAGNOSIS_DB = [
            { code: "A09", name: "A09 - Gastroenteritis/Diarrhea (ท้องร่วง)" },
            { code: "A90", name: "A90 - Dengue fever (ไข้เลือดออก)" },
            { code: "B00", name: "B00 - Herpes simplex (เริม)" },
            { code: "B02", name: "B02 - Zoster (งูสวัด)" },
            { code: "B35", name: "B35 - Dermatophytosis (กลาก/เกลื้อน)" },
            { code: "E11", name: "E11 - Type 2 Diabetes (เบาหวาน)" },
            { code: "E78", name: "E78 - Dyslipidemia (ไขมันในเลือดสูง)" },
            { code: "H10", name: "H10 - Conjunctivitis (ตาแดง)" },
            { code: "I10", name: "I10 - Hypertension (ความดันโลหิตสูง)" },
            { code: "J00", name: "J00 - Common cold (ไข้หวัด)" },
            { code: "J01", name: "J01 - Acute sinusitis (ไซนัสอักเสบ)" },
            { code: "J02", name: "J02 - Acute pharyngitis (คออักเสบ)" },
            { code: "J03", name: "J03 - Acute tonsillitis (ทอนซิลอักเสบ)" },
            { code: "J06", name: "J06 - Acute URI (ติดเชื้อทางเดินหายใจส่วนบน)" },
            { code: "J18", name: "J18 - Pneumonia (ปอดอักเสบ)" },
            { code: "J20", name: "J20 - Acute bronchitis (หลอดลมอักเสบ)" },
            { code: "J30", name: "J30 - Allergic rhinitis (ภูมิแพ้จมูก)" },
            { code: "J45", name: "J45 - Asthma (หอบหืด)" },
            { code: "K21", name: "K21 - GERD (กรดไหลย้อน)" },
            { code: "K29", name: "K29 - Gastritis (โรคกระเพาะ)" },
            { code: "K30", name: "K30 - Dyspepsia (อาหารไม่ย่อย)" },
            { code: "K59.0", name: "K59.0 - Constipation (ท้องผูก)" },
            { code: "L02", name: "L02 - Abscess/Furuncle (ฝี)" },
            { code: "L03", name: "L03 - Cellulitis (เนื้อเยื่ออักเสบ)" },
            { code: "L20", name: "L20 - Atopic dermatitis (ผื่นภูมิแพ้)" },
            { code: "L30", name: "L30 - Contact dermatitis (ผื่นแพ้สัมผัส)" },
            { code: "L50", name: "L50 - Urticaria (ลมพิษ)" },
            { code: "M17", name: "M17 - Osteoarthritis of knee (ข้อเข่าเสื่อม)" },
            { code: "M54.2", name: "M54.2 - Neck pain (ปวดคอ)" },
            { code: "M54.5", name: "M54.5 - Low back pain (ปวดหลัง)" },
            { code: "M65", name: "M65 - Synovitis/Tenosynovitis (เอ็นอักเสบ)" },
            { code: "M79.1", name: "M79.1 - Myalgia (ปวดกล้ามเนื้อ)" },
            { code: "N30", name: "N30 - Cystitis (กระเพาะปัสสาวะอักเสบ)" },
            { code: "N39.0", name: "N39.0 - Urinary tract infection (ติดเชื้อทางเดินปัสสาวะ)" },
            { code: "R05", name: "R05 - Cough (ไอ)" },
            { code: "R10", name: "R10 - Abdominal pain (ปวดท้อง)" },
            { code: "R42", name: "R42 - Dizziness/Vertigo (เวียนหัว)" },
            { code: "R50", name: "R50 - Fever (ไข้)" },
            { code: "R51", name: "R51 - Headache (ปวดหัว)" },
            { code: "S00", name: "S00 - Superficial injury of head (บาดแผลที่ศีรษะ)" },
            { code: "S60", name: "S60 - Superficial injury of wrist/hand (บาดแผลที่มือ)" },
            { code: "T14", name: "T14 - Injury, unspecified (บาดเจ็บทั่วไป)" },
            { code: "W54", name: "W54 - Bitten or struck by dog (สุนัขกัด)" },
            { code: "Z00", name: "Z00 - General Checkup (ตรวจร่างกายทั่วไป)" }
        ];

        const todayDate = new Date().toISOString().split('T')[0];

        const DEMO_PATIENTS = [
            { name: "ทดสอบ ระบบ", age: 30, gender: "ชาย", status: "waiting", queue: "A001", time: "08:00", date: todayDate, idCard: "1111111111111", phone: "0812345678", screeningData: { symptom: "ทดสอบระบบ", bp: "120/80", temp: "36.5", pulse: "80", weight: "60" } }
        ];

        // --- COMPONENTS ---
        const SidebarItem = ({ icon, label, active, onClick, count }) => {
            const Icon = Icons[icon] || Icons.Activity;
            return (
                <button onClick={onClick} className={`w-full flex items-center justify-between p-3 rounded-lg transition-colors mb-1 ${active ? 'bg-blue-600 text-white shadow-md' : 'text-slate-600 hover:bg-slate-100'}`}>
                    <div className="flex items-center gap-3"><Icon size={20} /><span className="font-medium">{label}</span></div>
                    {count > 0 && <span className={`text-xs px-2 py-0.5 rounded-full ${active ? 'bg-white text-blue-600' : 'bg-red-500 text-white'}`}>{count}</span>}
                </button>
            );
        };

        const StatCard = ({ title, value, icon, color }) => {
            const Icon = Icons[icon] || Icons.Activity;
            return (
                <div className={`p-5 rounded-xl border ${color} bg-white shadow-sm flex items-center justify-between`}>
                    <div><p className="text-sm text-slate-500 mb-1">{title}</p><p className="text-2xl font-bold text-slate-800">{value}</p></div>
                    <div className="p-3 bg-slate-50 rounded-lg"><Icon size={24} className="opacity-80" /></div>
                </div>
            );
        };

        const InputGroup = ({ label, placeholder, value, onChange, type="text" }) => (
            <div className="mb-3">
                <label className="block text-xs font-bold text-slate-500 mb-1">{label}</label>
                <input type={type} className="w-full p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all" placeholder={placeholder} value={value} onChange={onChange} />
            </div>
        );

        // --- HELPER FOR DB PATHS (Strict Mode) ---
        const getCollection = (collectionName) => {
             return db.collection('artifacts').doc(appId).collection('public').doc('data').collection(collectionName);
        }

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [exportStart, setExportStart] = useState(new Date().toISOString().split('T')[0]);
            const [exportEnd, setExportEnd] = useState(new Date().toISOString().split('T')[0]);
            
            const [patients, setPatients] = useState([]);
            const [masterDB, setMasterDB] = useState([]);
            const [medicineList, setMedicineList] = useState(INITIAL_MEDICINE_DB);
            const [diagnosisList, setDiagnosisList] = useState(INITIAL_DIAGNOSIS_DB);

            const [newPatient, setNewPatient] = useState({ idCard: '', name: '', dob: '', age: '', gender: 'ชาย', phone: '', address: '', underlyingDisease: '', allergies: '' });
            const [isOldPatient, setIsOldPatient] = useState(false);
            const [screeningForm, setScreeningForm] = useState({ symptom: '', bp: '', temp: '', pulse: '', weight: '' });
            const [doctorVitals, setDoctorVitals] = useState({ symptom: '', bp: '', temp: '', weight: '', pulse: '' });
            const [examData, setExamData] = useState({ diagnosis: '', prescription: '' });
            const [pharmacyRx, setPharmacyRx] = useState('');

            const [selectedScreening, setSelectedScreening] = useState(null);
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [selectedPharmacy, setSelectedPharmacy] = useState(null);
            const [editingPatient, setEditingPatient] = useState(null);

            const [showMedModal, setShowMedModal] = useState(false);
            const [currentMed, setCurrentMed] = useState(null);
            const [medCalc, setMedCalc] = useState({ dose: 1, freq: 3, days: 3, total: 9, note: '', isCalculated: false, doseUnit: '' });
            const [showDiagModal, setShowDiagModal] = useState(false);
            const [customDiag, setCustomDiag] = useState({ code: '', name: '' });
            const [showLabelModal, setShowLabelModal] = useState(false);
            const [labelsToPrint, setLabelsToPrint] = useState([]);

            // Referral State
            const [showReferModal, setShowReferModal] = useState(false);
            const [referForm, setReferForm] = useState({ hospital: '', reason: '', urgency: 'ปกติ' });
            const [selectedReferral, setSelectedReferral] = useState(null);

            const [rxSearch, setRxSearch] = useState('');
            const [showRxList, setShowRxList] = useState(false);
            const [diagSearch, setDiagSearch] = useState('');
            const [showDiagList, setShowDiagList] = useState(false);

            // --- FIREBASE SYNC ---
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                         await auth.signInAnonymously();
                    }
                };
                initAuth().catch(e => console.error(e));

                return auth.onAuthStateChanged(u => { setUser(u); if(!u) setLoading(false); });
            }, []);

            useEffect(() => {
                if (!user) return;
                
                const unsubQueue = getCollection('daily_queue').onSnapshot(snap => {
                    const data = snap.docs.map(d => ({id:d.id, ...d.data()}));
                    data.sort((a,b)=>a.queue.localeCompare(b.queue));
                    setPatients(data);
                    setLoading(false);
                }, err => console.error(err));

                const unsubProfile = getCollection('patient_profiles').onSnapshot(snap => {
                    setMasterDB(snap.docs.map(d => d.data()));
                });
                return () => { unsubQueue(); unsubProfile(); };
            }, [user]);

            const getFilteredPatients = () => {
                return patients.filter(p => {
                    const pDate = p.date || new Date().toISOString().split('T')[0];
                    return pDate === selectedDate;
                });
            };

            const filteredPatients = getFilteredPatients();

            const calculateAge = (dob) => { if(!dob) return ''; const t=new Date(),b=new Date(dob); let a=t.getFullYear()-b.getFullYear(); if(t.getMonth()<b.getMonth()||(t.getMonth()===b.getMonth()&&t.getDate()<b.getDate())) a--; return a; };
            const handleDobChange = (e) => setNewPatient({ ...newPatient, dob: e.target.value, age: calculateAge(e.target.value) });

            useEffect(() => {
                if (newPatient.idCard.length === 13) {
                    const found = masterDB.find(p => p.idCard === newPatient.idCard);
                    if (found) { setNewPatient({ ...found }); setIsOldPatient(true); } else { setIsOldPatient(false); }
                }
            }, [newPatient.idCard, masterDB]);

            const dbQueue = () => getCollection('daily_queue');
            const dbProfiles = () => getCollection('patient_profiles');

            const handleLoadDemo = async () => {
                setLoading(true);
                try { 
                    for(let p of DEMO_PATIENTS) {
                        await dbQueue().add(p);
                        await dbProfiles().doc(p.idCard).set({
                            idCard: p.idCard, name: p.name, age: p.age, gender: p.gender, phone: p.phone, address: "ที่อยู่ตัวอย่าง", underlyingDisease: "", allergies: ""
                        }, {merge:true});
                    }
                    alert("โหลดข้อมูลตัวอย่างสำเร็จ!"); 
                } 
                catch(e) { alert(e.message); } finally { setLoading(false); }
            };

            const handleSaveProfile = async () => { if(user && newPatient.idCard) await dbProfiles().doc(newPatient.idCard).set(newPatient, {merge:true}); };
            const handleSendToQueue = async () => {
                if(!newPatient.name) return alert("กรุณากรอกชื่อ");
                await handleSaveProfile();
                
                // Get today's date to reset queue
                const today = new Date().toISOString().split('T')[0];
                // Filter patients for today only to count the queue
                const todayCount = patients.filter(p => p.date === today).length;
                const nextQueue = `A${String(todayCount + 1).padStart(3,'0')}`;

                await dbQueue().add({ 
                    ...newPatient, 
                    status: 'screening', 
                    queue: nextQueue, 
                    date: today,
                    time: new Date().toLocaleTimeString('th-TH', {hour:'2-digit',minute:'2-digit'}), 
                    screeningData: {} 
                });
                setNewPatient({idCard:'', name:'', dob:'', age:'', gender:'ชาย', phone:'', address:'', underlyingDisease: '', allergies: ''});
                alert(`ส่งคัดกรองเรียบร้อย คิว ${nextQueue}`); setActiveTab('screening');
            };

            const handleEditPatientClick = (e,p) => { e.stopPropagation(); setEditingPatient({...p}); };
            const handleSavePatientInfo = async () => { if(editingPatient) { await dbQueue().doc(editingPatient.id).update(editingPatient); setEditingPatient(null); } };
            const handleDeletePatient = async (e,p) => { e.stopPropagation(); if(confirm('ลบ?')) await dbQueue().doc(p.id).delete(); };
            const handleSelectForScreening = (p) => { setSelectedScreening(p); setScreeningForm({ symptom: '', bp: '', temp: '', pulse: '', weight: '', ...p.screeningData }); };
            const handleSaveScreening = async () => { await dbQueue().doc(selectedScreening.id).update({status: 'waiting', screeningData: screeningForm}); setSelectedScreening(null); };

            const handleSelectPatient = (p) => { 
                setSelectedPatient(p); 
                setExamData({diagnosis: p.diagnosis||'', prescription: p.treatment||''});
                setDoctorVitals({ symptom: p.screeningData?.symptom||'', bp: p.screeningData?.bp||'', temp: p.screeningData?.temp||'', pulse: p.screeningData?.pulse||'', weight: p.screeningData?.weight||'' });
            };
            const handleSaveTreatment = async () => {
                await dbQueue().doc(selectedPatient.id).update({ status: 'pharmacy', diagnosis: examData.diagnosis, treatment: examData.prescription, screeningData: {...selectedPatient.screeningData, ...doctorVitals} });
                setSelectedPatient(null); alert("ส่งห้องยาเรียบร้อย");
            };
            const handleSelectPharmacy = (p) => { setSelectedPharmacy(p); setPharmacyRx(p.treatment||''); };
            const handleDispense = async (p) => { await dbQueue().doc(p.id).update({status: 'completed', treatment: pharmacyRx}); setSelectedPharmacy(null); alert("จ่ายยาเรียบร้อย"); };

            // Referral Logic
            const handleOpenReferModal = () => { if(selectedPatient) setShowReferModal(true); };
            const handleConfirmReferral = async () => {
                if(!referForm.hospital) return alert('ระบุโรงพยาบาล');
                await dbQueue().doc(selectedPatient.id).update({
                    status: 'referred',
                    diagnosis: examData.diagnosis,
                    treatment: examData.prescription,
                    screeningData: {...selectedPatient.screeningData, ...doctorVitals},
                    referralData: referForm
                });
                setShowReferModal(false); setSelectedPatient(null); setReferForm({ hospital: '', reason: '', urgency: 'ปกติ' });
                alert("บันทึกการส่งต่อสำเร็จ");
            };
            const handleSelectReferral = (p) => { setSelectedReferral(p); };

            const handleMedClick = (m) => { setCurrentMed(m); initMedCalc(m); setShowMedModal(true); setRxSearch(''); setShowRxList(false); };
            const handleManualMedClick = () => { const m={code:'CUSTOM', name:rxSearch, unit:'เม็ด', desc:'ตามแพทย์สั่ง', isCustom:true}; setCurrentMed(m); initMedCalc(m); setShowMedModal(true); setShowRxList(false); };
            const initMedCalc = (med) => {
                let d=med.stdDose||1, f=med.stdFreq||3, dy=3, tot=9, calc=false;
                const weight = parseFloat(doctorVitals.weight || selectedPatient?.screeningData?.weight);
                if(med.calc && weight && med.calc.type==='syrup') { d=Math.round((weight*med.calc.mgPerKg/med.calc.mgPerUnit)*10)/10; calc=true; }
                if(['ขวด','หลอด','ตลับ','ซอง'].includes(med.unit)) tot=1; else tot=Math.ceil(d*f*dy);
                setMedCalc({dose:d, freq:f, days:dy, total:tot, note:med.timing||med.desc||'', isCalculated:calc, doseUnit:med.calc?.doseUnit||med.unit});
            };
            useEffect(() => { if(currentMed && !['ขวด','หลอด','ตลับ','ซอง'].includes(currentMed.unit)) setMedCalc(p=>({...p, total: Math.ceil(p.dose*p.freq*p.days)})); }, [medCalc.dose, medCalc.freq, medCalc.days, currentMed]);
            const handleAddUsageTag = (t) => setMedCalc(p=>({...p, note: `${p.note} ${t}`.trim()}));
            const confirmAddMedicine = () => {
                if(currentMed.isCustom) setMedicineList(prev=>[...prev, {...currentMed, code:`C-${Date.now()}`}]);
                let unit = medCalc.doseUnit==='ml'?'ซีซี':medCalc.doseUnit;
                let instr = `ทานครั้งละ ${medCalc.dose} ${unit} วันละ ${medCalc.freq} ครั้ง ${medCalc.note}`;
                const entry = `- ${currentMed.name}\n  จ่าย: ${medCalc.total} ${currentMed.unit} | ${instr}`;
                setExamData(p=>({...p, prescription: p.prescription?p.prescription+'\n'+entry:entry}));
                setShowMedModal(false);
            };

            const handleManualDiagClick = () => { setCustomDiag({code:'', name:diagSearch}); setShowDiagModal(true); setShowDiagList(false); };
            const handleSaveCustomDiag = () => {
                setDiagnosisList(prev=>[...prev, {code: customDiag.code||"USER", name:customDiag.name}]);
                const str = `${customDiag.code} - ${customDiag.name}`;
                setExamData(prev=>({...prev, diagnosis: prev.diagnosis?prev.diagnosis+'\n'+str:str}));
                setShowDiagModal(false); setDiagSearch('');
            };
            const handlePrintPreview = (p) => {
                const rx = pharmacyRx || p.treatment; if(!rx) return alert('ไม่มียา');
                const items = rx.split('\n- ').map((t,i) => { const txt = i===0&&t.startsWith('- ')?t.substring(2):t; const pts = txt.split('\n  '); return {name: pts[0], detail: pts[1]||''}; }).filter(i=>i.name);
                setLabelsToPrint({patient:p, items}); setShowLabelModal(true);
            };

            const exportToExcel = () => {
                const dataToExport = patients.filter(p => {
                    const pDate = p.date || p.time; 
                    return (!exportStart || p.date >= exportStart) && (!exportEnd || p.date <= exportEnd);
                });

                if (dataToExport.length === 0) return alert("ไม่พบข้อมูลในช่วงเวลาที่เลือก");

                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                // Updated Header with ALL fields
                csvContent += "วันที่,เวลา,คิว,ชื่อ-สกุล,เลขบัตร,วันเกิด,อายุ,เพศ,เบอร์โทร,ที่อยู่,โรคประจำตัว,แพ้ยา,อาการ(คัดกรอง),ความดัน,อุณหภูมิ,ชีพจร,น้ำหนัก,คำวินิจฉัย,การรักษา/ยา,สถานะ,โรงพยาบาลที่ส่งต่อ,สาเหตุการส่งต่อ,ความเร่งด่วน\n";

                dataToExport.forEach(row => {
                    const clean = (text) => text ? `"${text.replace(/"/g, '""').replace(/\n/g, ' ')}"` : "";
                    const rowData = [
                        row.date || "",
                        row.time || "",
                        row.queue || "",
                        clean(row.name),
                        `'${row.idCard || ""}`, // Add quote to prevent scientific notation in Excel
                        row.dob || "",
                        row.age || "",
                        row.gender || "",
                        `'${row.phone || ""}`,
                        clean(row.address),
                        clean(row.underlyingDisease),
                        clean(row.allergies),
                        clean(row.screeningData?.symptom),
                        clean(row.screeningData?.bp),
                        clean(row.screeningData?.temp),
                        clean(row.screeningData?.pulse),
                        clean(row.screeningData?.weight),
                        clean(row.diagnosis),
                        clean(row.treatment),
                        row.status || "",
                        clean(row.referralData?.hospital),
                        clean(row.referralData?.reason),
                        clean(row.referralData?.urgency)
                    ];
                    csvContent += rowData.join(",") + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `clinic_data_${exportStart}_to_${exportEnd}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            const screeningCount = patients.filter(p => p.status === 'screening').length;
            const waitingCount = patients.filter(p => p.status === 'waiting').length;
            const pharmacyCount = patients.filter(p => p.status === 'pharmacy').length;
            const referralCount = patients.filter(p => p.status === 'referred').length;
            const getDiseaseStats = () => {
                const stats = {};
                filteredPatients.forEach(p => { if (!p.diagnosis) return; const code = p.diagnosis.split(' ')[0].toUpperCase().charAt(0); let group = 'อื่นๆ'; if (code === 'J') group = 'ทางเดินหายใจ'; else if (['E', 'I'].includes(code)) group = 'NCDs'; stats[group] = (stats[group] || 0) + 1; });
                return Object.entries(stats).sort((a,b) => b[1] - a[1]); 
            };

            if(loading) return <div className="h-screen flex items-center justify-center text-blue-600 font-bold">กำลังเชื่อมต่อฐานข้อมูล...</div>;

            return (
                <div className="flex h-screen bg-slate-50 font-sans text-slate-800 overflow-hidden relative">
                    <ErrorBoundary>
                    {/* Modals */}
                    {showMedModal && currentMed && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"><div className="bg-white rounded-xl w-full max-w-sm overflow-hidden shadow-2xl"><div className={`p-4 text-white flex justify-between ${currentMed.isCustom?'bg-purple-600':(medCalc.isCalculated?'bg-green-600':'bg-blue-600')}`}><h3>{currentMed.isCustom?'เพิ่มยาเอง':'คำนวณ'}: {currentMed.name}</h3><button onClick={()=>setShowMedModal(false)}>✕</button></div><div className="p-4 space-y-4"><div className="grid grid-cols-3 gap-2 text-center"><div><label className="text-xs">ครั้งละ {medCalc.doseUnit==='ml'?'(ml)':''}</label><input type="number" step={medCalc.doseUnit==='ml'?"0.1":"0.5"} className="w-full border rounded p-1 text-center" value={medCalc.dose} onChange={e=>setMedCalc({...medCalc, dose:e.target.value})}/></div><div><label className="text-xs">วันละ (ครั้ง)</label><input type="number" className="w-full border rounded p-1 text-center" value={medCalc.freq} onChange={e=>setMedCalc({...medCalc, freq:e.target.value})}/></div><div><label className="text-xs">จำนวนวัน</label><input type="number" className="w-full border rounded p-1 text-center" value={medCalc.days} onChange={e=>setMedCalc({...medCalc, days:e.target.value})}/></div></div><div className="text-center font-bold text-blue-600 border bg-blue-50 p-2 rounded">รวม: {medCalc.total} {currentMed.unit}</div><div><label className="text-xs font-bold">เวลาทาน</label><div className="flex flex-wrap gap-1 mt-1">{['หลังอาหาร','ก่อนอาหาร','ก่อนนอน','เวลาปวด'].map(t=><button key={t} onClick={()=>handleAddUsageTag(t)} className="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-blue-50">{t}</button>)}</div></div><textarea className="w-full border rounded p-2 text-sm" rows="2" value={medCalc.note} onChange={e=>setMedCalc({...medCalc, note:e.target.value})}></textarea><button onClick={confirmAddMedicine} className="w-full bg-blue-600 text-white p-2 rounded font-bold">เพิ่มลงใบสั่ง</button></div></div></div>}
                    {showDiagModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"><div className="bg-white rounded-xl w-full max-w-sm p-4 space-y-3"><h3>เพิ่มโรคใหม่</h3><input className="w-full border p-2 rounded" placeholder="รหัส" value={customDiag.code} onChange={e=>setCustomDiag({...customDiag, code:e.target.value})}/><input className="w-full border p-2 rounded" placeholder="ชื่อโรค" value={customDiag.name} onChange={e=>setCustomDiag({...customDiag, name:e.target.value})}/><div className="flex justify-end gap-2"><button onClick={()=>setShowDiagModal(false)} className="border px-3 py-1 rounded">ยกเลิก</button><button onClick={handleSaveCustomDiag} className="bg-blue-600 text-white px-3 py-1 rounded">บันทึก</button></div></div></div>}
                    {showLabelModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4"><div className="bg-white p-6 rounded-xl w-full max-w-2xl h-[80vh] flex flex-col"><div className="flex justify-between mb-4 no-print"><h3 className="font-bold">พิมพ์ฉลากยา</h3><button onClick={()=>setShowLabelModal(false)}><Icons.X/></button></div><div id="printable-labels" className="flex-1 overflow-auto grid grid-cols-2 gap-4">{labelsToPrint.items.map((m,i)=><div key={i} className="border p-4 rounded text-center shadow-sm break-inside-avoid"><div className="text-sm font-bold text-slate-700">ศูนย์อพยพอาคารวีสมหมาย ศรีสะเกษ</div><div className="text-xs mb-2 text-slate-500">{labelsToPrint.patient.name}</div><div className="font-bold text-lg mb-1">{m.name}</div><div className="text-sm">{m.detail.split('|')[1]}</div></div>)}</div><div className="mt-4 flex justify-end no-print"><button onClick={()=>window.print()} className="bg-blue-600 text-white px-4 py-2 rounded flex gap-2 items-center"><Icons.Printer size={16}/> สั่งพิมพ์</button></div></div></div>}
                    {editingPatient && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"><div className="bg-white rounded-xl w-full max-w-md p-6 space-y-4"><h3 className="font-bold text-lg">แก้ไขข้อมูล</h3><InputGroup label="ชื่อ-สกุล" value={editingPatient.name} onChange={e=>setEditingPatient({...editingPatient, name:e.target.value})}/><InputGroup label="เบอร์โทร" value={editingPatient.phone} onChange={e=>setEditingPatient({...editingPatient, phone:e.target.value})}/><div className="grid grid-cols-1 gap-2"><label className="text-xs font-bold text-slate-500">การวินิจฉัย</label><textarea className="w-full p-2 border rounded" value={editingPatient.diagnosis||''} onChange={e=>setEditingPatient({...editingPatient, diagnosis:e.target.value})}></textarea></div><div className="grid grid-cols-1 gap-2"><label className="text-xs font-bold text-slate-500">การรักษา/ยา</label><textarea className="w-full p-2 border rounded" value={editingPatient.treatment||''} onChange={e=>setEditingPatient({...editingPatient, treatment:e.target.value})}></textarea></div>
                    {editingPatient.status === 'referred' && (
                        <div className="bg-red-50 p-3 rounded border border-red-100 space-y-2">
                            <label className="text-xs font-bold text-red-700">ข้อมูลการส่งต่อ</label>
                            <input className="w-full p-2 border rounded text-sm" placeholder="โรงพยาบาล" value={editingPatient.referralData?.hospital || ''} onChange={e=>setEditingPatient({...editingPatient, referralData: {...editingPatient.referralData, hospital: e.target.value}})} />
                            <input className="w-full p-2 border rounded text-sm" placeholder="สาเหตุ" value={editingPatient.referralData?.reason || ''} onChange={e=>setEditingPatient({...editingPatient, referralData: {...editingPatient.referralData, reason: e.target.value}})} />
                            <select className="w-full p-2 border rounded text-sm" value={editingPatient.referralData?.urgency || 'ปกติ'} onChange={e=>setEditingPatient({...editingPatient, referralData: {...editingPatient.referralData, urgency: e.target.value}})}>
                                <option>ปกติ</option><option>ด่วน</option><option>ด่วนมาก</option>
                            </select>
                        </div>
                    )}
                    <div className="flex justify-end gap-2"><button onClick={()=>setEditingPatient(null)} className="border px-4 py-2 rounded">ยกเลิก</button><button onClick={handleSavePatientInfo} className="bg-blue-600 text-white px-4 py-2 rounded">บันทึก</button></div></div></div>}
                    {showReferModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"><div className="bg-white rounded-xl w-full max-w-md p-6 space-y-4"><h3 className="font-bold text-lg text-red-600 flex gap-2 items-center"><Icons.Ambulance/> ส่งต่อผู้ป่วย</h3><InputGroup label="โรงพยาบาลปลายทาง" value={referForm.hospital} onChange={e=>setReferForm({...referForm, hospital:e.target.value})}/><InputGroup label="สาเหตุการส่งต่อ" value={referForm.reason} onChange={e=>setReferForm({...referForm, reason:e.target.value})}/><div><label className="text-xs font-bold text-slate-500">ความเร่งด่วน</label><select className="w-full p-2 border rounded" value={referForm.urgency} onChange={e=>setReferForm({...referForm, urgency:e.target.value})}><option>ปกติ</option><option>ด่วน</option><option>ด่วนมาก</option></select></div><div className="flex justify-end gap-2"><button onClick={()=>setShowReferModal(false)} className="border px-4 py-2 rounded">ยกเลิก</button><button onClick={handleConfirmReferral} className="bg-red-600 text-white px-4 py-2 rounded">ยืนยันการส่งต่อ</button></div></div></div>}

                    <aside className={`fixed lg:static inset-y-0 z-30 w-64 bg-white shadow-xl transform transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'} no-print`}>
                        <div className="p-6 border-b flex items-center gap-2"><Icons.Activity className="text-blue-600"/><span className="font-bold text-xl text-slate-800">Clinic OS</span></div>
                        <div className="p-4 space-y-1">
                            <SidebarItem icon="ClipboardList" label="แดชบอร์ด" active={activeTab==='dashboard'} onClick={()=>{setActiveTab('dashboard');setSidebarOpen(false)}} />
                            <div className="pt-4 pb-2 px-3 text-xs font-bold text-slate-400">ทะเบียน</div>
                            <SidebarItem icon="UserPlus" label="ลงทะเบียน" active={activeTab==='register'} onClick={()=>{setActiveTab('register');setSidebarOpen(false)}} />
                            <SidebarItem icon="ClipboardCheck" label="จุดคัดกรอง" count={screeningCount} active={activeTab==='screening'} onClick={()=>{setActiveTab('screening');setSidebarOpen(false)}} />
                            <div className="pt-4 pb-2 px-3 text-xs font-bold text-slate-400">รักษา</div>
                            <SidebarItem icon="Stethoscope" label="ห้องตรวจแพทย์" count={waitingCount} active={activeTab==='doctor'} onClick={()=>{setActiveTab('doctor');setSidebarOpen(false)}} />
                            <SidebarItem icon="ShoppingBag" label="ห้องจ่ายยา" count={pharmacyCount} active={activeTab==='pharmacy'} onClick={()=>{setActiveTab('pharmacy');setSidebarOpen(false)}} />
                            <SidebarItem icon="Ambulance" label="ส่งต่อผู้ป่วย" count={referralCount} active={activeTab==='referral'} onClick={()=>{setActiveTab('referral');setSidebarOpen(false)}} />
                            <div className="pt-4 pb-2 px-3 text-xs font-bold text-slate-400">ข้อมูล</div>
                            <SidebarItem icon="History" label="ประวัติการรักษา" active={activeTab==='history'} onClick={()=>{setActiveTab('history');setSidebarOpen(false)}} />
                            <SidebarItem icon="Download" label="ส่งออกข้อมูล" active={activeTab==='export'} onClick={()=>{setActiveTab('export');setSidebarOpen(false)}} />
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col h-screen overflow-hidden bg-slate-50">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm no-print"><button onClick={()=>setSidebarOpen(true)} className="lg:hidden"><Icons.Menu/></button><div className="text-right text-sm text-slate-500 font-bold">ศูนย์อพยพอาคารวีสมหมาย ศรีสะเกษ</div></header>
                        <div className="flex-1 overflow-auto p-6 relative">
                            {/* PRINT AREA */}
                            {selectedReferral && (
                                <div id="print-section" className="hidden bg-white p-8">
                                    <div className="text-center mb-6">
                                        <h1 className="font-bold text-2xl">ใบส่งต่อผู้ป่วย (Referral Letter)</h1>
                                        <p className="text-gray-600">หน่วยแพทย์เคลื่อนที่ ศูนย์อพยพอาคารวีสมหมาย จ.ศรีสะเกษ</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 mb-4 border-b pb-4">
                                        <div><strong>ชื่อ-สกุล:</strong> {selectedReferral.name}</div>
                                        <div><strong>อายุ:</strong> {selectedReferral.age} ปี <strong>เพศ:</strong> {selectedReferral.gender}</div>
                                        <div><strong>เลขบัตรประชาชน:</strong> {selectedReferral.idCard}</div>
                                        <div><strong>HN/Queue:</strong> {selectedReferral.queue}</div>
                                    </div>
                                    <div className="mb-4">
                                        <h3 className="font-bold underline mb-2">ข้อมูลเบื้องต้น (Vitals & Screening)</h3>
                                        <div className="grid grid-cols-4 gap-2 text-sm">
                                            <div><strong>BP:</strong> {selectedReferral.screeningData?.bp || '-'} mmHg</div>
                                            <div><strong>PR:</strong> {selectedReferral.screeningData?.pulse || '-'} /min</div>
                                            <div><strong>Temp:</strong> {selectedReferral.screeningData?.temp || '-'} C</div>
                                            <div><strong>BW:</strong> {selectedReferral.screeningData?.weight || '-'} kg</div>
                                        </div>
                                        <div className="mt-2"><strong>อาการสำคัญ:</strong> {selectedReferral.screeningData?.symptom}</div>
                                    </div>
                                    <div className="mb-4">
                                        <h3 className="font-bold underline mb-2">การวินิจฉัยและการรักษา (Diagnosis & Treatment)</h3>
                                        <div className="mb-2 whitespace-pre-line"><strong>Diagnosis:</strong><br/>{selectedReferral.diagnosis}</div>
                                        <div className="whitespace-pre-line"><strong>Treatment Given:</strong><br/>{selectedReferral.treatment || '-'}</div>
                                    </div>
                                    <div className="mb-6 border p-4 rounded">
                                        <h3 className="font-bold text-lg mb-2">ข้อมูลการส่งต่อ</h3>
                                        <div className="mb-2"><strong>ส่งต่อไปยัง:</strong> {selectedReferral.referralData?.hospital}</div>
                                        <div className="mb-2"><strong>เหตุผล:</strong> {selectedReferral.referralData?.reason}</div>
                                        <div><strong>ความเร่งด่วน:</strong> {selectedReferral.referralData?.urgency}</div>
                                    </div>
                                    <div className="flex justify-between mt-12 pt-8">
                                        <div className="text-center w-1/3 pt-8 border-t">ลงชื่อพยาบาลผู้ส่งต่อ</div>
                                        <div className="text-center w-1/3 pt-8 border-t">ลงชื่อแพทย์ผู้ตรวจ</div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'dashboard' && <div className="space-y-6"><div className="flex justify-between items-center"><div className="flex items-center gap-2"><span className="font-bold">วันที่:</span><input type="date" className="border p-2 rounded" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)}/></div><button onClick={handleLoadDemo} className="bg-white border p-2 rounded text-sm hover:bg-slate-50 flex gap-2 items-center"><Icons.RefreshCw size={14}/> Reset Demo Data</button></div><div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"><StatCard title="ผู้ป่วยทั้งหมด" value={filteredPatients.length} icon="Users" color="border-slate-200" /><StatCard title="รอคัดกรอง" value={screeningCount} icon="ClipboardCheck" color="border-orange-200" /><StatCard title="รอตรวจ" value={waitingCount} icon="User" color="border-blue-200" /><StatCard title="รอรับยา" value={pharmacyCount} icon="ShoppingBag" color="border-purple-200" /><StatCard title="ส่งต่อ" value={referralCount} icon="Ambulance" color="border-red-200" /></div><div><h3 className="font-bold mb-2">สถิติโรค (ประจำวันที่เลือก)</h3><div className="grid grid-cols-2 gap-4">{getDiseaseStats().length > 0 ? getDiseaseStats().map(([g,c])=><div key={g} className="bg-white p-3 rounded border flex justify-between"><span>{g}</span><span className="font-bold">{c}</span></div>) : <div className="text-gray-400 p-4 border rounded bg-white col-span-2 text-center">ไม่มีข้อมูลโรคในวันที่เลือก</div>}</div></div></div>}
                            
                            {activeTab === 'register' && <div className="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-sm border space-y-4"><h2 className="font-bold text-xl text-blue-600 flex gap-2"><Icons.UserPlus/> ลงทะเบียนผู้ป่วยใหม่</h2>{isOldPatient && <div className="bg-green-50 p-2 text-green-700 text-sm rounded flex items-center gap-2 border border-green-200"><Icons.UserCheck size={16}/> พบข้อมูลเก่าในระบบ</div>}<div className="grid grid-cols-2 gap-4"><InputGroup label="เลขบัตร (13 หลัก)" value={newPatient.idCard} onChange={e=>{const v=e.target.value.replace(/[^0-9]/g,''); if(v.length<=13)setNewPatient({...newPatient, idCard:v})}}/><InputGroup label="ชื่อ-สกุล" value={newPatient.name} onChange={e=>setNewPatient({...newPatient, name:e.target.value})}/><InputGroup label="เบอร์โทรศัพท์" value={newPatient.phone} onChange={e=>setNewPatient({...newPatient, phone:e.target.value})}/><div className="grid grid-cols-3 gap-2"><InputGroup label="วันเกิด" type="date" value={newPatient.dob} onChange={handleDobChange}/><InputGroup label="อายุ" type="number" value={newPatient.age} onChange={e=>setNewPatient({...newPatient, age:e.target.value})}/><div><label className="text-xs font-bold text-slate-500">เพศ</label><select className="w-full p-2.5 border rounded-lg bg-white" value={newPatient.gender} onChange={e=>setNewPatient({...newPatient, gender:e.target.value})}><option>ชาย</option><option>หญิง</option></select></div></div></div><InputGroup label="ที่อยู่" value={newPatient.address} onChange={e=>setNewPatient({...newPatient, address:e.target.value})}/><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500">โรคประจำตัว</label><textarea className="w-full p-2 border rounded-lg" rows="2" value={newPatient.underlyingDisease} onChange={e=>setNewPatient({...newPatient, underlyingDisease:e.target.value})}></textarea></div><div><label className="text-xs font-bold text-red-600">ประวัติแพ้ยา</label><textarea className="w-full p-2 border border-red-200 bg-red-50 rounded-lg text-red-700" rows="2" value={newPatient.allergies} onChange={e=>setNewPatient({...newPatient, allergies:e.target.value})}></textarea></div></div><button onClick={handleSendToQueue} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold shadow hover:bg-blue-700">ส่งคัดกรอง</button></div>}

                            {activeTab === 'screening' && <div className="flex flex-col lg:flex-row gap-4 h-full"><div className="w-full lg:w-1/3 bg-white border rounded-xl overflow-hidden flex flex-col"><div className="p-3 bg-orange-100 font-bold text-orange-800">คิวรอคัดกรอง</div><div className="flex-1 overflow-auto">{patients.filter(p=>p.status==='screening').map(p=><div key={p.id} onClick={()=>handleSelectForScreening(p)} className="p-3 border-b hover:bg-orange-50 cursor-pointer flex justify-between relative group"><span>{p.queue} {p.name} ({p.age} ปี)</span><div className="hidden group-hover:flex gap-1 absolute right-2 top-2"><button onClick={e=>handleEditPatientClick(e,p)} className="bg-white p-1 rounded border"><Icons.Edit size={12}/></button><button onClick={e=>handleDeletePatient(e,p)} className="bg-white p-1 rounded border text-red-500"><Icons.Trash2 size={12}/></button></div></div>)}</div></div><div className="flex-1 bg-white border rounded-xl p-6">{selectedScreening ? <div className="space-y-4"><h3 className="font-bold text-xl">คัดกรอง: {selectedScreening.name} ({selectedScreening.age} ปี)</h3>{(selectedScreening.allergies)&&<div className="text-red-600 font-bold bg-red-50 p-2 rounded border border-red-200">แพ้: {selectedScreening.allergies}</div>}<textarea className="w-full border p-2 rounded" placeholder="อาการ..." value={screeningForm.symptom} onChange={e=>setScreeningForm({...screeningForm, symptom:e.target.value})}/><div className="grid grid-cols-4 gap-2"><InputGroup label="BP" value={screeningForm.bp} onChange={e=>{let v=e.target.value;if(v.length===3&&v.length>(screeningForm.bp||'').length&&!v.includes('/'))v+='/';setScreeningForm({...screeningForm,bp:v})}}/><InputGroup label="Temp" value={screeningForm.temp} onChange={e=>setScreeningForm({...screeningForm, temp:e.target.value})}/><InputGroup label="Pulse" value={screeningForm.pulse} onChange={e=>setScreeningForm({...screeningForm, pulse:e.target.value})}/><InputGroup label="Weight" value={screeningForm.weight} onChange={e=>setScreeningForm({...screeningForm, weight:e.target.value})}/></div><button onClick={handleSaveScreening} className="w-full bg-orange-600 text-white p-3 rounded font-bold">ส่งตรวจ</button></div> : <div className="text-center text-gray-400 mt-20">เลือกผู้ป่วย</div>}</div></div>}

                            {activeTab === 'doctor' && <div className="flex flex-col lg:flex-row gap-4 h-full"><div className="w-full lg:w-1/3 bg-white border rounded-xl overflow-hidden flex flex-col"><div className="p-3 bg-blue-100 font-bold text-blue-800">คิวรอตรวจ</div><div className="flex-1 overflow-auto">{patients.filter(p=>p.status==='waiting').map(p=><div key={p.id} onClick={()=>handleSelectPatient(p)} className="p-3 border-b hover:bg-blue-50 cursor-pointer flex justify-between relative group"><span>{p.queue} {p.name} ({p.age} ปี)</span><button onClick={e=>handleEditPatientClick(e,p)} className="hidden group-hover:block bg-white p-1 rounded border absolute right-2 top-2"><Icons.Edit size={12}/></button></div>)}</div></div><div className="flex-1 bg-white border rounded-xl p-6 overflow-auto">{selectedPatient ? <div className="space-y-4"><div className="flex justify-between border-b pb-2"><div><h3 className="font-bold text-lg">{selectedPatient.name} ({selectedPatient.age} ปี)</h3><span className="text-sm text-slate-500">โทร: {selectedPatient.phone}</span></div><span className="text-blue-600 font-bold text-xl">{selectedPatient.queue}</span></div>{(selectedPatient.allergies)&&<div className="bg-red-100 text-red-800 p-2 rounded font-bold animate-pulse">⚠️ แพ้: {selectedPatient.allergies}</div>}<div className="grid grid-cols-4 gap-3"><div className="bg-indigo-50 p-3 rounded-lg border border-indigo-100 text-center shadow-sm"><div className="text-[10px] text-indigo-500 font-bold uppercase">ความดัน (BP)</div><div className="text-lg font-bold text-slate-700">{doctorVitals.bp || '-'}</div><div className="text-[10px] text-slate-400">mmHg</div></div><div className="bg-emerald-50 p-3 rounded-lg border border-emerald-100 text-center shadow-sm"><div className="text-[10px] text-emerald-500 font-bold uppercase">อุณหภูมิ (T)</div><div className="text-lg font-bold text-slate-700">{doctorVitals.temp || '-'}</div><div className="text-[10px] text-slate-400">°C</div></div><div className="bg-rose-50 p-3 rounded-lg border border-rose-100 text-center shadow-sm"><div className="text-[10px] text-rose-500 font-bold uppercase">ชีพจร (P)</div><div className="text-lg font-bold text-slate-700">{doctorVitals.pulse || '-'}</div><div className="text-[10px] text-slate-400">bpm</div></div><div className="bg-amber-50 p-3 rounded-lg border border-amber-100 text-center shadow-sm"><div className="text-[10px] text-amber-500 font-bold uppercase">น้ำหนัก (W)</div><div className="text-lg font-bold text-slate-700">{doctorVitals.weight || '-'}</div><div className="text-[10px] text-slate-400">kg</div></div></div><div><label className="font-bold">อาการ</label><textarea className="w-full border p-2 rounded" rows="2" value={doctorVitals.symptom} onChange={e=>setDoctorVitals({...doctorVitals, symptom:e.target.value})}/></div><div><div className="flex justify-between"><label className="font-bold">วินิจฉัย</label><button onClick={()=>setShowDiagList(!showDiagList)} className="text-xs text-blue-600">ค้นหา</button></div>{showDiagList && <div className="border p-2 max-h-32 overflow-auto mb-2"><input className="w-full border p-1 mb-1" placeholder="ค้นหา..." value={diagSearch} onChange={e=>setDiagSearch(e.target.value)}/>{diagnosisList.filter(d=>d.name.includes(diagSearch)).map(d=><div key={d.code} onClick={()=>{setExamData(p=>({...p, diagnosis:p.diagnosis+'\n'+d.code+' '+d.name}));setShowDiagList(false)}} className="cursor-pointer hover:bg-blue-50 text-sm p-1">{d.name}</div>)}<div onClick={handleManualDiagClick} className="text-center text-blue-600 cursor-pointer font-bold">+ เพิ่มเอง</div></div>}<textarea className="w-full border p-2 rounded" rows="2" value={examData.diagnosis} onChange={e=>setExamData({...examData, diagnosis:e.target.value})}/></div><div><div className="flex justify-between"><label className="font-bold">สั่งยา</label><button onClick={()=>setShowRxList(!showRxList)} className="text-xs text-blue-600">ค้นหา</button></div>{showRxList && <div className="border p-2 max-h-40 overflow-auto mb-2"><div className="flex gap-2 mb-1"><input className="w-full border p-1" placeholder="ค้นหา..." value={rxSearch} onChange={e=>setRxSearch(e.target.value)}/><button onClick={handleManualMedClick} className="bg-blue-100 px-2 rounded font-bold text-xs">+</button></div>{medicineList.filter(d=>d.name.toLowerCase().includes(rxSearch.toLowerCase())).map(m=><div key={m.code} onClick={()=>handleMedClick(m)} className="cursor-pointer hover:bg-blue-50 p-1 border-b text-sm flex justify-between"><span>{m.name}</span><Icons.Calculator size={12}/></div>)}</div>}<textarea className="w-full border p-2 rounded" rows="4" value={examData.prescription} onChange={e=>setExamData({...examData, prescription:e.target.value})}/></div><div className="grid grid-cols-3 gap-2"><button onClick={handleOpenReferModal} className="col-span-1 bg-red-100 text-red-700 p-3 rounded font-bold border border-red-200">ส่งตัว</button><button onClick={handleSaveTreatment} className="col-span-2 bg-green-600 text-white p-3 rounded font-bold">บันทึกและส่งห้องยา</button></div></div> : <div className="text-center text-gray-400 mt-20">เลือกผู้ป่วย</div>}</div></div>}

                            {activeTab === 'pharmacy' && <div className="flex flex-col lg:flex-row gap-4 h-full"><div className="w-full lg:w-1/3 bg-white border rounded-xl overflow-hidden flex flex-col"><div className="p-3 bg-purple-100 font-bold text-purple-800">รอจ่ายยา</div><div className="flex-1 overflow-auto">{patients.filter(p=>p.status==='pharmacy').map(p=><div key={p.id} onClick={()=>{setSelectedPharmacy(p); setPharmacyRx(p.treatment)}} className="p-3 border-b hover:bg-purple-50 cursor-pointer flex justify-between"><div><span className="font-bold mr-2 text-purple-700">{p.queue}</span>{p.name} ({p.age} ปี)</div></div>)}</div></div><div className="flex-1 bg-white border rounded-xl p-6 overflow-auto">{selectedPharmacy ? <div className="space-y-4"><h3 className="font-bold text-lg border-b pb-2 flex justify-between"><span>{selectedPharmacy.name} ({selectedPharmacy.age} ปี)</span> <span className="text-sm text-slate-500 font-normal">({selectedPharmacy.phone})</span><span className="text-purple-600">{selectedPharmacy.queue}</span></h3><div className="bg-slate-50 p-2 rounded border text-sm"><span className="font-bold">วินิจฉัย:</span> {selectedPharmacy.diagnosis}</div><div className="border rounded"><div className="bg-slate-100 p-2 flex justify-between"><span>รายการยา</span><button onClick={()=>handlePrintPreview(selectedPharmacy)} className="text-blue-600 text-xs flex gap-1 items-center font-bold"><Icons.Tag size={12}/> พิมพ์ฉลาก</button></div><textarea className="w-full p-2 h-40 border-0 resize-none" value={pharmacyRx||selectedPharmacy.treatment} onChange={e=>setPharmacyRx(e.target.value)}/></div><button onClick={()=>handleDispense(selectedPharmacy)} className="w-full bg-purple-600 text-white p-3 rounded font-bold">ยืนยันการจ่ายยา</button></div> : <div className="text-center text-gray-400 mt-20">เลือกรายการ</div>}</div></div>}
                            
                            {activeTab === 'referral' && <div className="flex flex-col lg:flex-row gap-4 h-full"><div className="w-full lg:w-1/3 bg-white border rounded-xl overflow-hidden flex flex-col"><div className="p-3 bg-red-100 font-bold text-red-800 flex gap-2 items-center"><Icons.Ambulance size={16}/> รายการส่งต่อ</div><div className="flex-1 overflow-auto">{patients.filter(p=>p.status==='referred').map(p=><div key={p.id} onClick={()=>handleSelectReferral(p)} className={`p-3 border-b cursor-pointer flex justify-between group relative pr-16 ${selectedReferral?.id===p.id ? 'bg-red-50' : 'hover:bg-slate-50'}`}><div><span className="font-bold mr-2 text-red-700">{p.queue}</span>{p.name} ({p.age} ปี)</div><div className="text-xs text-slate-500">{p.referralData?.hospital}</div><div className="hidden group-hover:flex absolute right-2 top-2 gap-2 bg-white p-1 rounded shadow"><button onClick={(e) => handleEditPatientClick(e, p)} className="text-blue-600 hover:bg-blue-50 p-1 rounded"><Icons.Edit size={14} /></button><button onClick={(e) => handleDeletePatient(e, p)} className="text-red-600 hover:bg-red-50 p-1 rounded"><Icons.Trash2 size={14} /></button></div></div>)}</div></div><div className="flex-1 bg-white border rounded-xl p-6 overflow-auto flex flex-col items-center justify-center">{selectedReferral ? <div className="w-full max-w-2xl bg-white shadow-lg border p-8 space-y-6"><div className="text-center border-b pb-4"><h2 className="font-bold text-2xl">ใบส่งต่อผู้ป่วย</h2><p className="text-slate-500">ศูนย์อพยพอาคารวีสมหมาย</p></div><div className="grid grid-cols-2 gap-4"><div><strong>ชื่อ:</strong> {selectedReferral.name}</div><div><strong>ปลายทาง:</strong> {selectedReferral.referralData?.hospital}</div><div><strong>วินิจฉัย:</strong> {selectedReferral.diagnosis}</div><div><strong>ความเร่งด่วน:</strong> {selectedReferral.referralData?.urgency}</div></div><div className="bg-slate-50 p-4 rounded border"><p className="font-bold text-sm mb-1">สาเหตุการส่งต่อ</p><p>{selectedReferral.referralData?.reason}</p></div><button onClick={()=>window.print()} className="w-full bg-blue-600 text-white p-3 rounded font-bold flex items-center justify-center gap-2"><Icons.Printer/> พิมพ์ใบส่งตัว</button></div> : <div className="text-center text-gray-400">เลือกผู้ป่วยเพื่อดูรายละเอียด</div>}</div></div>}

                            {activeTab === 'history' && <div className="bg-white border rounded-xl overflow-hidden p-6"><div className="flex items-center gap-2 mb-4"><span className="font-bold">เลือกวันที่:</span><input type="date" className="border p-2 rounded" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)}/></div><table className="w-full text-left"><thead className="bg-slate-50 border-b"><tr><th className="p-3">เวลา</th><th className="p-3">ชื่อ</th><th className="p-3">วินิจฉัย</th><th className="p-3">สถานะ</th><th className="p-3">จัดการ</th></tr></thead><tbody>{filteredPatients.filter(p=>['completed','referred'].includes(p.status)).length > 0 ? filteredPatients.filter(p=>['completed','referred'].includes(p.status)).map(p=><tr key={p.id} className="border-b hover:bg-slate-50"><td className="p-3 text-sm">{p.time}</td><td className="p-3">{p.name} <span className="text-gray-500 text-xs">({p.age} ปี)</span></td><td className="p-3 text-sm text-slate-600">{p.diagnosis}</td><td className="p-3">{p.status==='referred' ? <span className="bg-red-100 text-red-800 px-2 rounded text-xs">ส่งต่อ</span> : <span className="bg-green-100 text-green-800 px-2 rounded text-xs">เสร็จสิ้น</span>}</td><td className="p-3 flex gap-2"><button onClick={(e)=>handleEditPatientClick(e,p)} className="bg-blue-100 text-blue-600 p-1 rounded hover:bg-blue-200"><Icons.Edit size={16}/></button><button onClick={(e)=>handleDeletePatient(e,p)} className="bg-red-100 text-red-600 p-1 rounded hover:bg-red-200"><Icons.Trash2 size={16}/></button></td></tr>) : <tr><td colSpan="5" className="p-8 text-center text-gray-400">ไม่พบประวัติการรักษาในวันที่เลือก</td></tr>}</tbody></table></div>}

                            {activeTab === 'export' && (
                                <div className="max-w-4xl mx-auto space-y-6">
                                    <div className="bg-white p-6 rounded-xl border shadow-sm">
                                        <h2 className="font-bold text-xl mb-4 text-blue-700 flex items-center gap-2"><Icons.Download/> ส่งออกข้อมูลผู้ป่วย (Excel/CSV)</h2>
                                        
                                        <div className="flex gap-4 items-end bg-slate-50 p-4 rounded-lg border mb-6">
                                            <div>
                                                <label className="block text-sm font-bold mb-1">ตั้งแต่วันที่</label>
                                                <input type="date" className="border p-2 rounded w-40" value={exportStart} onChange={e=>setExportStart(e.target.value)} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold mb-1">ถึงวันที่</label>
                                                <input type="date" className="border p-2 rounded w-40" value={exportEnd} onChange={e=>setExportEnd(e.target.value)} />
                                            </div>
                                            <button onClick={exportToExcel} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold shadow flex gap-2 items-center h-10">
                                                <Icons.Save size={18}/> ดาวน์โหลดไฟล์
                                            </button>
                                        </div>

                                        <h3 className="font-bold text-sm text-gray-500 mb-2">ตัวอย่างข้อมูลที่จะส่งออก (Preview)</h3>
                                        <div className="overflow-x-auto border rounded">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-gray-100">
                                                    <tr>
                                                        <th className="p-2 border-b">วันที่</th>
                                                        <th className="p-2 border-b">คิว</th>
                                                        <th className="p-2 border-b">ชื่อ-สกุล</th>
                                                        <th className="p-2 border-b">อาการ</th>
                                                        <th className="p-2 border-b">วินิจฉัย</th>
                                                        <th className="p-2 border-b">สถานะ</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {patients.filter(p => {
                                                        const pDate = p.date || p.time; 
                                                        return (!exportStart || p.date >= exportStart) && (!exportEnd || p.date <= exportEnd);
                                                    }).slice(0, 5).map((p, i) => (
                                                        <tr key={i} className="border-b">
                                                            <td className="p-2">{p.date}</td>
                                                            <td className="p-2">{p.queue}</td>
                                                            <td className="p-2">{p.name} ({p.age})</td>
                                                            <td className="p-2 truncate max-w-xs">{p.screeningData?.symptom}</td>
                                                            <td className="p-2 truncate max-w-xs">{p.diagnosis}</td>
                                                            <td className="p-2">{p.status}</td>
                                                        </tr>
                                                    ))}
                                                    {patients.filter(p => (!exportStart || p.date >= exportStart) && (!exportEnd || p.date <= exportEnd)).length === 0 && (
                                                        <tr><td colSpan="6" className="p-4 text-center text-gray-400">ไม่พบข้อมูลในช่วงเวลาที่เลือก</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div className="text-right text-xs text-gray-400 mt-2">
                                            * แสดงตัวอย่างสูงสุด 5 รายการ
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                    </ErrorBoundary>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
